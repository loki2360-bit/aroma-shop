<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞—Ä—Å–µ—Ä –ó–∞–∫–∞–∑–æ–≤ + –î–∞—à–±–æ—Ä–¥</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1em;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .tab {
            padding: 12px 25px;
            border: none;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            background: #e8e9ff;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Upload Section */
        .upload-section {
            background: #f8f9fa;
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f1ff;
        }

        .upload-section.dragover {
            border-color: #764ba2;
            background: #e8e9ff;
            transform: scale(1.02);
        }

        #fileInput {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .file-info {
            margin-top: 15px;
            color: #666;
            font-size: 0.9em;
        }

        .file-list {
            margin-top: 20px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            padding: 15px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .file-item:last-child {
            margin-bottom: 0;
        }

        .file-item .file-name {
            color: #333;
            flex: 1;
        }

        .file-item .file-date {
            color: #667eea;
            font-weight: bold;
            margin: 0 15px;
        }

        .file-item .file-remove {
            color: #dc3545;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 3px;
            transition: background 0.3s;
        }

        .file-item .file-remove:hover {
            background: #dc3545;
            color: white;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-copy {
            background: #28a745;
            color: white;
        }

        .btn-copy:hover {
            background: #218838;
        }

        .btn-clear {
            background: #dc3545;
            color: white;
        }

        .btn-clear:hover {
            background: #c82333;
        }

        .btn-export {
            background: #007bff;
            color: white;
        }

        .btn-export:hover {
            background: #0056b3;
        }

        .btn-save {
            background: #17a2b8;
            color: white;
        }

        .btn-save:hover {
            background: #138496;
        }

        /* Summary */
        .summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            color: white;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            color: rgba(255,255,255,0.8);
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .summary-value {
            color: white;
            font-size: 1.4em;
            font-weight: bold;
        }

        /* Date Filter */
        .date-filter {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .date-filter label {
            color: #333;
            font-weight: 500;
        }

        .date-filter input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .date-filter input:focus {
            outline: none;
            border-color: #667eea;
        }

        .date-filter select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
            background: white;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #ddd;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: left;
            position: sticky;
            top: 0;
            white-space: nowrap;
            z-index: 10;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        tr:nth-child(even) {
            background: #fafafa;
        }

        .date-column {
            background: #fff3cd;
            font-weight: bold;
        }

        /* Status */
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .hidden {
            display: none;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #e8f4fd;
            border-radius: 8px;
        }

        .stats-bar span {
            color: #333;
            font-size: 0.9em;
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .chart-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Calendar */
        .calendar-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-header h3 {
            color: #333;
            font-size: 1.2em;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav button {
            padding: 8px 15px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        .calendar-nav button:hover {
            background: #764ba2;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            padding: 10px;
            font-weight: bold;
            color: #666;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 80px;
        }

        .calendar-day:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }

        .calendar-day.today {
            border: 2px solid #667eea;
        }

        .calendar-day.has-orders {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .calendar-day.has-orders:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .calendar-day .day-number {
            font-size: 1.2em;
            font-weight: bold;
        }

        .calendar-day .day-sum {
            font-size: 0.75em;
            margin-top: 5px;
        }

        .calendar-day .day-count {
            font-size: 0.7em;
            opacity: 0.8;
        }

        .calendar-legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        /* Day Detail Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body table {
            width: 100%;
            font-size: 0.9em;
        }

        .modal-body th {
            background: #667eea;
            padding: 10px;
        }

        .modal-body td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        /* Storage Info */
        .storage-info {
            background: #e8f4fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .storage-info span {
            color: #333;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.5em;
            }

            .controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .date-filter {
                flex-direction: column;
                align-items: stretch;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã –ü–∞—Ä—Å–µ—Ä –ó–∞–∫–∞–∑–æ–≤ + –î–∞—à–±–æ—Ä–¥</h1>
        <p class="subtitle">–ó–∞–≥—Ä—É–∂–∞–π—Ç–µ —Ñ–∞–π–ª—ã, —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</p>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('parser')">
                üìÅ –ü–∞—Ä—Å–µ—Ä
            </button>
            <button class="tab" onclick="switchTab('dashboard')">
                üìä –î–∞—à–±–æ—Ä–¥
            </button>
        </div>

        <!-- Parser Tab -->
        <div id="parser-tab" class="tab-content active">
            <div class="upload-section" id="dropZone">
                <input type="file" id="fileInput" accept=".txt" multiple>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
                </button>
                <p class="file-info">–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</p>
                <p class="file-info" style="font-size: 0.8em; color: #999;">
                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ .txt –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
                </p>
                
                <div class="file-list hidden" id="fileList"></div>
            </div>

            <div id="status" class="status"></div>

            <div id="results" class="hidden">
                <div class="summary" id="summary"></div>
                
                <div class="date-filter">
                    <label>üìÖ –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ:</label>
                    <input type="date" id="dateFrom" onchange="filterByDate()">
                    <span>‚Äî</span>
                    <input type="date" id="dateTo" onchange="filterByDate()">
                    <select id="dateSelect" onchange="filterByDateSelect()">
                        <option value="">–í—Å–µ –¥–∞—Ç—ã</option>
                    </select>
                    <button class="btn btn-clear" onclick="resetDateFilter()" style="padding: 8px 15px; font-size: 0.9em;">
                        üîÑ –°–±—Ä–æ—Å
                    </button>
                </div>

                <div class="stats-bar">
                    <span id="visibleCount">–ü–æ–∫–∞–∑–∞–Ω–æ: 0 –∏–∑ 0</span>
                    <span id="filesCount">–§–∞–π–ª–æ–≤: 0</span>
                </div>
                
                <div class="controls">
                    <button class="btn btn-copy" onclick="copyToClipboard()">
                        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä
                    </button>
                    <button class="btn btn-export" onclick="exportToCSV()">
                        üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                    </button>
                    <button class="btn btn-save" onclick="saveToStorage()">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button class="btn btn-clear" onclick="clearAll()">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                    </button>
                </div>

                <div class="table-container">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>‚Ññ</th>
                                <th>–ö–æ–¥ –∑–∞–∫–∞–∑–∞</th>
                                <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                <th>–¢–∏–ø —Ä–∞–±–æ—Ç—ã</th>
                                <th>–î–ª–∏–Ω–∞ (–º)</th>
                                <th>–®–∏—Ä–∏–Ω–∞ (–º)</th>
                                <th>–ö–æ–ª-–≤–æ</th>
                                <th>–û–±—ä–µ–º</th>
                                <th>–°—É–º–º–∞ (‚ÇΩ)</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div class="storage-info">
                <span id="storageStatus">üíæ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</span>
                <button class="btn btn-save" onclick="saveToStorage()">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ–π—á–∞—Å
                </button>
                <button class="btn btn-clear" onclick="clearStorage()">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                </button>
            </div>

            <div class="summary" id="dashboardSummary"></div>

            <!-- Calendar -->
            <div class="calendar-section">
                <div class="calendar-header">
                    <h3>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π</h3>
                    <div class="calendar-nav">
                        <button onclick="changeMonth(-1)">‚óÄ –ù–∞–∑–∞–¥</button>
                        <span id="calendarMonth" style="font-weight: bold; padding: 0 20px;"></span>
                        <button onclick="changeMonth(1)">–í–ø–µ—Ä—ë–¥ ‚ñ∂</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div class="calendar-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                        <span>–ï—Å—Ç—å –∑–∞–∫–∞–∑—ã</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fff3cd; border: 2px solid #667eea;"></div>
                        <span>–°–µ–≥–æ–¥–Ω—è</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f8f9fa;"></div>
                        <span>–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</span>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="dashboard-grid">
                <div class="chart-card">
                    <h3>üìà –°—É–º–º–∞ –ø–æ –¥–Ω—è–º</h3>
                    <div class="chart-container">
                        <canvas id="sumChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –¥–Ω—è–º</h3>
                    <div class="chart-container">
                        <canvas id="ordersChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>üè∑Ô∏è –¢–æ–ø –∫–æ–¥–æ–≤ –∑–∞–∫–∞–∑–æ–≤</h3>
                    <div class="chart-container">
                        <canvas id="codesChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>‚öôÔ∏è –¢–∏–ø—ã —Ä–∞–±–æ—Ç</h3>
                    <div class="chart-container">
                        <canvas id="workTypesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Detail Modal -->
    <div class="modal" id="dayModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalDate"></h3>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="summary" id="modalSummary" style="margin-bottom: 15px;"></div>
                <div class="table-container">
                    <table id="modalTable">
                        <thead>
                            <tr>
                                <th>‚Ññ</th>
                                <th>–ö–æ–¥</th>
                                <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                <th>–°—É–º–º–∞</th>
                            </tr>
                        </thead>
                        <tbody id="modalTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global data
        let allData = [];
        let filteredData = [];
        let fileData = [];
        let uniqueDates = new Set();
        let currentMonth = new Date();
        let sumChart = null;
        let ordersChart = null;
        let codesChart = null;
        let workTypesChart = null;

        // Load data from localStorage on startup
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
        });

        // Tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (tabName === 'dashboard') {
                updateDashboard();
            }
        }

        // Drag and Drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });

        dropZone.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFileSelect, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length) {
                processFiles(Array.from(files));
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length) {
                processFiles(Array.from(files));
            }
        }

        function processFiles(files) {
            let processed = 0;
            let errors = 0;

            files.forEach(file => {
                if (!file.name.endsWith('.txt')) {
                    errors++;
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const date = extractDateFromFile(file.name, e.target.result);
                    const orders = parseData(e.target.result, date);
                    
                    fileData.push({
                        name: file.name,
                        date: date,
                        orders: orders
                    });

                    allData = allData.concat(orders.map(o => ({...o, fileDate: date})));
                    uniqueDates.add(date);

                    processed++;
                    updateFileList();
                    
                    if (processed + errors === files.length) {
                        filterByDate();
                        displayResults();
                        updateDateSelect();
                        showStatus(`–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${processed}, –ó–∞–ø–∏—Å–µ–π: ${allData.length}`, 'success');
                    }
                };
                reader.onerror = function() {
                    errors++;
                    if (processed + errors === files.length) {
                        showStatus(`–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${processed}, –û—à–∏–±–æ–∫: ${errors}`, 'error');
                    }
                };
                reader.readAsText(file, 'utf-8');
            });
        }

        function extractDateFromFile(filename, content) {
            const contentMatch = content.match(/–ó–ê–ö–ê–ó–´ –ó–ê\s*(\d{2}\.\d{2}\.\d{4})/);
            if (contentMatch) {
                return contentMatch[1];
            }

            const filenameMatch = filename.match(/(\d{2}\.\d{2}\.\d{4})/);
            if (filenameMatch) {
                return filenameMatch[1];
            }

            const exportMatch = content.match(/–≠–∫—Å–ø–æ—Ä—Ç:\s*(\d{2}\.\d{2}\.\d{4})/);
            if (exportMatch) {
                return exportMatch[1];
            }

            const today = new Date();
            return today.toLocaleDateString('ru-RU');
        }

        function parseData(text, date) {
            const orders = [];
            const lines = text.split('\n');
            let currentOrder = {};
            let inOrder = false;

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();

                if (line.match(/^‚Ññ\d+\./)) {
                    if (inOrder && currentOrder.number) {
                        orders.push({...currentOrder});
                    }
                    currentOrder = {date: date};
                    inOrder = true;
                    
                    const numberMatch = line.match(/^‚Ññ(\d+)\./);
                    if (numberMatch) {
                        currentOrder.number = numberMatch[1];
                    }
                    
                    const codeMatch = line.match(/^‚Ññ\d+\.\s*(.+?)\s+(?:—É–ø–∞–∫–æ–≤–∫–∞|–ø–∞–Ω–µ–ª—å|—Ñ–∏–ª–µ–Ω–∫–∞|–∫–æ—Ä–æ–±|–Ω–∞–ª–∏—á–Ω–∏–∫–∏|–∏–º–ø–∞—Å|—Ñ—Ä–∞–º—É–≥–∞|—Ç–æ—Ä—Ü–æ–≤–∫–∞|–±—Ä–∞—à–∏—Ä–æ–≤–∞|–ø—Ä–∏–Ω–æ—Å|–¥–æ–ø)/i);
                    if (codeMatch) {
                        currentOrder.code = codeMatch[1].trim();
                    } else {
                        const fallbackMatch = line.match(/^‚Ññ\d+\.\s*(.+)/);
                        if (fallbackMatch) {
                            currentOrder.code = fallbackMatch[1].trim();
                        }
                    }
                    continue;
                }

                if (!inOrder) continue;

                if (line.includes('–ó–ê–ö–ê–ó–´') || line.includes('–ò–¢–û–ì–û') || line.includes('–û–±—â–∞—è') || line.includes('–≠–∫—Å–ø–æ—Ä—Ç') || line.includes('===')) {
                    continue;
                }

                if (!currentOrder.name && line && !line.includes(':') && !line.includes('---')) {
                    currentOrder.name = line;
                    continue;
                }

                const typeMatch = line.match(/\(([^)]+)\)/);
                if (typeMatch && !currentOrder.workType) {
                    currentOrder.workType = typeMatch[1];
                }

                const lengthMatch = line.match(/–î–ª–∏–Ω–∞:\s*([\d.,]+)\s*–º/);
                if (lengthMatch) {
                    currentOrder.length = lengthMatch[1].replace(',', '.');
                }

                const widthMatch = line.match(/–®–∏—Ä–∏–Ω–∞:\s*([\d.,]+)\s*–º/);
                if (widthMatch) {
                    currentOrder.width = widthMatch[1].replace(',', '.');
                }

                const qtyMatch = line.match(/–ö–æ–ª-–≤–æ:\s*(\d+)/);
                if (qtyMatch) {
                    currentOrder.quantity = qtyMatch[1];
                }

                const volumeMatch = line.match(/–û–±—ä–µ–º:\s*([\d.,]+)\s*(–º¬≤|–ø–æ–≥\.?\s*–º|—á–∞—Å—ã?)/);
                if (volumeMatch) {
                    currentOrder.volume = volumeMatch[1].replace(',', '.') + ' ' + volumeMatch[2];
                }

                const sumMatch = line.match(/–°—É–º–º–∞:\s*([\d.,]+)\s*‚ÇΩ/);
                if (sumMatch) {
                    currentOrder.sum = sumMatch[1].replace(',', '.');
                }

                if (line === '---') {
                    if (currentOrder.number) {
                        orders.push({...currentOrder});
                    }
                    currentOrder = {date: date};
                    inOrder = false;
                }
            }

            if (inOrder && currentOrder.number) {
                orders.push({...currentOrder});
            }

            return orders;
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            if (fileData.length === 0) {
                fileList.classList.add('hidden');
                return;
            }

            fileList.classList.remove('hidden');
            fileList.innerHTML = fileData.map((file, index) => `
                <div class="file-item">
                    <span class="file-name">üìÑ ${file.name}</span>
                    <span class="file-date">üìÖ ${file.date}</span>
                    <span class="file-remove" onclick="removeFile(${index})">‚úï</span>
                </div>
            `).join('');
        }

        function removeFile(index) {
            const removedFile = fileData[index];
            fileData.splice(index, 1);
            
            allData = allData.filter(o => !(o.date === removedFile.date && o.fileDate === removedFile.date));
            
            uniqueDates = new Set(fileData.map(f => f.date));
            
            updateFileList();
            updateDateSelect();
            filterByDate();
            displayResults();
            
            if (fileData.length === 0) {
                document.getElementById('results').classList.add('hidden');
            }
            
            showStatus(`–§–∞–π–ª —É–¥–∞–ª—ë–Ω. –û—Å—Ç–∞–ª–æ—Å—å —Ñ–∞–π–ª–æ–≤: ${fileData.length}`, 'success');
        }

        function updateDateSelect() {
            const dateSelect = document.getElementById('dateSelect');
            const sortedDates = Array.from(uniqueDates).sort((a, b) => {
                const [d1, m1, y1] = a.split('.').reverse();
                const [d2, m2, y2] = b.split('.').reverse();
                return new Date(y1, m1-1, d1) - new Date(y2, m2-1, d2);
            });

            dateSelect.innerHTML = '<option value="">–í—Å–µ –¥–∞—Ç—ã</option>' + 
                sortedDates.map(date => `<option value="${date}">${date}</option>`).join('');
        }

        function filterByDate() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            filteredData = allData.filter(item => {
                if (!dateFrom && !dateTo) return true;
                
                const itemDate = item.date.split('.').reverse().join('-');
                
                if (dateFrom && itemDate < dateFrom) return false;
                if (dateTo && itemDate > dateTo) return false;
                
                return true;
            });

            displayTable();
        }

        function filterByDateSelect() {
            const selectedDate = document.getElementById('dateSelect').value;
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';

            if (selectedDate) {
                filteredData = allData.filter(item => item.date === selectedDate);
            } else {
                filteredData = allData;
            }

            displayTable();
        }

        function resetDateFilter() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('dateSelect').value = '';
            filteredData = allData;
            displayTable();
        }

        function displayResults() {
            displayTable();
            updateSummary();
            document.getElementById('results').classList.remove('hidden');
        }

        function displayTable() {
            const tableBody = document.getElementById('tableBody');
            const visibleCount = document.getElementById('visibleCount');
            const filesCount = document.getElementById('filesCount');

            tableBody.innerHTML = filteredData.map((order, index) => `
                <tr>
                    <td class="date-column">${order.date || ''}</td>
                    <td>${order.number || ''}</td>
                    <td>${order.code || ''}</td>
                    <td>${order.name || ''}</td>
                    <td>${order.workType || ''}</td>
                    <td>${order.length || ''}</td>
                    <td>${order.width || ''}</td>
                    <td>${order.quantity || ''}</td>
                    <td>${order.volume || ''}</td>
                    <td>${order.sum || ''}</td>
                </tr>
            `).join('');

            visibleCount.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ: ${filteredData.length} –∏–∑ ${allData.length}`;
            filesCount.textContent = `–§–∞–π–ª–æ–≤: ${fileData.length}`;
        }

        function updateSummary() {
            const summary = document.getElementById('summary');
            
            const totalSum = filteredData.reduce((sum, item) => sum + parseFloat(item.sum || 0), 0);
            const totalArea = filteredData.filter(i => i.volume && i.volume.includes('–º¬≤')).reduce((sum, item) => {
                const vol = parseFloat(item.volume) || 0;
                return sum + vol;
            }, 0);
            const totalLength = filteredData.filter(i => i.volume && i.volume.includes('–ø–æ–≥')).reduce((sum, item) => {
                const vol = parseFloat(item.volume) || 0;
                return sum + vol;
            }, 0);
            const totalTime = filteredData.filter(i => i.volume && i.volume.includes('—á–∞—Å')).reduce((sum, item) => {
                const vol = parseFloat(item.volume) || 0;
                return sum + vol;
            }, 0);

            summary.innerHTML = `
                <div class="summary-item">
                    <div class="summary-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                    <div class="summary-value">${filteredData.length}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–û–±—â–∞—è —Å—É–º–º–∞</div>
                    <div class="summary-value">${totalSum.toFixed(2)} ‚ÇΩ</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å</div>
                    <div class="summary-value">${totalArea.toFixed(2)} –º¬≤</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–û–±—â–∞—è –¥–ª–∏–Ω–∞</div>
                    <div class="summary-value">${totalLength.toFixed(2)} –ø–æ–≥. –º</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–û–±—â–µ–µ –≤—Ä–µ–º—è</div>
                    <div class="summary-value">${totalTime.toFixed(2)} —á</div>
                </div>
            `;
        }

        // Storage functions
        function saveToStorage() {
            const data = {
                allData: allData,
                fileData: fileData,
                uniqueDates: Array.from(uniqueDates),
                savedAt: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('orderParserData', JSON.stringify(data));
                showStatus('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –æ–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è.', 'success');
                document.getElementById('storageStatus').textContent = 'üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: ' + new Date(data.savedAt).toLocaleString('ru-RU');
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: –≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç localStorage', 'error');
            }
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('orderParserData');
                if (saved) {
                    const data = JSON.parse(saved);
                    allData = data.allData || [];
                    fileData = data.fileData || [];
                    uniqueDates = new Set(data.uniqueDates || []);
                    
                    if (allData.length > 0) {
                        filterByDate();
                        displayResults();
                        updateDateSelect();
                        updateFileList();
                        document.getElementById('storageStatus').textContent = 'üíæ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + new Date(data.savedAt).toLocaleString('ru-RU');
                        showStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allData.length} –∑–∞–∫–∞–∑–æ–≤ –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è`, 'success');
                    }
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            }
        }

        function clearStorage() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) {
                localStorage.removeItem('orderParserData');
                document.getElementById('storageStatus').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ';
                showStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
            }
        }

        // Dashboard functions
        function updateDashboard() {
            updateDashboardSummary();
            renderCalendar();
            renderCharts();
        }

        function updateDashboardSummary() {
            const summary = document.getElementById('dashboardSummary');
            
            const totalSum = allData.reduce((sum, item) => sum + parseFloat(item.sum || 0), 0);
            const totalArea = allData.filter(i => i.volume && i.volume.includes('–º¬≤')).reduce((sum, item) => {
                const vol = parseFloat(item.volume) || 0;
                return sum + vol;
            }, 0);
            const totalLength = allData.filter(i => i.volume && i.volume.includes('–ø–æ–≥')).reduce((sum, item) => {
                const vol = parseFloat(item.volume) || 0;
                return sum + vol;
            }, 0);
            const totalTime = allData.filter(i => i.volume && i.volume.includes('—á–∞—Å')).reduce((sum, item) => {
                const vol = parseFloat(item.volume) || 0;
                return sum + vol;
            }, 0);
            
            const uniqueDays = new Set(allData.map(d => d.date)).size;
            const avgPerDay = uniqueDays > 0 ? totalSum / uniqueDays : 0;

            summary.innerHTML = `
                <div class="summary-item">
                    <div class="summary-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                    <div class="summary-value">${allData.length}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–û–±—â–∞—è —Å—É–º–º–∞</div>
                    <div class="summary-value">${totalSum.toFixed(2)} ‚ÇΩ</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π</div>
                    <div class="summary-value">${uniqueDays}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å</div>
                    <div class="summary-value">${avgPerDay.toFixed(2)} ‚ÇΩ</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å</div>
                    <div class="summary-value">${totalArea.toFixed(2)} –º¬≤</div>
                </div>
            `;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthLabel = document.getElementById('calendarMonth');
            
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            monthLabel.textContent = new Date(year, month).toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            
            // Group data by date
            const dataByDate = {};
            allData.forEach(item => {
                if (!dataByDate[item.date]) {
                    dataByDate[item.date] = { sum: 0, count: 0, orders: [] };
                }
                dataByDate[item.date].sum += parseFloat(item.sum || 0);
                dataByDate[item.date].count++;
                dataByDate[item.date].orders.push(item);
            });
            
            // Calendar headers
            const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            let html = days.map(d => `<div class="calendar-day-header">${d}</div>`).join('');
            
            // First day of month
            const firstDay = new Date(year, month, 1);
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6;
            
            // Empty cells
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            // Days
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${String(day).padStart(2, '0')}.${String(month + 1).padStart(2, '0')}.${year}`;
                const dayData = dataByDate[dateStr];
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                
                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (dayData) classes += ' has-orders';
                
                html += `<div class="${classes}" onclick="showDayDetail('${dateStr}')">
                    <span class="day-number">${day}</span>
                    ${dayData ? `<span class="day-sum">${dayData.sum.toFixed(0)} ‚ÇΩ</span>` : ''}
                    ${dayData ? `<span class="day-count">${dayData.count} –∑–∞–∫.</span>` : ''}
                </div>`;
            }
            
            grid.innerHTML = html;
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        function showDayDetail(dateStr) {
            const dayData = allData.filter(item => item.date === dateStr);
            if (dayData.length === 0) return;
            
            const modal = document.getElementById('dayModal');
            const modalDate = document.getElementById('modalDate');
            const modalSummary = document.getElementById('modalSummary');
            const modalTableBody = document.getElementById('modalTableBody');
            
            modalDate.textContent = `üìÖ ${dateStr}`;
            
            const totalSum = dayData.reduce((sum, item) => sum + parseFloat(item.sum || 0), 0);
            modalSummary.innerHTML = `
                <div class="summary-item">
                    <div class="summary-label">–ó–∞–∫–∞–∑–æ–≤</div>
                    <div class="summary-value">${dayData.length}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–°—É–º–º–∞</div>
                    <div class="summary-value">${totalSum.toFixed(2)} ‚ÇΩ</div>
                </div>
            `;
            
            modalTableBody.innerHTML = dayData.map(order => `
                <tr>
                    <td>${order.number || ''}</td>
                    <td>${order.code || ''}</td>
                    <td>${order.name || ''}</td>
                    <td>${order.sum || ''} ‚ÇΩ</td>
                </tr>
            `).join('');
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('dayModal').classList.remove('active');
        }

        function renderCharts() {
            // Group data by date
            const dataByDate = {};
            allData.forEach(item => {
                if (!dataByDate[item.date]) {
                    dataByDate[item.date] = { sum: 0, count: 0 };
                }
                dataByDate[item.date].sum += parseFloat(item.sum || 0);
                dataByDate[item.date].count++;
            });
            
            const sortedDates = Object.keys(dataByDate).sort((a, b) => {
                const [d1, m1, y1] = a.split('.').reverse();
                const [d2, m2, y2] = b.split('.').reverse();
                return new Date(y1, m1-1, d1) - new Date(y2, m2-1, d2);
            });
            
            // Sum Chart
            const sumCtx = document.getElementById('sumChart').getContext('2d');
            if (sumChart) sumChart.destroy();
            sumChart = new Chart(sumCtx, {
                type: 'bar',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: '–°—É–º–º–∞ (‚ÇΩ)',
                        data: sortedDates.map(d => dataByDate[d].sum),
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            // Orders Chart
            const ordersCtx = document.getElementById('ordersChart').getContext('2d');
            if (ordersChart) ordersChart.destroy();
            ordersChart = new Chart(ordersCtx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤',
                        data: sortedDates.map(d => dataByDate[d].count),
                        borderColor: 'rgba(118, 75, 162, 1)',
                        backgroundColor: 'rgba(118, 75, 162, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            // Top Codes Chart
            const codeCount = {};
            allData.forEach(item => {
                const code = (item.code || '–ë–µ–∑ –∫–æ–¥–∞').split('.')[0].trim();
                codeCount[code] = (codeCount[code] || 0) + 1;
            });
            
            const topCodes = Object.entries(codeCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const codesCtx = document.getElementById('codesChart').getContext('2d');
            if (codesChart) codesChart.destroy();
            codesChart = new Chart(codesCtx, {
                type: 'doughnut',
                data: {
                    labels: topCodes.map(c => c[0]),
                    datasets: [{
                        data: topCodes.map(c => c[1]),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                            '#fa709a', '#fee140'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            // Work Types Chart
            const workTypeCount = {};
            allData.forEach(item => {
                const type = item.workType || '–ë–µ–∑ —Ç–∏–ø–∞';
                workTypeCount[type] = (workTypeCount[type] || 0) + 1;
            });
            
            const workTypesCtx = document.getElementById('workTypesChart').getContext('2d');
            if (workTypesChart) workTypesChart.destroy();
            workTypesChart = new Chart(workTypesCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(workTypeCount),
                    datasets: [{
                        data: Object.values(workTypeCount),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function copyToClipboard() {
            if (filteredData.length === 0) {
                showStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
                return;
            }

            let clipboardData = '–î–∞—Ç–∞\t‚Ññ\t–ö–æ–¥ –∑–∞–∫–∞–∑–∞\t–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ\t–¢–∏–ø —Ä–∞–±–æ—Ç—ã\t–î–ª–∏–Ω–∞ (–º)\t–®–∏—Ä–∏–Ω–∞ (–º)\t–ö–æ–ª-–≤–æ\t–û–±—ä–µ–º\t–°—É–º–º–∞ (‚ÇΩ)\n';
            
            filteredData.forEach(order => {
                clipboardData += `${order.date || ''}\t${order.number || ''}\t${order.code || ''}\t${order.name || ''}\t${order.workType || ''}\t${order.length || ''}\t${order.width || ''}\t${order.quantity || ''}\t${order.volume || ''}\t${order.sum || ''}\n`;
            });

            const totalSum = filteredData.reduce((sum, item) => sum + parseFloat(item.sum || 0), 0);
            clipboardData += `\n–ò–¢–û–ì–û:\t\t\t\t\t\t\t\t\t${totalSum.toFixed(2)} ‚ÇΩ`;

            navigator.clipboard.writeText(clipboardData).then(() => {
                showStatus('–î–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞! –ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å –≤ Google Sheets', 'success');
            }).catch(err => {
                const textarea = document.createElement('textarea');
                textarea.value = clipboardData;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showStatus('–î–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
            });
        }

        function exportToCSV() {
            if (filteredData.length === 0) {
                showStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
                return;
            }

            let csvContent = '\uFEFF';
            csvContent += '–î–∞—Ç–∞;‚Ññ;–ö–æ–¥ –∑–∞–∫–∞–∑–∞;–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ;–¢–∏–ø —Ä–∞–±–æ—Ç—ã;–î–ª–∏–Ω–∞ (–º);–®–∏—Ä–∏–Ω–∞ (–º);–ö–æ–ª-–≤–æ;–û–±—ä–µ–º;–°—É–º–º–∞ (‚ÇΩ)\n';
            
            filteredData.forEach(order => {
                csvContent += `${order.date || ''};${order.number || ''};${order.code || ''};${(order.name || '').replace(/;/g, ',')};${order.workType || ''};${order.length || ''};${order.width || ''};${order.quantity || ''};${order.volume || ''};${order.sum || ''}\n`;
            });

            const totalSum = filteredData.reduce((sum, item) => sum + parseFloat(item.sum || 0), 0);
            csvContent += `\n–ò–¢–û–ì–û;;;;;;;;;${totalSum.toFixed(2)} ‚ÇΩ`;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `–∑–∞–∫–∞–∑—ã_—ç–∫—Å–ø–æ—Ä—Ç_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function clearAll() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) {
                allData = [];
                filteredData = [];
                fileData = [];
                uniqueDates = new Set();
                
                document.getElementById('tableBody').innerHTML = '';
                document.getElementById('summary').innerHTML = '';
                document.getElementById('fileList').innerHTML = '';
                document.getElementById('fileList').classList.add('hidden');
                document.getElementById('results').classList.add('hidden');
                document.getElementById('fileInput').value = '';
                document.getElementById('dateFrom').value = '';
                document.getElementById('dateTo').value = '';
                document.getElementById('dateSelect').value = '';
                document.getElementById('status').className = 'status';
                document.getElementById('status').style.display = 'none';
                
                showStatus('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', 'success');
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        // Close modal on outside click
        document.getElementById('dayModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>
