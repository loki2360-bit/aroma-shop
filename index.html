<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –†–∞—Å–∫—Ä–æ–π</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --border: #cbd5e1;
            --text: #0f172a;
            --danger: #ef4444;
            --highlight: #fbbf24;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 20px;
        }

        @media (max-width: 1000px) {
            .container { grid-template-columns: 1fr; }
        }

        .panel {
            background: var(--surface);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h2 { margin-top: 0; color: #334155; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #475569; }
        
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        .row { display: flex; gap: 10px; }
        .row > * { flex: 1; }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.2s;
        }
        button:hover { background-color: #1d4ed8; transform: translateY(-1px); }
        
        button.secondary { background-color: #64748b; margin-top: 10px; }
        button.danger { background-color: #fee2e2; color: var(--danger); width: auto; padding: 4px 8px; font-size: 0.8rem; }

        /* Parts List */
        #parts-list {
            margin-top: 20px;
            border: 1px solid var(--border);
            border-radius: 6px;
            max-height: 350px;
            overflow-y: auto;
        }
        .part-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #f1f5f9;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }
        .part-item:last-child { border-bottom: none; }
        .part-item:hover { background: #f0f9ff; }
        .part-item.active { 
            background: #fef3c7; 
            border-left: 4px solid var(--highlight);
        }
        .part-info { font-weight: 500; }
        .part-qty { color: #64748b; font-size: 0.9rem; }
        .part-number { 
            background: var(--primary); 
            color: white; 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-weight: bold;
            margin-right: 8px;
        }

        /* Canvas Area */
        .canvas-wrapper {
            overflow: auto;
            border: 2px solid #e2e8f0;
            background: #94a3b8;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            padding: 20px;
            min-height: 600px;
        }

        canvas {
            background: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .stat-val { font-size: 1.4rem; font-weight: 800; color: var(--primary); display: block; }
        .stat-label { font-size: 0.85rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }

        .alert-box {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
            font-size: 0.9rem;
        }

        .hover-info {
            margin-top: 10px;
            padding: 10px;
            background: #fef3c7;
            border-radius: 6px;
            font-weight: 600;
            display: none;
        }
    </style>
</head>
<body>

    <h1>üìê –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –†–∞—Å–∫—Ä–æ—è </h1>

    <div class="container">
        <!-- Controls -->
        <div class="panel">
            <h2>1. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–∏—Å—Ç–∞</h2>
            <div class="row">
                <div class="form-group">
                    <label>–®–∏—Ä–∏–Ω–∞ (–º–º)</label>
                    <input type="number" id="sheetW" value="2080">
                </div>
                <div class="form-group">
                    <label>–í—ã—Å–æ—Ç–∞ (–º–º)</label>
                    <input type="number" id="sheetH" value="2070">
                </div>
            </div>
            <div class="form-group">
                <label>–¶–µ–Ω–∞ –ª–∏—Å—Ç–∞ (‚ÇΩ)</label>
                <input type="number" id="sheetPrice" value="6000">
            </div>
            <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 15px;">
                * –û—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—è: 10–º–º, –ü—Ä–æ–ø–∏–ª: 3–º–º
            </div>

            <h2>2. –î–µ—Ç–∞–ª–∏</h2>
            <div id="error-msg" class="alert-box"></div>

            <div class="row">
                <div class="form-group">
                    <label>–®–∏—Ä–∏–Ω–∞</label>
                    <input type="number" id="partW" placeholder="–º–º">
                </div>
                <div class="form-group">
                    <label>–í—ã—Å–æ—Ç–∞</label>
                    <input type="number" id="partH" placeholder="–º–º">
                </div>
            </div>
            <div class="form-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                <input type="number" id="partQty" value="1">
            </div>
            <button onclick="addPart()">–î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å</button>

            <div id="parts-list">
                <!-- List -->
            </div>
            <div id="hover-info" class="hover-info">
                –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ –¥–µ—Ç–∞–ª—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            </div>

            <button onclick="calculateLayout()" style="margin-top: 20px; background-color: #059669;">–†–ê–°–°–ß–ò–¢–ê–¢–¨ –†–ê–°–ö–†–û–ô</button>
            <button class="secondary" onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        </div>

        <!-- Visualization -->
        <div class="panel">
            <h2>–ö–∞—Ä—Ç–∞ —Ä–∞—Å–∫—Ä–æ—è</h2>
            <div class="canvas-wrapper">
                <canvas id="layoutCanvas"></canvas>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-val" id="placedCount">0</span>
                    <span class="stat-label">–†–∞–∑–º–µ—â–µ–Ω–æ</span>
                </div>
                <div class="stat-card">
                    <span class="stat-val" id="usedPercent">0%</span>
                    <span class="stat-label">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</span>
                </div>
                <div class="stat-card">
                    <span class="stat-val" id="costVal">0 ‚ÇΩ</span>
                    <span class="stat-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</span>
                </div>
                <div class="stat-card">
                    <span class="stat-val" id="wasteVal">0%</span>
                    <span class="stat-label">–û—Ç—Ö–æ–¥—ã</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const EDGE_MARGIN = 10; 
        const KERF = 3;
        let parts = [];
        let placedItems = []; // Store placed items for interaction
        let hoveredItem = null;

        function showError(msg) {
            const el = document.getElementById('error-msg');
            el.innerText = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function addPart() {
            const w = parseInt(document.getElementById('partW').value);
            const h = parseInt(document.getElementById('partH').value);
            const qty = parseInt(document.getElementById('partQty').value);
            
            const sheetW = parseInt(document.getElementById('sheetW').value);
            const sheetH = parseInt(document.getElementById('sheetH').value);

            const usableW = sheetW - (EDGE_MARGIN * 2);
            const usableH = sheetH - (EDGE_MARGIN * 2);

            if (!w || !h || !qty) {
                showError("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.");
                return;
            }

            const fitsNormal = (w <= usableW && h <= usableH);
            const fitsRotated = (h <= usableW && w <= usableH);

            if (!fitsNormal && !fitsRotated) {
                showError(`–î–µ—Ç–∞–ª—å ${w}x${h} –ù–ï –í–õ–ï–ó–ê–ï–¢ –≤ –ø–æ–ª–µ–∑–Ω—É—é –æ–±–ª–∞—Å—Ç—å –ª–∏—Å—Ç–∞ (${usableW}x${usableH})!`);
                return;
            }

            parts.push({ w, h, qty, id: Date.now() + Math.random() });
            renderPartsList();
            
            document.getElementById('partW').value = '';
            document.getElementById('partH').value = '';
            document.getElementById('partQty').value = '1';
            document.getElementById('partW').focus();
        }

        function removePart(id) {
            parts = parts.filter(p => p.id !== id);
            renderPartsList();
        }

        function clearAll() {
            parts = [];
            placedItems = [];
            renderPartsList();
            const ctx = document.getElementById('layoutCanvas').getContext('2d');
            ctx.clearRect(0, 0, 800, 600);
            document.getElementById('placedCount').innerText = '0';
            document.getElementById('usedPercent').innerText = '0%';
            document.getElementById('hover-info').style.display = 'none';
        }

        function renderPartsList() {
            const list = document.getElementById('parts-list');
            list.innerHTML = '';
            if(parts.length === 0) {
                list.innerHTML = '<div style="padding:15px; text-align:center; color:#94a3b8">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
                return;
            }
            
            let globalNum = 1;
            parts.forEach(p => {
                for(let i = 0; i < p.qty; i++) {
                    const div = document.createElement('div');
                    div.className = 'part-item';
                    div.dataset.id = globalNum;
                    div.innerHTML = `
                        <div>
                            <span class="part-number">#${globalNum}</span>
                            <span class="part-info">${p.w} √ó ${p.h} –º–º</span>
                        </div>
                    `;
                    div.onmouseenter = () => highlightItem(globalNum);
                    div.onmouseleave = () => unhighlightItem();
                    list.appendChild(div);
                    globalNum++;
                }
            });
        }

        class GuillotinePacker {
            constructor(w, h) {
                this.root = { x: 0, y: 0, w: w, h: h };
            }

            fit(blocks) {
                let n, node, block;
                for (n = 0; n < blocks.length; n++) {
                    block = blocks[n];
                    if (node = this.findNode(this.root, block.w, block.h))
                        block.fit = this.splitNode(node, block.w, block.h);
                    else 
                        block.fit = this.growDown(block.w, block.h);
                }
            }

            findNode(root, w, h) {
                if (root.used)
                    return this.findNode(root.right, w, h) || this.findNode(root.down, w, h);
                else if ((w <= root.w) && (h <= root.h))
                    return root;
                else
                    return null;
            }

            splitNode(node, w, h) {
                node.used = true;
                node.down  = { x: node.x,         y: node.y + h + KERF, w: node.w,         h: node.h - h - KERF };
                node.right = { x: node.x + w + KERF, y: node.y,         w: node.w - w - KERF, h: h };
                return node;
            }

            growDown(w, h) {
                return null; 
            }
        }

        function calculateLayout() {
            const sheetW = parseInt(document.getElementById('sheetW').value);
            const sheetH = parseInt(document.getElementById('sheetH').value);
            const price = parseFloat(document.getElementById('sheetPrice').value) || 0;

            const usableW = sheetW - (EDGE_MARGIN * 2);
            const usableH = sheetH - (EDGE_MARGIN * 2);

            let allParts = [];
            parts.forEach(p => {
                for(let i=0; i<p.qty; i++) {
                    allParts.push({ 
                        w: p.w, h: p.h, 
                        originalId: p.id,
                        index: allParts.length + 1,
                        totalQty: p.qty
                    });
                }
            });

            allParts.sort((a, b) => (b.w * b.h) - (a.w * a.h));

            const packer = new GuillotinePacker(usableW, usableH);
            packer.fit(allParts);

            placedItems = [];
            let notPlaced = [];

            allParts.forEach(p => {
                if (p.fit) {
                    placedItems.push({
                        num: p.index,
                        x: p.fit.x + EDGE_MARGIN,
                        y: p.fit.y + EDGE_MARGIN,
                        w: p.w,
                        h: p.h,
                    });
                } else {
                    notPlaced.push(p);
                }
            });

            if (notPlaced.length > 0) {
                alert(`–í–Ω–∏–º–∞–Ω–∏–µ! –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å ${notPlaced.length} –¥–µ—Ç–∞–ª–µ–π –∏–∑-–∑–∞ –Ω–µ—Ö–≤–∞—Ç–∫–∏ –º–µ—Å—Ç–∞.`);
            }

            drawCanvas(sheetW, sheetH, placedItems);
            updateStats(placedItems, allParts.length, sheetW, sheetH, price);
            renderPartsList();
        }

        function drawCanvas(sheetW, sheetH, items) {
            const canvas = document.getElementById('layoutCanvas');
            const ctx = canvas.getContext('2d');

            const maxWidth = 1000;
            const scale = Math.min(maxWidth / sheetW, 1);

            canvas.width = sheetW * scale;
            canvas.height = sheetH * scale;

            canvas.onmousemove = (e) => handleCanvasMouseMove(e, items, scale);
            canvas.onmouseleave = () => {
                hoveredItem = null;
                drawCanvas(sheetW, sheetH, items);
                document.getElementById('hover-info').style.display = 'none';
                clearListHighlight();
            };

            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = "#000";
            ctx.lineWidth = 3;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = "rgba(0,0,0,0.05)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.clearRect(EDGE_MARGIN * scale, EDGE_MARGIN * scale, (sheetW - EDGE_MARGIN*2) * scale, (sheetH - EDGE_MARGIN*2) * scale);
            
            ctx.strokeStyle = "#cbd5e1";
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(EDGE_MARGIN * scale, EDGE_MARGIN * scale, (sheetW - EDGE_MARGIN*2) * scale, (sheetH - EDGE_MARGIN*2) * scale);
            ctx.setLineDash([]);

            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            items.forEach((item) => {
                const x = item.x * scale;
                const y = item.y * scale;
                const w = item.w * scale;
                const h = item.h * scale;

                const isHovered = hoveredItem && hoveredItem.num === item.num;
                
                ctx.fillStyle = isHovered ? "#fbbf24" : (item.num % 2 === 0 ? "#dbeafe" : "#e0e7ff");
                ctx.fillRect(x, y, w, h);

                ctx.strokeStyle = isHovered ? "#f59e0b" : "#1e40af";
                ctx.lineWidth = isHovered ? 4 : 2;
                ctx.strokeRect(x, y, w, h);

                if (w > 50 && h > 50) {
                    // –ù–æ–º–µ—Ä –¥–µ—Ç–∞–ª–∏ (—Å–≤–µ—Ä—Ö—É)
                    ctx.fillStyle = isHovered ? "#92400e" : "#1e3a8a";
                    ctx.font = `bold ${Math.max(16, Math.min(w, h) * 0.25)}px Arial`;
                    ctx.fillText(`#${item.num}`, x + w/2, y + h * 0.3);
                    
                    // –†–∞–∑–º–µ—Ä—ã (—Å–Ω–∏–∑—É)
                    ctx.font = `${Math.max(12, Math.min(w, h) * 0.2)}px Arial`;
                    ctx.fillText(`${item.w}√ó${item.h}`, x + w/2, y + h * 0.65);
                }
            });
        }

        function handleCanvasMouseMove(e, items, scale) {
            const canvas = document.getElementById('layoutCanvas');
            const rect = canvas.getBoundingClientRect();
            const mouseX = (e.clientX - rect.left) / scale;
            const mouseY = (e.clientY - rect.top) / scale;

            let found = null;
            for (let item of items) {
                if (mouseX >= item.x && mouseX <= item.x + item.w &&
                    mouseY >= item.y && mouseY <= item.y + item.h) {
                    found = item;
                    break;
                }
            }

            if (found !== hoveredItem) {
                hoveredItem = found;
                const sheetW = parseInt(document.getElementById('sheetW').value);
                const sheetH = parseInt(document.getElementById('sheetH').value);
                drawCanvas(sheetW, sheetH, items);
                
                if (found) {
                    highlightListItem(found.num);
                    const hoverInfo = document.getElementById('hover-info');
                    hoverInfo.innerHTML = `–î–µ—Ç–∞–ª—å #${found.num}<br>–†–∞–∑–º–µ—Ä—ã: ${found.w} √ó ${found.h} –º–º`;
                    hoverInfo.style.display = 'block';
                } else {
                    clearListHighlight();
                    document.getElementById('hover-info').style.display = 'none';
                }
            }
        }

        function highlightItem(num) {
            hoveredItem = placedItems.find(i => i.num === num);
            const sheetW = parseInt(document.getElementById('sheetW').value);
            const sheetH = parseInt(document.getElementById('sheetH').value);
            drawCanvas(sheetW, sheetH, placedItems);
            highlightListItem(num);
            
            const hoverInfo = document.getElementById('hover-info');
            if (hoveredItem) {
                hoverInfo.innerHTML = `–î–µ—Ç–∞–ª—å #${hoveredItem.num}<br>–†–∞–∑–º–µ—Ä—ã: ${hoveredItem.w} √ó ${hoveredItem.h} –º–º`;
                hoverInfo.style.display = 'block';
            }
        }

        function unhighlightItem() {
            hoveredItem = null;
            const sheetW = parseInt(document.getElementById('sheetW').value);
            const sheetH = parseInt(document.getElementById('sheetH').value);
            drawCanvas(sheetW, sheetH, placedItems);
            clearListHighlight();
            document.getElementById('hover-info').style.display = 'none';
        }

        function highlightListItem(num) {
            clearListHighlight();
            const items = document.querySelectorAll('.part-item');
            items.forEach(item => {
                if (parseInt(item.dataset.id) === num) {
                    item.classList.add('active');
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        }

        function clearListHighlight() {
            document.querySelectorAll('.part-item').forEach(item => {
                item.classList.remove('active');
            });
        }

        function updateStats(placed, total, sheetW, sheetH, price) {
            const totalArea = sheetW * sheetH;
            let usedArea = 0;
            placed.forEach(p => usedArea += (p.w * p.h));

            const percent = ((usedArea / totalArea) * 100).toFixed(1);
            const waste = (100 - percent).toFixed(1);
            const cost = Math.round((usedArea / totalArea) * price);

            document.getElementById('placedCount').innerText = `${placed.length} / ${total}`;
            document.getElementById('usedPercent').innerText = `${percent}%`;
            document.getElementById('wasteVal').innerText = `${waste}%`;
            document.getElementById('costVal').innerText = `${cost} ‚ÇΩ`;

            document.getElementById('wasteVal').style.color = waste > 20 ? '#ef4444' : '#059669';
        }
    </script>
</body>
</html>
