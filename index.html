<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –†–∞—Å–∫—Ä–æ—è (GitHub App)</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        h1, h2 { margin-top: 0; font-size: 1.25rem; margin-bottom: 1rem; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500; }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .row { display: flex; gap: 10px; }
        .row > * { flex: 1; }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button.secondary { background-color: #64748b; margin-top: 5px; }
        button.danger { background-color: #ef4444; padding: 5px 10px; width: auto; font-size: 0.8rem;}

        /* Parts List */
        #parts-list {
            margin-top: 20px;
            border-top: 1px solid var(--border);
            max-height: 300px;
            overflow-y: auto;
        }
        .part-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        /* Visualization Area */
        .canvas-container {
            overflow: auto;
            border: 1px solid var(--border);
            background: #eee;
            min-height: 500px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        canvas {
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* Results Summary */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
            background: #f1f5f9;
            padding: 15px;
            border-radius: 6px;
        }
        .stat-item { font-size: 0.9rem; }
        .stat-value { font-weight: bold; font-size: 1.1rem; }
        .highlight { color: var(--primary); }

    </style>
</head>
<body>

    <h1>üìê –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –†–∞—Å–∫—Ä–æ—è</h1>

    <div class="container">
        <!-- Sidebar Controls -->
        <div class="panel">
            <h2>1. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–∏—Å—Ç–∞</h2>
            <div class="row">
                <div class="form-group">
                    <label>–®–∏—Ä–∏–Ω–∞ (–º–º)</label>
                    <input type="number" id="sheetW" value="2080">
                </div>
                <div class="form-group">
                    <label>–í—ã—Å–æ—Ç–∞ (–º–º)</label>
                    <input type="number" id="sheetH" value="2070">
                </div>
            </div>
            <div class="form-group">
                <label>–¶–µ–Ω–∞ –ª–∏—Å—Ç–∞ (‚ÇΩ)</label>
                <input type="number" id="sheetPrice" value="5000">
            </div>

            <h2>2. –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å</h2>
            <div class="row">
                <div class="form-group">
                    <label>–®–∏—Ä–∏–Ω–∞</label>
                    <input type="number" id="partW" placeholder="–º–º">
                </div>
                <div class="form-group">
                    <label>–í—ã—Å–æ—Ç–∞</label>
                    <input type="number" id="partH" placeholder="–º–º">
                </div>
            </div>
            <div class="form-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                <input type="number" id="partQty" value="1">
            </div>
            <button onclick="addPart()">–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫</button>

            <div id="parts-list">
                <!-- Parts will appear here -->
            </div>

            <button onclick="calculateLayout()" style="margin-top: 20px; font-size: 1.1rem;">–†–ê–°–°–ß–ò–¢–ê–¢–¨ –†–ê–°–ö–†–û–ô</button>
        </div>

        <!-- Main Visualization -->
        <div class="panel">
            <h2>–ö–∞—Ä—Ç–∞ —Ä–∞—Å–∫—Ä–æ—è</h2>
            <div class="canvas-container">
                <canvas id="layoutCanvas"></canvas>
            </div>

            <div class="summary-grid" id="summary">
                <div class="stat-item">–î–µ—Ç–∞–ª–µ–π —Ä–∞–∑–º–µ—â–µ–Ω–æ: <span class="stat-value" id="placedCount">0</span></div>
                <div class="stat-item">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: <span class="stat-value" id="usedArea">0%</span></div>
                <div class="stat-item">–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–µ—Ç–∞–ª–µ–π: <span class="stat-value" id="costDetails">0 ‚ÇΩ</span></div>
                <div class="stat-item">–û—Ç—Ö–æ–¥—ã: <span class="stat-value" id="wasteArea">0%</span></div>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let parts = [];
        const EDGE_MARGIN = 10; // 10mm margin
        const KERF = 3;         // 3mm gap between parts

        function addPart() {
            const w = parseInt(document.getElementById('partW').value);
            const h = parseInt(document.getElementById('partH').value);
            const qty = parseInt(document.getElementById('partQty').value);

            if (!w || !h || !qty) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è —Ä–∞–∑–º–µ—Ä–æ–≤ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.");
                return;
            }

            parts.push({ w, h, qty, id: Date.now() });
            renderPartsList();
            
            // Clear inputs
            document.getElementById('partW').value = '';
            document.getElementById('partH').value = '';
            document.getElementById('partQty').value = '1';
        }

        function removePart(id) {
            parts = parts.filter(p => p.id !== id);
            renderPartsList();
        }

        function renderPartsList() {
            const list = document.getElementById('parts-list');
            list.innerHTML = '';
            parts.forEach(p => {
                const div = document.createElement('div');
                div.className = 'part-item';
                div.innerHTML = `
                    <span>${p.w}x${p.h} –º–º ‚Äî <b>${p.qty} —à—Ç.</b></span>
                    <button class="danger" onclick="removePart(${p.id})">X</button>
                `;
                list.appendChild(div);
            });
        }

        // --- Packing Algorithm (Guillotine / Shelf Strategy) ---
        function calculateLayout() {
            const sheetW = parseInt(document.getElementById('sheetW').value);
            const sheetH = parseInt(document.getElementById('sheetH').value);
            const price = parseFloat(document.getElementById('sheetPrice').value) || 0;

            // 1. Expand parts list based on quantity
            let flatParts = [];
            parts.forEach(p => {
                for(let i=0; i<p.qty; i++) {
                    flatParts.push({ w: p.w, h: p.h, originalId: p.id });
                }
            });

            // Sort parts: Largest area first (usually better for packing)
            flatParts.sort((a, b) => (b.w * b.h) - (a.w * a.h));

            // 2. Initialize Sheet
            // We create a grid of "free spaces". Initially, one big space inside margins.
            const usableW = sheetW - (EDGE_MARGIN * 2);
            const usableH = sheetH - (EDGE_MARGIN * 2);

            if (usableW <= 0 || usableH <= 0) {
                alert("–†–∞–∑–º–µ—Ä—ã –ª–∏—Å—Ç–∞ —Å–ª–∏—à–∫–æ–º –º–∞–ª—ã –¥–ª—è –∑–∞–¥–∞–Ω–Ω—ã—Ö –æ—Ç—Å—Ç—É–ø–æ–≤!");
                return;
            }

            // Simple Shelf Packing Algorithm
            let placedParts = [];
            let currentX = EDGE_MARGIN;
            let currentY = EDGE_MARGIN;
            let rowHeight = 0;

            // Helper to check if fits in current row
            // Note: This is a simplified "Next Fit" heuristic. 
            // For complex optimization, a recursive guillotine algorithm is needed, 
            // but this is sufficient for a lightweight web app.
            
            // Let's try a slightly smarter approach: "Best Fit" or simple shelf
            // We will try to place parts in rows.
            
            // Reset variables for the loop
            let tempParts = [...flatParts];
            let remainingParts = [];
            
            // We need to track where we place things for drawing
            let layoutItems = [];

            // Simple Shelf Algorithm Implementation
            let x = EDGE_MARGIN;
            let y = EDGE_MARGIN;
            let maxHeightInRow = 0;

            for (let i = 0; i < tempParts.length; i++) {
                let part = tempParts[i];
                
                // Check if part fits in width
                if (x + part.w <= sheetW - EDGE_MARGIN) {
                    // Place it
                    layoutItems.push({
                        x: x,
                        y: y,
                        w: part.w,
                        h: part.h
                    });
                    
                    x += part.w + KERF;
                    if (part.h > maxHeightInRow) {
                        maxHeightInRow = part.h;
                    }
                } else {
                    // Move to next row
                    x = EDGE_MARGIN;
                    y += maxHeightInRow + KERF;
                    maxHeightInRow = 0; // Reset for new row

                    // Try again in new row
                    if (x + part.w <= sheetW - EDGE_MARGIN && y + part.h <= sheetH - EDGE_MARGIN) {
                         layoutItems.push({
                            x: x,
                            y: y,
                            w: part.w,
                            h: part.h
                        });
                        x += part.w + KERF;
                        maxHeightInRow = part.h;
                    } else {
                        // Cannot fit at all
                        remainingParts.push(part);
                    }
                }
            }

            // 3. Draw Results
            drawCanvas(sheetW, sheetH, layoutItems);
            updateStats(layoutItems, flatParts.length, sheetW, sheetH, price);
        }

        function drawCanvas(sheetW, sheetH, items) {
            const canvas = document.getElementById('layoutCanvas');
            const ctx = canvas.getContext('2d');

            // Scale to fit screen if sheet is huge
            const maxDisplayWidth = 800;
            const scale = Math.min(maxDisplayWidth / sheetW, 1);

            canvas.width = sheetW * scale;
            canvas.height = sheetH * scale;

            // Clear
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw Sheet Border
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);

            // Draw Margin Area (Visual guide)
            ctx.fillStyle = "#f0f0f0";
            ctx.fillRect(
                EDGE_MARGIN * scale, 
                EDGE_MARGIN * scale, 
                (sheetW - EDGE_MARGIN*2) * scale, 
                (sheetH - EDGE_MARGIN*2) * scale
            );

            // Draw Parts
            ctx.font = `${12 * scale}px Arial`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            items.forEach((item, index) => {
                // Fill
                ctx.fillStyle = "#bfdbfe"; // Light blue
                ctx.fillRect(item.x * scale, item.y * scale, item.w * scale, item.h * scale);
                
                // Border
                ctx.strokeStyle = "#1e40af";
                ctx.lineWidth = 1;
                ctx.strokeRect(item.x * scale, item.y * scale, item.w * scale, item.h * scale);

                // Text (Dimensions + ID)
                ctx.fillStyle = "#1e3a8a";
                // Only draw text if box is big enough
                if (item.w * scale > 30 && item.h * scale > 20) {
                    ctx.fillText(`${item.w}x${item.h}`, item.x * scale + (item.w * scale)/2, item.y * scale + (item.h * scale)/2);
                }
            });
        }

        function updateStats(placedItems, totalPartsCount, sheetW, sheetH, sheetPrice) {
            const totalSheetArea = sheetW * sheetH;
            let usedArea = 0;

            placedItems.forEach(item => {
                usedArea += (item.w * item.h);
            });

            const usedPercent = ((usedArea / totalSheetArea) * 100).toFixed(1);
            const wastePercent = (100 - usedPercent).toFixed(1);
            
            // Cost calculation logic: 
            // Proportional cost based on area used
            const costUsed = (usedArea / totalSheetArea) * sheetPrice;

            document.getElementById('placedCount').innerText = `${placedItems.length} / ${totalPartsCount}`;
            document.getElementById('usedArea').innerText = `${usedPercent}%`;
            document.getElementById('wasteArea').innerText = `${wastePercent}%`;
            document.getElementById('costDetails').innerText = `${Math.round(costUsed)} ‚ÇΩ`;

            // Color coding for waste
            const wasteEl = document.getElementById('wasteArea');
            if (wastePercent > 30) wasteEl.style.color = "red";
            else wasteEl.style.color = "green";
        }

    </script>
</body>
</html>
