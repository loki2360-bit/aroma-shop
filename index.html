<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AromaShop - –≠—Ñ–∏—Ä–Ω—ã–µ –º–∞—Å–ª–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --button-color: var(--tg-theme-button-color, #3390ec);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f4f4f5);
        }
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: 0;
            padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }
        .error-message {
            color: #ff4757;
            padding: 15px;
            text-align: center;
            display: none;
            background: #ffeaa7;
            margin: 10px;
            border-radius: 8px;
            font-size: 14px;
        }
        .nav { 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            background: var(--bg-color); 
            border-top: 1px solid var(--hint-color); 
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0; 
            z-index: 100; 
        }
        .nav-item { 
            font-size: 11px; 
            text-align: center; 
            color: var(--hint-color); 
            cursor: pointer; 
            flex: 1;
        }
        .nav-item.active { 
            color: var(--button-color); 
            font-weight: bold; 
        }
        .nav-icon { 
            font-size: 22px; 
            display: block; 
            margin-bottom: 3px; 
        }
        .page { 
            display: none; 
            padding: 15px; 
        }
        .page.active { 
            display: block; 
        }
        h2 { margin-top: 0; font-size: 22px; }
        .product-card { 
            display: flex; 
            background: var(--secondary-bg); 
            border-radius: 12px; 
            padding: 12px; 
            margin-bottom: 12px; 
            align-items: center; 
        }
        .product-img { 
            width: 70px; 
            height: 70px; 
            background: #ddd; 
            border-radius: 10px; 
            margin-right: 15px; 
            object-fit: cover; 
        }
        .product-info { 
            flex: 1; 
        }
        .product-title { 
            font-weight: bold; 
            font-size: 16px; 
            margin-bottom: 4px; 
        }
        .product-desc { 
            font-size: 12px; 
            color: var(--hint-color); 
            margin-bottom: 6px; 
        }
        .product-price { 
            font-weight: bold; 
            color: var(--button-color); 
            font-size: 16px;
        }
        .add-btn { 
            background: var(--button-color); 
            color: var(--button-text-color); 
            border: none; 
            padding: 8px 16px; 
            border-radius: 8px; 
            font-size: 13px; 
            cursor: pointer; 
            font-weight: 500;
        }
        .add-btn:active { opacity: 0.8; }
        .cart-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px 0; 
            border-bottom: 1px solid var(--secondary-bg); 
        }
        input { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 10px; 
            border: 1px solid var(--hint-color); 
            border-radius: 10px; 
            background: var(--secondary-bg); 
            color: var(--text-color); 
            font-size: 14px;
        }
        input:focus { outline: 2px solid var(--button-color); border-color: transparent; }
        .main-btn { 
            width: 100%; 
            padding: 16px; 
            background: var(--button-color); 
            color: var(--button-text-color); 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: bold; 
            margin-top: 15px; 
            cursor: pointer; 
        }
        .main-btn:active { opacity: 0.8; }
        .hidden { display: none; }
        .badge { 
            background: #ff4757; 
            color: white; 
            border-radius: 50%; 
            padding: 3px 7px; 
            font-size: 11px; 
            position: absolute; 
            top: -5px; 
            right: 10px; 
            font-weight: bold;
        }
        .nav-item { position: relative; }
        
        #loader { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(255,255,255,0.95); 
            display: none;
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            z-index: 200; 
        }
        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--secondary-bg);
            border-top: 4px solid var(--button-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-text {
            margin-top: 15px;
            font-size: 15px;
            color: var(--hint-color);
        }
        
        .profile-card {
            background: var(--secondary-bg); 
            padding: 20px; 
            border-radius: 12px; 
            text-align: center;
            margin-bottom: 20px;
        }
        .points-display {
            font-size: 36px;
            color: var(--button-color);
            font-weight: bold;
            margin: 10px 0;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            font-size: 13px;
            margin: 10px 0;
        }
        .checkbox-label input {
            width: auto;
            margin: 0 8px;
        }
        .total-row {
            text-align: right;
            font-size: 16px;
            margin: 15px 0;
        }
        .admin-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--hint-color);
        }
        .admin-badge {
            background: #ff4757;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 8px;
        }
        .debug-info {
            font-size: 10px;
            color: var(--hint-color);
            background: var(--secondary-bg);
            padding: 8px;
            border-radius: 6px;
            margin-top: 10px;
            word-break: break-all;
        }
    </style>
</head>
<body>

<!-- Loader -->
<div id="loader">
    <div class="loader-spinner"></div>
    <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<!-- Error Box -->
<div id="error-box" class="error-message"></div>

<!-- –ö–ê–¢–ê–õ–û–ì -->
<div id="page-catalog" class="page active">
    <h2>üåø –≠—Ñ–∏—Ä–Ω—ã–µ –º–∞—Å–ª–∞</h2>
    <div id="products-list"></div>
</div>

<!-- –ö–û–†–ó–ò–ù–ê -->
<div id="page-cart" class="page">
    <h2>üõí –ö–æ—Ä–∑–∏–Ω–∞</h2>
    <div id="cart-items"></div>
    <div class="total-row">
        <p>–ò—Ç–æ–≥–æ: <strong id="cart-total">0</strong> ‚ÇΩ</p>
        <p>–í–∞—à–∏ –±–∞–ª–ª—ã: <strong id="cart-points" style="color:var(--button-color)">0</strong></p>
        <label class="checkbox-label">
            <input type="checkbox" id="use-points" onchange="renderCart()"> 
            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–ª–ª—ã (1 –±–∞–ª–ª = 1‚ÇΩ)
        </label>
    </div>
    <button class="main-btn" onclick="checkout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
</div>

<!-- –ü–†–û–§–ò–õ–¨ -->
<div id="page-profile" class="page">
    <h2>üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
    <div class="profile-card">
        <h3 id="user-name" style="margin:0">–ì–æ—Å—Ç—å</h3>
        <div class="points-display"><span id="profile-points">0</span> –±–∞–ª–ª–æ–≤</div>
        <p style="font-size: 12px; color: var(--hint-color); margin:0">ID: <span id="user-id-display"></span></p>
    </div>
    
    <!-- –ú–æ–∏ –∑–∞–∫–∞–∑—ã (–≤–∏–¥–Ω—ã –≤—Å–µ–º) -->
    <div class="admin-section">
        <h3>üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã</h3>
        <button class="main-btn" style="background-color: #3390ec;" onclick="loadMyOrders()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <div id="my-orders-list" style="margin-top: 15px;"></div>
        <div id="my-orders-debug" class="debug-info" style="display:none;"></div>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞ -->
    <div class="admin-section" style="text-align: center; padding: 20px;">
        <button id="admin-login-btn" class="main-btn" style="background-color: #a4b0be; width: auto; padding: 12px 30px;" onclick="showAdminLogin()">üîê –í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∞</button>
    </div>
    
    <!-- –°–∫—Ä—ã—Ç–∞—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å -->
    <div id="admin-panel" class="admin-section" style="display: none;">
        <h3>üîß –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞ <span class="admin-badge">ADMIN</span></h3>
        <p style="font-size: 12px; color: var(--hint-color);">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
        
        <input type="text" id="admin-user-id" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        <input type="number" id="admin-points-amount" placeholder="–°—É–º–º–∞ (+ –Ω–∞—á–∏—Å–ª–∏—Ç—å, - —Å–ø–∏—Å–∞—Ç—å)">
        <button class="main-btn" style="background-color: #ff4757;" onclick="adminAction()">–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
        
        <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--hint-color);">
        
        <h3>üìã –í—Å–µ –∑–∞–∫–∞–∑—ã –º–∞–≥–∞–∑–∏–Ω–∞</h3>
        <button class="main-btn" style="background-color: #2ed573;" onclick="loadAllOrders()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        <div id="all-orders-list" style="margin-top: 15px;"></div>
        <div id="all-orders-debug" class="debug-info" style="display:none;"></div>
        
        <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--hint-color);">
        
        <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
        <input type="text" id="bot-token" placeholder="Telegram Bot Token">
        <input type="text" id="seller-chat-id" placeholder="Chat ID –ø—Ä–æ–¥–∞–≤—Ü–∞">
        <button class="main-btn" style="background-color: #3390ec;" onclick="saveNotificationSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        
        <button class="main-btn" style="background-color: #a4b0be; margin-top: 20px;" onclick="hideAdminPanel()">üîí –í—ã–π—Ç–∏ –∏–∑ –∞–¥–º–∏–Ω–∫–∏</button>
    </div>
</div>

<!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
<div class="nav">
    <div class="nav-item active" onclick="switchPage('catalog')">
        <span class="nav-icon">üåø</span>
        –ö–∞—Ç–∞–ª–æ–≥
    </div>
    <div class="nav-item" onclick="switchPage('cart')">
        <span class="nav-icon">üõí</span>
        –ö–æ—Ä–∑–∏–Ω–∞
        <span id="cart-badge" class="badge hidden">0</span>
    </div>
    <div class="nav-item" onclick="switchPage('profile')">
        <span class="nav-icon">üë§</span>
        –ü—Ä–æ—Ñ–∏–ª—å
    </div>
</div>

<script>
    // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
    const SUPABASE_URL = 'https://zitdekerfjocbulmfuyo.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InppdGRla2VyZmpvY2J1bG1mdXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxODA0ODksImV4cCI6MjA4NDc1NjQ4OX0.PHET6UIg-PqspgeHUQMATXmYV7tBV7UhH6u27oacPM8';
    const ADMIN_PASS = '1234';
    const ADMIN_SESSION_KEY = 'admin_authenticated';
    
    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø SUPABASE ==========
    let supabaseClient = null;
    let isSupabaseReady = false;
    
    function initSupabase() {
        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_KEY === 'YOUR_SUPABASE_KEY') {
            console.warn('‚ö†Ô∏è Supabase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω! –†–∞–±–æ—Ç–∞–µ–º –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ');
            showDebug('my-orders-debug', '‚ö†Ô∏è –î–µ–º–æ-—Ä–µ–∂–∏–º (–±–µ–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö)');
            return false;
        }
        
        try {
            if (typeof window.supabase !== 'undefined') {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('‚úÖ Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω');
                showDebug('my-orders-debug', '‚úÖ Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω');
                return true;
            } else {
                console.error('‚ùå Supabase CDN –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è');
                showDebug('my-orders-debug', '‚ùå Supabase CDN –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è');
                return false;
            }
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ Supabase:', e);
            showDebug('my-orders-debug', '‚ùå –û—à–∏–±–∫–∞: ' + e.message);
            return false;
        }
    }
    
    isSupabaseReady = initSupabase();

    // ========== TELEGRAM WEBAPP ==========
    let tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();
    
    // ========== –î–ê–ù–ù–´–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
    let cart = [];
    let userPoints = 0;
    let userId = tg.initDataUnsafe?.user?.id || 99999;
    let userName = tg.initDataUnsafe?.user?.first_name || '–ì–æ—Å—Ç—å';
    let userUsername = tg.initDataUnsafe?.user?.username || 'unknown';
    let isAdminAuthenticated = false;

    document.getElementById('user-name').innerText = userName;
    document.getElementById('user-id-display').innerText = userId;

    // ========== –¢–û–í–ê–†–´ ==========
    const products = [
        { id: 1, name: '–õ–∞–≤–∞–Ω–¥–∞', price: 450, desc: '–£—Å–ø–æ–∫–∞–∏–≤–∞—é—â–µ–µ, 10–º–ª', img: 'https://via.placeholder.com/70/9090ff/ffffff?text=Lav' },
        { id: 2, name: '–ß–∞–π–Ω–æ–µ –¥–µ—Ä–µ–≤–æ', price: 390, desc: '–ê–Ω—Ç–∏—Å–µ–ø—Ç–∏–∫, 10–º–ª', img: 'https://via.placeholder.com/70/90ff90/ffffff?text=Tea' },
        { id: 3, name: '–ì–∏–¥—Ä–æ–ª–∞—Ç –†–æ–∑—ã', price: 600, desc: '–£–≤–ª–∞–∂–Ω–µ–Ω–∏–µ, 100–º–ª', img: 'https://via.placeholder.com/70/ff9090/ffffff?text=Rose' },
        { id: 4, name: '–ê–ø–µ–ª—å—Å–∏–Ω', price: 300, desc: '–¢–æ–Ω—É—Å, 10–º–ª', img: 'https://via.placeholder.com/70/ffaa00/ffffff?text=Ora' },
        { id: 5, name: '–ú—è—Ç–∞', price: 350, desc: '–û—Å–≤–µ–∂–∞—é—â–µ–µ, 10–º–ª', img: 'https://via.placeholder.com/70/90ffcc/ffffff?text=Mint' },
        { id: 6, name: '–≠–≤–∫–∞–ª–∏–ø—Ç', price: 380, desc: '–î–ª—è –¥—ã—Ö–∞–Ω–∏—è, 10–º–ª', img: 'https://via.placeholder.com/70/ccff90/ffffff?text=Euc' },
    ];

    // ========== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
    initApp();

    async function initApp() {
        showLoader(true);
        
        try {
            checkAdminSession();
            
            if (isSupabaseReady) {
                await loadUserBalance();
            } else {
                const savedPoints = localStorage.getItem('userPoints_' + userId);
                userPoints = savedPoints ? parseInt(savedPoints) : 0;
            }
            
            renderCatalog();
            updatePointsUI();
            updateBadge();
            
            showLoader(false);
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', e);
            showError('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message);
            showLoader(false);
        }
    }

    // ========== –û–¢–õ–ê–î–ö–ê ==========
    function showDebug(elementId, message) {
        const el = document.getElementById(elementId);
        if (el) {
            el.style.display = 'block';
            el.innerHTML = message;
        }
        console.log('[DEBUG]', message);
    }

    // ========== –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ ==========
    function checkAdminSession() {
        const isAuth = localStorage.getItem(ADMIN_SESSION_KEY);
        if (isAuth === 'true') {
            isAdminAuthenticated = true;
            showAdminPanel();
        }
    }

    function showAdminLogin() {
        const pass = prompt('üîê –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞:');
        if (pass === null) return;
        if (pass === ADMIN_PASS) {
            isAdminAuthenticated = true;
            localStorage.setItem(ADMIN_SESSION_KEY, 'true');
            showAdminPanel();
            alert('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
        } else {
            alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
        }
    }

    function showAdminPanel() {
        document.getElementById('admin-panel').style.display = 'block';
        document.getElementById('admin-login-btn').style.display = 'none';
        loadAllOrders();
    }

    function hideAdminPanel() {
        document.getElementById('admin-panel').style.display = 'none';
        document.getElementById('admin-login-btn').style.display = 'block';
        isAdminAuthenticated = false;
        localStorage.removeItem(ADMIN_SESSION_KEY);
    }

    // ========== –†–ê–ë–û–¢–ê –° –ë–ê–ó–û–ô –î–ê–ù–ù–´–• ==========
    async function loadUserBalance() {
        if (!supabaseClient) return;
        
        try {
            console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è userId:', userId);
            
            let {  user, error } = await supabaseClient
                .from('users')
                .select('balance')
                .eq('id', userId)
                .single();

            console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç:', { user, error });

            if (error || !user) {
                console.log('üìù –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                const insertResult = await supabaseClient.from('users').insert([{ 
                    id: userId, 
                    username: userUsername, 
                    balance: 0 
                }]);
                console.log('üìù –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è:', insertResult);
                userPoints = 0;
            } else {
                userPoints = user.balance;
            }
            
            console.log('‚úÖ –ë–∞–ª–∞–Ω—Å:', userPoints);
            showDebug('my-orders-debug', '‚úÖ –ë–∞–ª–∞–Ω—Å –∑–∞–≥—Ä—É–∂–µ–Ω: ' + userPoints + ' –±–∞–ª–ª–æ–≤');
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:', e);
            showDebug('my-orders-debug', '‚ùå –û—à–∏–±–∫–∞ –±–∞–ª–∞–Ω—Å–∞: ' + e.message);
        }
    }

    async function saveUserBalance(newBalance) {
        if (!supabaseClient) {
            localStorage.setItem('userPoints_' + userId, newBalance);
            return true;
        }
        
        try {
            console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞:', newBalance);
            const {  updateData, error } = await supabaseClient
                .from('users')
                .update({ balance: newBalance })
                .eq('id', userId);
            
            console.log('üíæ –†–µ–∑—É–ª—å—Ç–∞—Ç:', { updateData, error });
            
            if (error) throw error;
            return true;
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            return false;
        }
    }

    async function createOrder(totalRaw, pointsUsed) {
        const orderData = {
            user_id: userId,
            username: userUsername,
            items: cart.map(i => i.name).join(', '),
            total_amount: totalRaw,
            points_used: pointsUsed
        };
        
        console.log('üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞:', orderData);
        
        if (!supabaseClient) {
            const orders = JSON.parse(localStorage.getItem('orders_' + userId) || '[]');
            orders.push({
                id: Date.now(),
                ...orderData,
                created_at: new Date().toISOString()
            });
            localStorage.setItem('orders_' + userId, JSON.stringify(orders));
            console.log('üì¶ –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage');
            return true;
        }
        
        try {
            const {  orderResult, error } = await supabaseClient.from('orders').insert([orderData]);
            
            console.log('üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞:', { orderResult, error });
            
            if (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–∫–∞–∑–∞:', error);
                throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: ' + error.message);
            }
            
            return true;
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞:', e);
            throw e;
        }
    }

    // ========== –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê ==========
    async function checkout() {
        if (cart.length === 0) {
            alert('üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!');
            return;
        }
        
        const usePoints = document.getElementById('use-points').checked;
        let totalRaw = cart.reduce((sum, item) => sum + item.price, 0);
        let pointsUsed = 0;
        let finalPrice = totalRaw;

        if (usePoints && userPoints > 0) {
            if (userPoints >= totalRaw) {
                pointsUsed = totalRaw;
                finalPrice = 0;
            } else {
                pointsUsed = userPoints;
                finalPrice = totalRaw - userPoints;
            }
        }

        const confirmMsg = `üì¶ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞\n\n` +
                          `üí∞ –ö –æ–ø–ª–∞—Ç–µ: ${finalPrice} ‚ÇΩ\n` +
                          `üéÅ –°–ø–∏—Å–∞–Ω–æ –±–∞–ª–ª–æ–≤: ${pointsUsed}\n` +
                          `üìã –¢–æ–≤–∞—Ä–æ–≤: ${cart.length}\n\n` +
                          `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`;
        
        if (!confirm(confirmMsg)) return;
        
        showLoader(true);
        
        try {
            const orderSuccess = await createOrder(totalRaw, pointsUsed);
            if (!orderSuccess) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑');

            const pointsEarned = Math.floor(totalRaw * 0.1);
            const newBalance = userPoints - pointsUsed + pointsEarned;

            const saveSuccess = await saveUserBalance(newBalance);
            if (!saveSuccess) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å');

            userPoints = newBalance;
            
            await sendOrderNotification({
                username: userUsername,
                user_id: userId,
                items: cart.map(i => i.name).join(', '),
                total_amount: totalRaw,
                points_used: pointsUsed
            });
            
            cart = [];
            updateBadge();
            renderCart();
            updatePointsUI();
            
            alert(`‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!\n\nüéÅ –ù–∞—á–∏—Å–ª–µ–Ω–æ –±–∞–ª–ª–æ–≤: ${pointsEarned}\nüíé –í–∞—à –±–∞–ª–∞–Ω—Å: ${newBalance}`);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤
            loadMyOrders();
            
            switchPage('catalog');
            
        } catch (e) {
            console.error(e);
            alert('‚ùå –û—à–∏–±–∫–∞: ' + e.message);
        } finally {
            showLoader(false);
        }
    }

    // ========== –ê–î–ú–ò–ù –î–ï–ô–°–¢–í–ò–Ø ==========
    async function adminAction() {
        if (!isAdminAuthenticated) {
            alert('‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∞');
            showAdminLogin();
            return;
        }
        
        const targetId = document.getElementById('admin-user-id').value;
        const amount = parseInt(document.getElementById('admin-points-amount').value);

        if (!targetId || isNaN(amount)) {
            alert('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å—É–º–º—É');
            return;
        }

        showLoader(true);
        
        try {
            if (!supabaseClient) {
                alert('‚ÑπÔ∏è –í –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
                showLoader(false);
                return;
            }
            
            let {  userData } = await supabaseClient
                .from('users')
                .select('balance')
                .eq('id', targetId)
                .single();
            
            let currentBalance = userData ? userData.balance : 0;
            
            if (!userData) {
                await supabaseClient.from('users').insert([{ 
                    id: targetId, 
                    username: 'admin_created', 
                    balance: 0 
                }]);
            }

            const newBalance = currentBalance + amount;

            await supabaseClient
                .from('users')
                .update({ balance: newBalance })
                .eq('id', targetId);

            alert(`‚úÖ –ë–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω–µ–Ω!\n\nüë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${targetId}\nüí∞ –ë—ã–ª–æ: ${currentBalance}\nüí∞ –°—Ç–∞–ª–æ: ${newBalance}`);
            
            if (targetId == userId) {
                userPoints = newBalance;
                updatePointsUI();
            }

        } catch (e) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + e.message);
        } finally {
            showLoader(false);
        }
    }

    // ========== –ó–ê–ì–†–£–ó–ö–ê –ó–ê–ö–ê–ó–û–í ==========
    async function loadMyOrders() {
        const container = document.getElementById('my-orders-list');
        const debugEl = document.getElementById('my-orders-debug');
        
        container.innerHTML = '<p style="text-align:center">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>';
        if (debugEl) debugEl.style.display = 'none';
        
        console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è userId:', userId);
        
        try {
            if (!supabaseClient) {
                const orders = JSON.parse(localStorage.getItem('orders_' + userId) || '[]');
                console.log('üìä –ó–∞–∫–∞–∑—ã –∏–∑ localStorage:', orders);
                showDebug('my-orders-debug', `üìä –ù–∞–π–¥–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${orders.length}`);
                renderOrdersList(orders, container);
                return;
            }
            
            const {  orders, error } = await supabaseClient
                .from('orders')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false });
            
            console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', { orders, error });
            
            if (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', error);
                showDebug('my-orders-debug', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
                container.innerHTML = `<p style="color:red; text-align:center">–û—à–∏–±–∫–∞: ${error.message}</p>`;
                return;
            }
            
            showDebug('my-orders-debug', `üìä –ù–∞–π–¥–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${orders ? orders.length : 0}`);
            renderOrdersList(orders || [], container);
            
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞:', e);
            showDebug('my-orders-debug', `‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
            container.innerHTML = `<p style="color:red; text-align:center">–û—à–∏–±–∫–∞: ${e.message}</p>`;
        }
    }

    async function loadAllOrders() {
        if (!isAdminAuthenticated) {
            alert('‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∞');
            showAdminLogin();
            return;
        }
        
        const container = document.getElementById('all-orders-list');
        const debugEl = document.getElementById('all-orders-debug');
        
        container.innerHTML = '<p style="text-align:center">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</p>';
        if (debugEl) debugEl.style.display = 'none';
        
        try {
            if (!supabaseClient) {
                container.innerHTML = '<p style="text-align:center; color:var(--hint-color)">–í –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</p>';
                return;
            }
            
            const {  orders, error } = await supabaseClient
                .from('orders')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);
            
            console.log('üìä –í—Å–µ –∑–∞–∫–∞–∑—ã:', { orders, error });
            
            if (error) {
                showDebug('all-orders-debug', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
                container.innerHTML = `<p style="color:red">–û—à–∏–±–∫–∞: ${error.message}</p>`;
                return;
            }
            
            showDebug('all-orders-debug', `üìä –ù–∞–π–¥–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${orders ? orders.length : 0}`);
            renderOrdersList(orders || [], container);
            
        } catch (e) {
            showDebug('all-orders-debug', `‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
            container.innerHTML = `<p style="color:red">–û—à–∏–±–∫–∞: ${e.message}</p>`;
        }
    }

    function renderOrdersList(orders, container) {
        if (!orders || orders.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:var(--hint-color)">–ó–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç</p>';
            return;
        }
        
        container.innerHTML = orders.map(order => `
            <div style="background:var(--secondary-bg); padding:12px; border-radius:8px; margin-bottom:10px; font-size:13px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <strong>üì¶ #${order.id}</strong>
                    <span style="color:var(--hint-color)">${new Date(order.created_at).toLocaleString('ru-RU')}</span>
                </div>
                <div>üë§ ${order.username}</div>
                <div>üìã ${order.items}</div>
                <div style="display:flex; justify-content:space-between; margin-top:8px;">
                    <span>üí∞ ${order.total_amount} ‚ÇΩ</span>
                    <span>üéÅ ${order.points_used} –±–∞–ª.</span>
                </div>
            </div>
        `).join('');
    }

    // ========== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ==========
    function saveNotificationSettings() {
        const botToken = document.getElementById('bot-token').value;
        const chatId = document.getElementById('seller-chat-id').value;
        
        if (botToken && chatId) {
            localStorage.setItem('telegram_bot_token', botToken);
            localStorage.setItem('seller_chat_id', chatId);
            alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
        } else {
            alert('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        }
    }

    async function sendOrderNotification(orderData) {
        const botToken = localStorage.getItem('telegram_bot_token');
        const chatId = localStorage.getItem('seller_chat_id');
        
        if (!botToken || !chatId) {
            console.warn('‚ö†Ô∏è Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
            return;
        }
        
        const message = `
üõí <b>–ù–û–í–´–ô –ó–ê–ö–ê–ó!</b>

üë§ <b>–ö–ª–∏–µ–Ω—Ç:</b> ${orderData.username}
üÜî <b>ID:</b> ${orderData.user_id}

üìã <b>–¢–æ–≤–∞—Ä—ã:</b>
${orderData.items}

üí∞ <b>–°—É–º–º–∞:</b> ${orderData.total_amount} ‚ÇΩ
üéÅ <b>–°–ø–∏—Å–∞–Ω–æ –±–∞–ª–ª–æ–≤:</b> ${orderData.points_used}

üìÖ <b>–í—Ä–µ–º—è:</b> ${new Date().toLocaleString('ru-RU')}
        `.trim();
        
        try {
            const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: message,
                    parse_mode: 'HTML'
                })
            });
            const result = await response.json();
            console.log('‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:', result);
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', e);
        }
    }

    // ========== –ò–ù–¢–ï–†–§–ï–ô–° ==========
    function showLoader(show) {
        const loader = document.getElementById('loader');
        loader.style.display = show ? 'flex' : 'none';
    }

    function showError(message) {
        const errorBox = document.getElementById('error-box');
        errorBox.innerHTML = message;
        errorBox.style.display = 'block';
        setTimeout(() => {
            errorBox.style.display = 'none';
        }, 8000);
    }

    function updatePointsUI() {
        document.getElementById('profile-points').innerText = userPoints;
        document.getElementById('cart-points').innerText = userPoints;
    }

    function renderCatalog() {
        const container = document.getElementById('products-list');
        container.innerHTML = products.map(p => `
            <div class="product-card">
                <img src="${p.img}" class="product-img" alt="${p.name}">
                <div class="product-info">
                    <div class="product-title">${p.name}</div>
                    <div class="product-desc">${p.desc}</div>
                    <div class="product-price">${p.price} ‚ÇΩ</div>
                </div>
                <button class="add-btn" onclick="addToCart(${p.id})">–í –∫–æ—Ä–∑–∏–Ω—É</button>
            </div>
        `).join('');
    }

    function switchPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        
        document.getElementById(`page-${pageId}`).classList.add('active');
        
        const navItems = document.querySelectorAll('.nav-item');
        if (pageId === 'catalog') navItems[0].classList.add('active');
        if (pageId === 'cart') {
            navItems[1].classList.add('active');
            renderCart();
        }
        if (pageId === 'profile') {
            navItems[2].classList.add('active');
            loadMyOrders(); // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è
        }
    }

    function addToCart(id) {
        const product = products.find(p => p.id === id);
        cart.push(product);
        updateBadge();
        if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    function updateBadge() {
        const badge = document.getElementById('cart-badge');
        badge.innerText = cart.length;
        badge.classList.toggle('hidden', cart.length === 0);
    }

    function renderCart() {
        const container = document.getElementById('cart-items');
        
        if (cart.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:var(--hint-color); margin-top:40px; font-size:16px">üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
            document.getElementById('cart-total').innerText = '0';
            return;
        }

        let total = 0;
        container.innerHTML = cart.map((item, index) => {
            total += item.price;
            return `
            <div class="cart-item">
                <span>${item.name}</span>
                <span>
                    ${item.price} ‚ÇΩ 
                    <b style="color:#ff4757; cursor:pointer; margin-left:10px; font-size:18px;" onclick="removeFromCart(${index})">√ó</b>
                </span>
            </div>`;
        }).join('');

        document.getElementById('cart-total').innerText = total;
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
        updateBadge();
        if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
    }
</script>

</body>
</html>
