<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Кабинет оператора</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --bg: #1a1a1a;
  --card: #2d2d2d;
  --text: #ffffff;
  --text-muted: #bbbbbb;
  --border: #444444;
  --shadow: rgba(0,0,0,0.3);
  --accent: #00e676; /* по умолчанию зелёный */
}

/* Светлая тема */
[data-theme="light"] {
  --bg: #f8f9fa;
  --card: #ffffff;
  --text: #202020;
  --text-muted: #757575;
  --border: #e0e0e0;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

body {
  background: var(--bg);
  color: var(--text);
  padding: 0;
  min-height: 100vh;
  line-height: 1.5;
}

/* Боковое меню */
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  width: 240px;
  height: 100vh;
  background: var(--card);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  z-index: 100;
  padding: 20px 0;
}
.sidebar-item {
  padding: 12px 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--text-muted);
  transition: all 0.2s;
}
.sidebar-item:hover,
.sidebar-item.active {
  color: var(--accent);
  background: rgba(255, 255, 255, 0.05);
}
.sidebar-item i {
  width: 20px;
  text-align: center;
}
.sidebar-section {
  margin-bottom: 24px;
}
.sidebar-section-title {
  padding: 0 20px 8px;
  font-size: 0.9rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Основной контент */
.main-content {
  margin-left: 240px;
  padding: 20px;
  max-width: 768px;
  margin: 0 auto;
}
.container {
  background: var(--card);
  border-radius: 14px;
  box-shadow: 0 6px 20px var(--shadow);
  overflow: hidden;
  font-size: 15px;
}

/* Header */
.header {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 18px 16px 14px;
  background: var(--card);
  border-bottom: 1px solid var(--border);
}
.avatar {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: #000;
  font-size: 20px;
  flex-shrink: 0;
}
.info h2 {
  font-size: 1.3rem;
  font-weight: 600;
  margin-bottom: 4px;
}
.info p {
  font-size: 1rem;
  color: var(--text-muted);
}

/* Plan Box */
.plan-box {
  padding: 18px 16px;
  background: var(--card);
  margin: 16px;
  border-radius: 12px;
  border: 1px solid var(--border);
}
.plan-title {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--accent);
}
.progress-container {
  height: 16px;
  background: #444444;
  border-radius: 8px;
  overflow: hidden;
  margin: 8px 0;
  border: 1px solid #555555;
}
.progress-fill {
  height: 100%;
  border-radius: 8px;
  transition: width 0.4s ease;
  background: var(--accent);
}
.progress-text {
  display: flex;
  justify-content: space-between;
  font-size: 0.95rem;
  font-weight: 500;
  margin-top: 6px;
}
.shift-status {
  font-size: 0.9rem;
  color: var(--text-muted);
  margin-top: 6px;
  font-style: italic;
}

/* Section title */
.section-title {
  font-size: 1.2rem;
  font-weight: 600;
  margin: 20px 0 14px;
  padding: 0 16px;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--accent);
}

/* Form */
.form-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 14px;
  padding: 0 16px 16px;
}
@media (min-width: 600px) {
  .form-grid {
    grid-template-columns: 1fr 1fr;
  }
}
.form-group {
  margin: 0;
}
.label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  font-size: 0.9rem;
  color: var(--text);
}
input, select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  background: var(--card);
  color: var(--text);
  transition: all 0.2s;
}
input:focus, select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(0, 230, 118, 0.3);
}

/* Buttons */
.btn-row {
  display: flex;
  gap: 10px;
  padding: 0 16px 16px;
  flex-wrap: wrap;
}
button {
  flex: 1;
  min-width: 120px;
  border: none;
  border-radius: 8px;
  padding: 11px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  background: white;
  color: var(--text-inverse, #12161A);
  transition: background 0.2s;
}
button:hover {
  background: #f5f5f5;
}
.btn-accent {
  background: var(--accent);
  color: white;
}
.btn-accent:hover {
  opacity: 0.9;
}
.btn-outline {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
}
.btn-outline:hover {
  border-color: var(--accent);
  color: var(--accent);
}

/* Action buttons in table */
.btn-action {
  width: 32px;
  height: 32px;
  min-width: auto;
  padding: 0;
  border: none;
  border-radius: 6px;
  background: var(--card);
  color: var(--text);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.2s;
}
.btn-action:hover {
  background: rgba(255, 255, 255, 0.1);
}
.btn-action i {
  font-size: 14px;
}

/* Orders list */
.date-label, .preorders-label {
  font-weight: 600;
  color: var(--accent);
  margin: 16px 0 12px;
  padding: 0 16px;
  display: block;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  margin: 0 16px 16px;
}
th {
  background: var(--card);
  padding: 10px 8px;
  text-align: left;
  font-weight: 600;
  border-bottom: 1px solid var(--border);
  color: var(--accent);
}
td {
  padding: 10px 8px;
  border-bottom: 1px solid var(--border);
  color: var(--text);
}
.amount {
  font-weight: 600;
  color: var(--accent);
}
.empty-msg {
  text-align: center;
  color: var(--text-muted);
  padding: 20px 16px;
  font-style: italic;
}
.hint {
  text-align: center;
  margin: 20px 16px;
  padding: 12px;
  color: var(--text-muted);
  font-size: 13px;
  border: 1px dashed var(--border);
  border-radius: 8px;
  background: var(--card);
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}
.modal.active {
  display: flex;
}
.modal-content {
  background: var(--card);
  padding: 24px;
  border-radius: 12px;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  border: 1px solid var(--border);
}
.modal-title {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--accent);
}
.modal-row {
  margin-bottom: 16px;
}
.modal-buttons {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}
.details-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}
.details-label {
  font-weight: 600;
  color: var(--text);
}
.details-value {
  color: var(--accent);
}

/* Скрытие контента по умолчанию */
.content-block {
  display: none;
}
.content-block.active {
  display: block;
}
</style>
</head>
<body>
<!-- Боковое меню -->
<div class="sidebar">
  <div class="sidebar-section">
    <div class="sidebar-item active" data-target="main">
      <i class="fas fa-home"></i> Основное
    </div>
    <div class="sidebar-item" data-target="preorders">
      <i class="fas fa-clock"></i> Предзаказы
    </div>
    <div class="sidebar-item" data-target="tips">
      <i class="fas fa-mug-hot"></i> Чаевые
    </div>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-item" id="themeToggle">
      <i class="fas fa-moon"></i> Тема: Тёмная
    </div>
    <div class="sidebar-item">
      <i class="fas fa-palette"></i> Цветовая схема
      <select id="colorScheme" style="margin-left: auto; width: 120px; background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; color: var(--text);">
        <option value="green">Зелёный</option>
        <option value="blue">Синий</option>
        <option value="yellow">Жёлтый</option>
        <option value="red">Красный</option>
        <option value="black">Чёрный</option>
      </select>
    </div>
  </div>
</div>

<!-- Основной контент -->
<div class="main-content">
  <div class="container">
    <!-- Main Tab -->
    <div id="main" class="content-block active">
      <!-- Header -->
      <div class="header">
        <div class="avatar"><i class="fas fa-user"></i></div>
        <div class="info">
          <h2>Оператор №<span id="opId">1</span></h2>
          <p>Всего: <b><span id="totalAll">0.00</span> ₽</b></p>
        </div>
      </div>

      <!-- Plan Box -->
      <div class="plan-box">
        <div class="plan-title">
          <i class="fas fa-bullseye"></i> План: <b>3000 ₽</b>
        </div>
        <div class="progress-container">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text">
          <span>Текущая смена:</span>
          <span><b><span id="todayEarned">0.00</span> ₽</b></span>
        </div>
        <div class="shift-status" id="shiftStatus">Смена не начата</div>
      </div>

      <!-- Shift Controls -->
      <div class="btn-row">
        <button class="btn-accent" onclick="startShift()">
          <i class="fas fa-play"></i> Начать смену
        </button>
        <button class="btn-accent" onclick="endShift()">
          <i class="fas fa-stop"></i> Завершить смену
        </button>
      </div>

      <!-- Create Order -->
      <div class="section-title">
        <i class="fas fa-plus"></i> Новый заказ
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label class="label">№ заказа</label>
          <input type="text" id="orderNum" placeholder="Напр.: ORD-001" required>
        </div>
        <div class="form-group">
          <label class="label">Тариф</label>
          <select id="tariff">
            <option value="RASPIL_M2">Распил — 65 ₽/м²</option>
            <option value="LINEAR_RASPIL">Лин. распил — 26 ₽/м</option>
            <option value="SKLEIKA_OB">Склейка + — 210 ₽/м²</option>
            <option value="SKLEIKA_NO_OB">Склейка – — 165 ₽/м²</option>
            <option value="PAZY">Пазы — 30 ₽/м</option>
            <option value="FREZER_FASKA">Фаска — 16 ₽/м</option>
            <option value="TIME">Время — 330 ₽/ч</option>
          </select>
        </div>
        <div class="form-group">
          <label class="label">Деталь</label>
          <input type="text" id="detail" placeholder="Название">
        </div>
        <div class="form-group">
          <label class="label">Кол-во</label>
          <input type="number" id="qty" value="1" min="1">
        </div>
        <div class="form-group" id="lengthGroup">
          <label class="label">Длина (м)</label>
          <input type="number" step="0.01" id="length" placeholder="0.00">
        </div>
        <div class="form-group hidden" id="widthGroup">
          <label class="label">Ширина (м)</label>
          <input type="number" step="0.01" id="width" placeholder="0.00">
        </div>
        <div class="form-group hidden" id="hoursGroup">
          <label class="label">Часы</label>
          <input type="number" step="0.1" id="hours" placeholder="0.0">
        </div>
      </div>

      <div class="btn-row">
        <button class="btn-accent" onclick="createMainOrder()">
          <i class="fas fa-check"></i> Создать заказ
        </button>
      </div>

      <!-- View Orders by Date -->
      <div class="section-title">
        <i class="fas fa-history"></i> Заказы по дате
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label class="label">Дата</label>
          <input type="date" id="viewDate" value="">
        </div>
      </div>
      <div class="btn-row">
        <button class="btn-accent" onclick="showOrdersByDate()">
          <i class="fas fa-eye"></i> Показать
        </button>
        <button class="btn-outline" onclick="saveOrdersToFile()">
          <i class="fas fa-download"></i> В TXT
        </button>
        <button class="btn-outline" onclick="saveOrdersToJSON()">
          <i class="fas fa-file-code"></i> В JSON
        </button>
      </div>
      <div id="ordersList"></div>
    </div>

    <!-- Preorders Tab -->
    <div id="preorders" class="content-block">
      <div class="section-title">
        <i class="fas fa-clock"></i> Предзаказы
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label class="label">№ заказа</label>
          <input type="text" id="preOrderNum" placeholder="Напр.: PRE-001" required>
        </div>
        <div class="form-group">
          <label class="label">Тариф</label>
          <select id="preTariff">
            <option value="RASPIL_M2">Распил — 65 ₽/м²</option>
            <option value="LINEAR_RASPIL">Лин. распил — 26 ₽/м</option>
            <option value="SKLEIKA_OB">Склейка + — 210 ₽/м²</option>
            <option value="SKLEIKA_NO_OB">Склейка – — 165 ₽/м²</option>
            <option value="PAZY">Пазы — 30 ₽/м</option>
            <option value="FREZER_FASKA">Фаска — 16 ₽/м</option>
            <option value="TIME">Время — 330 ₽/ч</option>
          </select>
        </div>
        <div class="form-group">
          <label class="label">Деталь</label>
          <input type="text" id="preDetail" placeholder="Название">
        </div>
        <div class="form-group">
          <label class="label">Кол-во</label>
          <input type="number" id="preQty" value="1" min="1">
        </div>
        <div class="form-group" id="preLengthGroup">
          <label class="label">Длина (м)</label>
          <input type="number" step="0.01" id="preLength" placeholder="0.00">
        </div>
        <div class="form-group hidden" id="preWidthGroup">
          <label class="label">Ширина (м)</label>
          <input type="number" step="0.01" id="preWidth" placeholder="0.00">
        </div>
        <div class="form-group hidden" id="preHoursGroup">
          <label class="label">Часы</label>
          <input type="number" step="0.1" id="preHours" placeholder="0.0">
        </div>
      </div>
      <div class="btn-row">
        <button class="btn-accent" onclick="createPreorder()">
          <i class="fas fa-save"></i> Сохранить предзаказ
        </button>
        <button class="btn-outline" onclick="document.getElementById('jsonImportInput').click()">
          <i class="fas fa-upload"></i> Загрузить TXT/JSON
        </button>
      </div>
      <input type="file" id="jsonImportInput" accept=".txt,.json" style="display: none;" />
      <div class="preorders-label">Список предзаказов</div>
      <div id="preordersList"></div>
    </div>

    <!-- Tips Tab -->
    <div id="tips" class="content-block">
      <div class="section-title">
        <i class="fas fa-mug-hot"></i> Чаевые
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label class="label">Сумма чаевых (₽)</label>
          <input type="number" id="tipAmount" placeholder="Напр.: 300" min="0" step="1">
        </div>
      </div>
      <div class="btn-row">
        <button class="btn-accent" onclick="addTip()">
          <i class="fas fa-plus"></i> Добавить чаевые
        </button>
      </div>
      <div style="padding: 0 16px 16px;">
        <div class="plan-box" style="margin: 16px 0;">
          <div class="plan-title">
            <span>Всего пакетиков</span>
            <span><b><span id="totalPacketsCount">0</span> шт</b></span>
          </div>
          <div class="progress-container">
            <div class="progress-fill" id="totalPacketsFill"></div>
          </div>
          <div class="progress-text">
            <span>Накоплено</span>
            <span><b><span id="totalPacketsProgress">0%</span></b></span>
          </div>
        </div>
        <div class="plan-box" style="margin: 16px 0;">
          <div class="plan-title">
            <span>Сегодня</span>
            <span><b><span id="todayPacketsCount">0</span> шт</b></span>
          </div>
          <div class="progress-container">
            <div class="progress-fill" id="todayPacketsFill"></div>
          </div>
          <div class="progress-text">
            <span>За сегодня</span>
            <span><b><span id="todayPacketsProgress">0%</span></b></span>
          </div>
        </div>
        <div class="plan-box" style="margin: 16px 0;">
          <div class="plan-title">
            <span>Выпито чая</span>
            <span><b><span id="teaLiters">0.0</span> л</b></span>
          </div>
          <div class="progress-text" style="margin-top: 10px;">
            <span>1 пакетик = 200 мл</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-title">Редактировать заказ</div>
    <input type="hidden" id="editOrderId">
    <div class="modal-row">
      <label>№ заказа</label>
      <input type="text" id="editOrderNum">
    </div>
    <div class="modal-row">
      <label>Деталь</label>
      <input type="text" id="editDetail">
    </div>
    <div class="modal-row">
      <label>Тариф</label>
      <select id="editTariff">
        <option value="RASPIL_M2">Распил — 65 ₽/м²</option>
        <option value="LINEAR_RASPIL">Лин. распил — 26 ₽/м</option>
        <option value="SKLEIKA_OB">Склейка + — 210 ₽/м²</option>
        <option value="SKLEIKA_NO_OB">Склейка – — 165 ₽/м²</option>
        <option value="PAZY">Пазы — 30 ₽/м</option>
        <option value="FREZER_FASKA">Фаска — 16 ₽/м</option>
        <option value="TIME">Время — 330 ₽/ч</option>
      </select>
    </div>
    <div class="modal-row">
      <label>Кол-во</label>
      <input type="number" id="editQty" min="1">
    </div>
    <div class="modal-row" id="editLengthGroup">
      <label>Длина (м)</label>
      <input type="number" step="0.01" id="editLength">
    </div>
    <div class="modal-row hidden" id="editWidthGroup">
      <label>Ширина (м)</label>
      <input type="number" step="0.01" id="editWidth">
    </div>
    <div class="modal-row hidden" id="editHoursGroup">
      <label>Часы</label>
      <input type="number" step="0.1" id="editHours">
    </div>
    <div class="modal-buttons">
      <button class="btn-outline" onclick="closeEditModal()">Отмена</button>
      <button class="btn-accent" onclick="saveEditedOrder()">Сохранить</button>
    </div>
  </div>
</div>

<div id="dateModal" class="modal">
  <div class="modal-content">
    <div class="modal-title">Выберите дату для заказа</div>
    <div class="modal-row">
      <label>Дата</label>
      <input type="date" id="modalDate">
    </div>
    <div class="modal-buttons">
      <button class="btn-outline" onclick="closeDateModal()">Отмена</button>
      <button class="btn-accent" onclick="confirmDateSelection()">Подтвердить</button>
    </div>
  </div>
</div>

<div id="detailsModal" class="modal">
  <div class="modal-content">
    <div class="modal-title">Детали заказа</div>
    <div id="detailsContent"></div>
    <div class="modal-buttons">
      <button class="btn-outline" onclick="closeDetailsModal()">Закрыть</button>
    </div>
  </div>
</div>

<script>
// === Константы ===
const TARIFFS = {
  RASPIL_M2: { price: 65, unit: 'm2' },
  LINEAR_RASPIL: { price: 26, unit: 'linear' },
  SKLEIKA_OB: { price: 210, unit: 'm2' },
  SKLEIKA_NO_OB: { price: 165, unit: 'm2' },
  PAZY: { price: 30, unit: 'linear' },
  FREZER_FASKA: { price: 16, unit: 'linear' },
  TIME: { price: 330, unit: 'time' }
};
const TARIFF_NAMES = {
  RASPIL_M2: 'Распил',
  LINEAR_RASPIL: 'Лин. распил',
  SKLEIKA_OB: 'Склейка +',
  SKLEIKA_NO_OB: 'Склейка –',
  PAZY: 'Пазы',
  FREZER_FASKA: 'Фаска',
  TIME: 'Время'
};
const UNIT_LABELS = {
  m2: 'м²',
  linear: 'пог. м',
  time: 'часы'
};

// === Цветовые схемы ===
const COLOR_MAP = {
  green: '#00e676',
  blue: '#2979ff',
  yellow: '#ffeb3b',
  red: '#ff5252',
  black: '#000000'
};

// === Утилиты ===
function formatDateYMD(dateStr) {
  const [y, m, d] = dateStr.split('-');
  return `${d}.${m}.${y}`;
}
function todayYMD() {
  return new Date().toISOString().split('T')[0];
}
function loadOrders() {
  try {
    return JSON.parse(localStorage.getItem('operator_orders') || '[]');
  } catch (e) { return []; }
}
function saveOrders(orders) {
  localStorage.setItem('operator_orders', JSON.stringify(orders));
}
function loadPreorders() {
  try {
    return JSON.parse(localStorage.getItem('operator_preorders') || '[]');
  } catch (e) { return []; }
}
function savePreorders(preorders) {
  localStorage.setItem('operator_preorders', JSON.stringify(preorders));
}
function getCurrentShift() {
  try {
    return JSON.parse(localStorage.getItem('current_shift') || 'null');
  } catch (e) { return null; }
}
function setCurrentShift(shift) {
  if (shift === null) {
    localStorage.removeItem('current_shift');
  } else {
    localStorage.setItem('current_shift', JSON.stringify(shift));
  }
}

// === Чаевые ===
function loadTipsData() {
  try {
    return JSON.parse(localStorage.getItem('tea_tips_data') || '{}');
  } catch (e) {
    return {};
  }
}
function saveTipsData(data) {
  localStorage.setItem('tea_tips_data', JSON.stringify(data));
}
function updateTipsUI() {
  const data = loadTipsData();
  const today = todayYMD();
  const totalPackets = data.totalPackets || 0;
  const todayPackets = (data.daily && data.daily[today]) || 0;
  const teaLiters = (totalPackets * 0.2).toFixed(1);

  document.getElementById('totalPacketsCount').textContent = totalPackets;
  document.getElementById('todayPacketsCount').textContent = todayPackets;
  document.getElementById('teaLiters').textContent = teaLiters;

  const totalProgress = Math.min(100, totalPackets / 1000 * 100);
  const todayProgress = Math.min(100, todayPackets / 200 * 100);
  document.getElementById('totalPacketsFill').style.width = `${totalProgress}%`;
  document.getElementById('todayPacketsFill').style.width = `${todayProgress}%`;
  document.getElementById('totalPacketsProgress').textContent = `${Math.round(totalProgress)}%`;
  document.getElementById('todayPacketsProgress').textContent = `${Math.round(todayProgress)}%`;
}
function addTip() {
  const input = document.getElementById('tipAmount');
  const value = parseFloat(input.value);
  if (!value || value <= 0) {
    alert('Введите сумму чаевых (больше 0)');
    return;
  }
  const packets = Math.floor(value);
  const today = todayYMD();
  const data = loadTipsData();
  data.totalPackets = (data.totalPackets || 0) + packets;
  data.daily = data.daily || {};
  data.daily[today] = (data.daily[today] || 0) + packets;
  saveTipsData(data);
  input.value = '';
  updateTipsUI();
  alert(`✅ Добавлено ${packets} чайных пакетиков!`);
}

// === Расчёт суммы ===
function calculateAmount(tariffKey, length, width, hours, qty) {
  const tariff = TARIFFS[tariffKey];
  if (!tariff) return 0;
  let amount = 0;
  if (tariff.unit === 'time') {
    amount = tariff.price * hours * qty;
  } else if (tariff.unit === 'm2') {
    amount = tariff.price * length * width * qty;
  } else {
    amount = tariff.price * length * qty;
  }
  return Math.round(amount * 100) / 100;
}

// === Обновление UI плана ===
function updateUI() {
  const orders = loadOrders();
  const totalAll = orders.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
  const shift = getCurrentShift();
  let currentShiftAmount = 0;
  let progressWidth = 0;
  let statusText = 'Смена не начата';

  if (shift && shift.active) {
    currentShiftAmount = orders
      .filter(o => o.shiftId === shift.id)
      .reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
    progressWidth = Math.min(100, (currentShiftAmount / 3000) * 100);
    statusText = 'Смена активна';
  } else if (shift && !shift.active) {
    currentShiftAmount = shift.finalAmount || 0;
    progressWidth = Math.min(100, (currentShiftAmount / 3000) * 100);
    statusText = 'Смена завершена';
  }

  document.getElementById('totalAll').textContent = totalAll.toFixed(2);
  document.getElementById('todayEarned').textContent = currentShiftAmount.toFixed(2);
  document.getElementById('progressFill').style.width = `${progressWidth}%`;
  document.getElementById('shiftStatus').textContent = statusText;
}

// === Переключение полей ===
function updateMainFormFields() {
  const tariff = document.getElementById('tariff').value;
  ['widthGroup', 'hoursGroup'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
  document.getElementById('lengthGroup')?.classList.remove('hidden');
  if (['RASPIL_M2', 'SKLEIKA_OB', 'SKLEIKA_NO_OB'].includes(tariff)) {
    document.getElementById('widthGroup')?.classList.remove('hidden');
  } else if (tariff === 'TIME') {
    document.getElementById('lengthGroup')?.classList.add('hidden');
    document.getElementById('hoursGroup')?.classList.remove('hidden');
  }
}
function updatePreorderFormFields() {
  const tariff = document.getElementById('preTariff').value;
  ['preWidthGroup', 'preHoursGroup'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
  document.getElementById('preLengthGroup')?.classList.remove('hidden');
  if (['RASPIL_M2', 'SKLEIKA_OB', 'SKLEIKA_NO_OB'].includes(tariff)) {
    document.getElementById('preWidthGroup')?.classList.remove('hidden');
  } else if (tariff === 'TIME') {
    document.getElementById('preLengthGroup')?.classList.add('hidden');
    document.getElementById('preHoursGroup')?.classList.remove('hidden');
  }
}
function updateEditFormFields() {
  const tariff = document.getElementById('editTariff').value;
  ['editWidthGroup', 'editHoursGroup'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
  document.getElementById('editLengthGroup')?.classList.remove('hidden');
  if (['RASPIL_M2', 'SKLEIKA_OB', 'SKLEIKA_NO_OB'].includes(tariff)) {
    document.getElementById('editWidthGroup')?.classList.remove('hidden');
  } else if (tariff === 'TIME') {
    document.getElementById('editLengthGroup')?.classList.add('hidden');
    document.getElementById('editHoursGroup')?.classList.remove('hidden');
  }
}

// === Боковое меню ===
document.querySelectorAll('.sidebar-item[data-target]').forEach(item => {
  item.addEventListener('click', () => {
    // Снять активность
    document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
    document.querySelectorAll('.content-block').forEach(c => c.classList.remove('active'));
    // Установить активность
    item.classList.add('active');
    const targetId = item.dataset.target;
    document.getElementById(targetId).classList.add('active');
  });
});

// === Тема и цвет ===
const themeToggle = document.getElementById('themeToggle');
const colorSelect = document.getElementById('colorScheme');

// Загрузить из localStorage
let savedTheme = localStorage.getItem('theme') || 'dark';
let savedColor = localStorage.getItem('accentColor') || 'green';
document.documentElement.setAttribute('data-theme', savedTheme);
document.documentElement.style.setProperty('--accent', COLOR_MAP[savedColor]);
colorSelect.value = savedColor;

// Обновить UI при загрузке
if (savedTheme === 'light') {
  themeToggle.innerHTML = '<i class="fas fa-sun"></i> Тема: Светлая';
} else {
  themeToggle.innerHTML = '<i class="fas fa-moon"></i> Тема: Тёмная';
}

themeToggle.addEventListener('click', () => {
  const current = document.documentElement.getAttribute('data-theme');
  const newTheme = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  themeToggle.innerHTML = newTheme === 'dark' 
    ? '<i class="fas fa-moon"></i> Тема: Тёмная' 
    : '<i class="fas fa-sun"></i> Тема: Светлая';
});

colorSelect.addEventListener('change', (e) => {
  const color = e.target.value;
  document.documentElement.style.setProperty('--accent', COLOR_MAP[color]);
  localStorage.setItem('accentColor', color);
});

// === Смена ===
function startShift() {
  const shift = getCurrentShift();
  if (shift && shift.active) {
    alert('Смена уже активна!');
    return;
  }
  const newShift = { id: Date.now(), startedAt: new Date().toISOString(), active: true };
  setCurrentShift(newShift);
  alert('✅ Смена начата!');
  updateUI();
}
function endShift() {
  const shift = getCurrentShift();
  if (!shift || !shift.active) {
    alert('Нет активной смены для завершения!');
    return;
  }
  const orders = loadOrders();
  const finalAmount = orders
    .filter(o => o.shiftId === shift.id)
    .reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
  shift.active = false;
  shift.finishedAt = new Date().toISOString();
  shift.finalAmount = finalAmount;
  setCurrentShift(shift);
  alert(`✅ Смена завершена!\nЗаработано: ${finalAmount.toFixed(2)} ₽`);
  updateUI();
}

// === Удаление ===
function deleteOrder(orderId) {
  if (!confirm('Удалить заказ?')) return;
  const orders = loadOrders();
  const idx = orders.findIndex(o => o.id === orderId);
  if (idx === -1) return;
  orders.splice(idx, 1);
  saveOrders(orders);
  const shift = getCurrentShift();
  if (shift && shift.active) updateUI();
  showOrdersByDate();
  alert('✅ Заказ удалён!');
}
function deletePreorder(preorderId) {
  if (!confirm('Удалить предзаказ?')) return;
  const preorders = loadPreorders();
  const idx = preorders.findIndex(p => p.id === preorderId);
  if (idx === -1) return;
  preorders.splice(idx, 1);
  savePreorders(preorders);
  renderPreorders();
  alert('✅ Предзаказ удалён!');
}

// === Модальные окна ===
let pendingPreorderId = null;
function openDateModal(preorderId) {
  pendingPreorderId = preorderId;
  document.getElementById('modalDate').value = todayYMD();
  document.getElementById('dateModal').classList.add('active');
}
function closeDateModal() {
  document.getElementById('dateModal').classList.remove('active');
  pendingPreorderId = null;
}
function confirmDateSelection() {
  const date = document.getElementById('modalDate').value;
  if (!date) { alert('Выберите дату'); return; }
  if (pendingPreorderId !== null) acceptPreorder(pendingPreorderId, date);
  closeDateModal();
}
function viewOrderDetails(orderId) {
  const orders = loadOrders();
  const order = orders.find(o => o.id === orderId);
  if (!order) return;
  const units = calculateUnits(order.tariff, order.length, order.width, order.hours, order.qty);
  const tariffName = TARIFF_NAMES[order.tariff] || order.tariff;
  let html = '';
  html += `<div class="details-item"><span class="details-label">№ заказа:</span><span class="details-value">${order.orderNumber}</span></div>`;
  html += `<div class="details-item"><span class="details-label">Деталь:</span><span class="details-value">${order.detail}</span></div>`;
  html += `<div class="details-item"><span class="details-label">Тариф:</span><span class="details-value">${tariffName}</span></div>`;
  html += `<div class="details-item"><span class="details-label">Количество:</span><span class="details-value">${order.qty}</span></div>`;
  if (order.length !== null) html += `<div class="details-item"><span class="details-label">Длина:</span><span class="details-value">${order.length} м</span></div>`;
  if (order.width !== null) html += `<div class="details-item"><span class="details-label">Ширина:</span><span class="details-value">${order.width} м</span></div>`;
  if (order.hours !== null) html += `<div class="details-item"><span class="details-label">Часы:</span><span class="details-value">${order.hours} ч</span></div>`;
  html += `<div class="details-item"><span class="details-label">Объем работ:</span><span class="details-value">${units.value} ${units.unit}</span></div>`;
  html += `<div class="details-item"><span class="details-label">Сумма:</span><span class="details-value">${order.amount.toFixed(2)} ₽</span></div>`;
  document.getElementById('detailsContent').innerHTML = html;
  document.getElementById('detailsModal').classList.add('active');
}
function closeDetailsModal() {
  document.getElementById('detailsModal').classList.remove('active');
}
function openEditModal(orderId) {
  const orders = loadOrders();
  const order = orders.find(o => o.id === orderId);
  if (!order) return;
  editingOrder = order;
  document.getElementById('editOrderId').value = order.id;
  document.getElementById('editOrderNum').value = order.orderNumber;
  document.getElementById('editDetail').value = order.detail;
  document.getElementById('editTariff').value = order.tariff;
  document.getElementById('editQty').value = order.qty;
  document.getElementById('editLength').value = order.length || '';
  document.getElementById('editWidth').value = order.width || '';
  document.getElementById('editHours').value = order.hours || '';
  updateEditFormFields();
  document.getElementById('editModal').classList.add('active');
}
let editingOrder = null;
function closeEditModal() {
  document.getElementById('editModal').classList.remove('active');
  editingOrder = null;
}
function saveEditedOrder() {
  if (!editingOrder) return;
  const orderId = parseInt(document.getElementById('editOrderId').value);
  const num = document.getElementById('editOrderNum').value.trim();
  if (!num) { alert('Укажите № заказа'); return; }
  const tariffKey = document.getElementById('editTariff').value;
  const detail = document.getElementById('editDetail').value.trim() || '—';
  const qty = parseInt(document.getElementById('editQty').value) || 1;
  const length = parseFloat(document.getElementById('editLength').value) || 0;
  const width = parseFloat(document.getElementById('editWidth').value) || 0;
  const hours = parseFloat(document.getElementById('editHours').value) || 0;
  const amount = calculateAmount(tariffKey, length, width, hours, qty);
  const orders = loadOrders();
  const idx = orders.findIndex(o => o.id === orderId);
  if (idx !== -1) {
    orders[idx] = {
      ...orders[idx],
      orderNumber: num,
      tariff: tariffKey,
      detail: detail,
      qty: qty,
      length: length || null,
      width: width || null,
      hours: hours || null,
      amount: amount
    };
    saveOrders(orders);
    updateUI();
    showOrdersByDate();
    closeEditModal();
    alert('✅ Заказ обновлён!');
  }
}

// === Основные функции ===
function createMainOrder() {
  const num = document.getElementById('orderNum').value.trim();
  if (!num) { alert('Укажите № заказа'); return; }
  const tariffKey = document.getElementById('tariff').value;
  const detail = document.getElementById('detail').value.trim() || '—';
  const qty = parseInt(document.getElementById('qty').value) || 1;
  const length = parseFloat(document.getElementById('length').value) || 0;
  const width = parseFloat(document.getElementById('width').value) || 0;
  const hours = parseFloat(document.getElementById('hours').value) || 0;
  const amount = calculateAmount(tariffKey, length, width, hours, qty);
  const shift = getCurrentShift();
  if (!shift || !shift.active) {
    alert('⚠️ Начните смену, чтобы создавать заказы!');
    return;
  }
  const order = {
    id: Date.now(),
    orderNumber: num,
    tariff: tariffKey,
    detail: detail,
    qty: qty,
    length: length || null,
    width: width || null,
    hours: hours || null,
    amount: amount,
    date: todayYMD(),
    shiftId: shift.id,
    timestamp: new Date().toISOString()
  };
  const orders = loadOrders();
  orders.push(order);
  saveOrders(orders);
  updateUI();
  ['orderNum','detail','qty','length','width','hours'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = (id === 'qty') ? '1' : '';
  });
  updateMainFormFields();
}
function createPreorder() {
  const num = document.getElementById('preOrderNum').value.trim();
  if (!num) { alert('Укажите № предзаказа'); return; }
  const tariffKey = document.getElementById('preTariff').value;
  const detail = document.getElementById('preDetail').value.trim() || '—';
  const qty = parseInt(document.getElementById('preQty').value) || 1;
  const length = parseFloat(document.getElementById('preLength').value) || 0;
  const width = parseFloat(document.getElementById('preWidth').value) || 0;
  const hours = parseFloat(document.getElementById('preHours').value) || 0;
  const amount = calculateAmount(tariffKey, length, width, hours, qty);
  const preorder = {
    id: Date.now(),
    orderNumber: num,
    tariff: tariffKey,
    detail: detail,
    qty: qty,
    length: length || null,
    width: width || null,
    hours: hours || null,
    amount: amount,
    date: todayYMD(),
    timestamp: new Date().toISOString()
  };
  const preorders = loadPreorders();
  preorders.push(preorder);
  savePreorders(preorders);
  alert('✅ Предзаказ сохранён!');
  renderPreorders();
  ['preOrderNum','preDetail','preQty','preLength','preWidth','preHours'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = (id === 'preQty') ? '1' : '';
  });
  updatePreorderFormFields();
}
function acceptPreorder(preorderId, selectedDate = null) {
  const preorders = loadPreorders();
  const idx = preorders.findIndex(p => p.id === preorderId);
  if (idx === -1) return;
  const preorder = preorders[idx];
  const shift = getCurrentShift();
  if (!shift || !shift.active) {
    alert('Начните смену, чтобы принять предзаказ!');
    return;
  }
  if (!selectedDate) {
    openDateModal(preorderId);
    return;
  }
  const order = {...preorder, shiftId: shift.id, date: selectedDate};
  const orders = loadOrders();
  orders.push(order);
  saveOrders(orders);
  preorders.splice(idx, 1);
  savePreorders(preorders);
  alert(`✅ Предзаказ "${preorder.orderNumber}" принят на дату ${formatDateYMD(selectedDate)}!`);
  updateUI();
  renderPreorders();
}
function renderPreorders() {
  const preorders = loadPreorders();
  const container = document.getElementById('preordersList');
  if (preorders.length === 0) {
    container.innerHTML = '<div class="empty-msg">Нет предзаказов</div>';
    return;
  }
  let html = `<table><thead><tr><th>№</th><th>Деталь</th><th>Сумма</th><th>Действия</th></tr></thead><tbody>`;
  preorders.forEach(p => {
    html += `
<tr>
<td>${p.orderNumber}</td>
<td>${p.detail}</td>
<td class="amount">${p.amount.toFixed(2)} ₽</td>
<td>
<button class="btn-action" onclick="acceptPreorder(${p.id})"><i class="fas fa-check"></i></button>
<button class="btn-action" onclick="deletePreorder(${p.id})"><i class="fas fa-trash"></i></button>
</td>
</tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}
function showOrdersByDate() {
  const dateInput = document.getElementById('viewDate').value;
  if (!dateInput) { alert('Выберите дату'); return; }
  const orders = loadOrders();
  const filtered = orders.filter(o => o.date === dateInput);
  const formattedDate = formatDateYMD(dateInput);
  let html = `<div class="date-label">Заказы за ${formattedDate}</div>`;
  if (filtered.length === 0) {
    html += '<div class="empty-msg">Нет заказов за эту дату</div>';
  } else {
    html += `<table><thead><tr><th>№</th><th>Деталь</th><th>Сумма</th><th>Действия</th></tr></thead><tbody>`;
    filtered.forEach(o => {
      html += `
<tr>
<td>${o.orderNumber}</td>
<td>${o.detail}</td>
<td class="amount">${o.amount.toFixed(2)} ₽</td>
<td>
<button class="btn-action" onclick="viewOrderDetails(${o.id})"><i class="fas fa-eye"></i></button>
<button class="btn-action" onclick="openEditModal(${o.id})"><i class="fas fa-edit"></i></button>
<button class="btn-action" onclick="deleteOrder(${o.id})"><i class="fas fa-trash"></i></button>
</td>
</tr>`;
    });
    html += '</tbody></table>';
  }
  document.getElementById('ordersList').innerHTML = html;
}
function saveOrdersToFile() {
  const dateInput = document.getElementById('viewDate').value;
  if (!dateInput) { alert('Сначала выберите дату'); return; }
  const orders = loadOrders();
  const filtered = orders.filter(o => o.date === dateInput);
  if (filtered.length === 0) { alert('Нет заказов за эту дату'); return; }
  const formattedDate = formatDateYMD(dateInput);
  let content = `ЗАКАЗЫ ЗА ${formattedDate}\n========================\n`;
  let totalSum = 0;
  filtered.forEach((o, idx) => {
    const tariffName = TARIFF_NAMES[o.tariff] || o.tariff;
    const units = calculateUnits(o.tariff, o.length, o.width, o.hours, o.qty);
    content += `№${idx + 1}. ${o.orderNumber}\n   ${o.detail} (${tariffName})\n`;
    if (o.length) content += `   Длина: ${o.length} м\n`;
    if (o.width) content += `   Ширина: ${o.width} м\n`;
    if (o.hours) content += `   Часы: ${o.hours} ч\n`;
    content += `   Кол-во: ${o.qty}\n   Объем: ${units.value} ${units.unit}\n   Сумма: ${o.amount.toFixed(2)} ₽\n---\n`;
    totalSum += o.amount;
  });
  content += `\nИТОГО: ${totalSum.toFixed(2)} ₽\nЭкспорт: ${new Date().toLocaleString('ru-RU')}`;
  const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
  const blob = new Blob([bom, content], { type: 'text/plain;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `заказы_${formattedDate}.txt`;
  a.click();
  URL.revokeObjectURL(a.href);
}
function saveOrdersToJSON() {
  const dateInput = document.getElementById('viewDate').value;
  if (!dateInput) { alert('Сначала выберите дату'); return; }
  const orders = loadOrders();
  const filtered = orders.filter(o => o.date === dateInput);
  if (filtered.length === 0) { alert('Нет заказов за эту дату'); return; }
  const jsonContent = JSON.stringify(filtered, null, 2);
  const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `заказы_${formatDateYMD(dateInput)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}
function calculateUnits(tariffKey, length, width, hours, qty) {
  const tariff = TARIFFS[tariffKey];
  if (!tariff) return { value: 0, unit: '' };
  let value = 0;
  let unit = tariff.unit;
  if (tariff.unit === 'time') value = hours * qty;
  else if (tariff.unit === 'm2') value = length * width * qty;
  else value = length * qty;
  return { value: Math.round(value * 100) / 100, unit: UNIT_LABELS[unit] || unit };
}

// === Инициализация ===
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('viewDate').value = todayYMD();
  ['tariff','preTariff','editTariff'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', () => {
      if (id === 'tariff') updateMainFormFields();
      else if (id === 'preTariff') updatePreorderFormFields();
      else updateEditFormFields();
    });
  });
  updateUI();
  renderPreorders();
  updateTipsUI();
});
</script>
</body>
</html>
