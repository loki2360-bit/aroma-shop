<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –†–∞—Å–∫—Ä–æ–π</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --border: #cbd5e1;
            --text: #0f172a;
            --danger: #ef4444;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 20px;
        }

        @media (max-width: 1000px) {
            .container { grid-template-columns: 1fr; }
        }

        .panel {
            background: var(--surface);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h2 { margin-top: 0; color: #334155; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #475569; }
        
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        .row { display: flex; gap: 10px; }
        .row > * { flex: 1; }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.2s;
        }
        button:hover { background-color: #1d4ed8; transform: translateY(-1px); }
        
        button.secondary { background-color: #64748b; margin-top: 10px; }
        button.danger { background-color: #fee2e2; color: var(--danger); width: auto; padding: 4px 8px; font-size: 0.8rem; }

        /* Parts List */
        #parts-list {
            margin-top: 20px;
            border: 1px solid var(--border);
            border-radius: 6px;
            max-height: 350px;
            overflow-y: auto;
        }
        .part-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #f1f5f9;
            background: #fff;
        }
        .part-item:last-child { border-bottom: none; }
        .part-info { font-weight: 500; }
        .part-qty { color: #64748b; font-size: 0.9rem; }

        /* Canvas Area */
        .canvas-wrapper {
            overflow: auto;
            border: 2px solid #e2e8f0;
            background: #94a3b8; /* Darker bg to show sheet clearly */
            border-radius: 8px;
            display: flex;
            justify-content: center;
            padding: 20px;
            min-height: 600px;
        }

        canvas {
            background: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .stat-val { font-size: 1.4rem; font-weight: 800; color: var(--primary); display: block; }
        .stat-label { font-size: 0.85rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }

        .alert-box {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

    <h1>üìê –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –†–∞—Å–∫—Ä–æ—è (–ì–∏–ª—å–æ—Ç–∏–Ω–Ω—ã–π)</h1>

    <div class="container">
        <!-- Controls -->
        <div class="panel">
            <h2>1. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–∏—Å—Ç–∞</h2>
            <div class="row">
                <div class="form-group">
                    <label>–®–∏—Ä–∏–Ω–∞ (–º–º)</label>
                    <input type="number" id="sheetW" value="2080">
                </div>
                <div class="form-group">
                    <label>–í—ã—Å–æ—Ç–∞ (–º–º)</label>
                    <input type="number" id="sheetH" value="2070">
                </div>
            </div>
            <div class="form-group">
                <label>–¶–µ–Ω–∞ –ª–∏—Å—Ç–∞ (‚ÇΩ)</label>
                <input type="number" id="sheetPrice" value="6000">
            </div>
            <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 15px;">
                * –û—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—è: 10–º–º, –ü—Ä–æ–ø–∏–ª: 3–º–º
            </div>

            <h2>2. –î–µ—Ç–∞–ª–∏</h2>
            <div id="error-msg" class="alert-box"></div>

            <div class="row">
                <div class="form-group">
                    <label>–®–∏—Ä–∏–Ω–∞</label>
                    <input type="number" id="partW" placeholder="–º–º">
                </div>
                <div class="form-group">
                    <label>–í—ã—Å–æ—Ç–∞</label>
                    <input type="number" id="partH" placeholder="–º–º">
                </div>
            </div>
            <div class="form-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                <input type="number" id="partQty" value="1">
            </div>
            <button onclick="addPart()">–î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å</button>

            <div id="parts-list">
                <!-- List -->
            </div>

            <button onclick="calculateLayout()" style="margin-top: 20px; background-color: #059669;">–†–ê–°–°–ß–ò–¢–ê–¢–¨ –†–ê–°–ö–†–û–ô</button>
            <button class="secondary" onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        </div>

        <!-- Visualization -->
        <div class="panel">
            <h2>–ö–∞—Ä—Ç–∞ —Ä–∞—Å–∫—Ä–æ—è</h2>
            <div class="canvas-wrapper">
                <canvas id="layoutCanvas"></canvas>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-val" id="placedCount">0</span>
                    <span class="stat-label">–†–∞–∑–º–µ—â–µ–Ω–æ</span>
                </div>
                <div class="stat-card">
                    <span class="stat-val" id="usedPercent">0%</span>
                    <span class="stat-label">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</span>
                </div>
                <div class="stat-card">
                    <span class="stat-val" id="costVal">0 ‚ÇΩ</span>
                    <span class="stat-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</span>
                </div>
                <div class="stat-card">
                    <span class="stat-val" id="wasteVal">0%</span>
                    <span class="stat-label">–û—Ç—Ö–æ–¥—ã</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const EDGE_MARGIN = 10; 
        const KERF = 3;
        let parts = [];

        function showError(msg) {
            const el = document.getElementById('error-msg');
            el.innerText = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function addPart() {
            const w = parseInt(document.getElementById('partW').value);
            const h = parseInt(document.getElementById('partH').value);
            const qty = parseInt(document.getElementById('partQty').value);
            
            const sheetW = parseInt(document.getElementById('sheetW').value);
            const sheetH = parseInt(document.getElementById('sheetH').value);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
            const usableW = sheetW - (EDGE_MARGIN * 2);
            const usableH = sheetH - (EDGE_MARGIN * 2);

            if (!w || !h || !qty) {
                showError("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.");
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞: –≤–ª–µ–∑–∞–µ—Ç –ª–∏ –¥–µ—Ç–∞–ª—å —Ö–æ—Ç—è –±—ã —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏
            // –£—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ –¥–µ—Ç–∞–ª—å –º–æ–∂–Ω–æ –ø–æ–≤–µ—Ä–Ω—É—Ç—å, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞
            const fitsNormal = (w <= usableW && h <= usableH);
            const fitsRotated = (h <= usableW && w <= usableH);

            if (!fitsNormal && !fitsRotated) {
                showError(`–î–µ—Ç–∞–ª—å ${w}x${h} –ù–ï –í–õ–ï–ó–ê–ï–¢ –≤ –ø–æ–ª–µ–∑–Ω—É—é –æ–±–ª–∞—Å—Ç—å –ª–∏—Å—Ç–∞ (${usableW}x${usableH})!`);
                return;
            }

            parts.push({ w, h, qty, id: Date.now() + Math.random() });
            renderPartsList();
            
            // –°–±—Ä–æ—Å –ø–æ–ª–µ–π
            document.getElementById('partW').value = '';
            document.getElementById('partH').value = '';
            document.getElementById('partQty').value = '1';
            document.getElementById('partW').focus();
        }

        function removePart(id) {
            parts = parts.filter(p => p.id !== id);
            renderPartsList();
        }

        function clearAll() {
            parts = [];
            renderPartsList();
            const ctx = document.getElementById('layoutCanvas').getContext('2d');
            ctx.clearRect(0, 0, 800, 600);
            document.getElementById('placedCount').innerText = '0';
            document.getElementById('usedPercent').innerText = '0%';
        }

        function renderPartsList() {
            const list = document.getElementById('parts-list');
            list.innerHTML = '';
            if(parts.length === 0) {
                list.innerHTML = '<div style="padding:15px; text-align:center; color:#94a3b8">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
                return;
            }
            parts.forEach(p => {
                const div = document.createElement('div');
                div.className = 'part-item';
                div.innerHTML = `
                    <div>
                        <div class="part-info">${p.w} √ó ${p.h} –º–º</div>
                        <div class="part-qty">${p.qty} —à—Ç.</div>
                    </div>
                    <button class="danger" onclick="removePart(${p.id})">–£–¥–∞–ª–∏—Ç—å</button>
                `;
                list.appendChild(div);
            });
        }

        // --- –ì–£–õ–¨–û–¢–ò–ù–ù–´–ô –ê–õ–ì–û–†–ò–¢–ú (Guillotine Packing) ---
        
        class GuillotinePacker {
            constructor(w, h) {
                this.root = { x: 0, y: 0, w: w, h: h };
            }

            fit(blocks) {
                let n, node, block;
                for (n = 0; n < blocks.length; n++) {
                    block = blocks[n];
                    if (node = this.findNode(this.root, block.w, block.h))
                        block.fit = this.splitNode(node, block.w, block.h);
                    else 
                        block.fit = this.growDown(block.w, block.h);
                }
            }

            findNode(root, w, h) {
                if (root.used)
                    return this.findNode(root.right, w, h) || this.findNode(root.down, w, h);
                else if ((w <= root.w) && (h <= root.h))
                    return root;
                else
                    return null;
            }

            splitNode(node, w, h) {
                node.used = true;
                // –õ–æ–≥–∏–∫–∞ —Ä–∞–∑—Ä–µ–∑–∞: –æ—Ç—Ä–µ–∑–∞–µ–º —Å–ø—Ä–∞–≤–∞ –∏ —Å–Ω–∏–∑—É
                // –û—Å—Ç–∞—Ç–æ–∫ —Å–ø—Ä–∞–≤–∞
                node.down  = { x: node.x,         y: node.y + h + KERF, w: node.w,         h: node.h - h - KERF };
                // –û—Å—Ç–∞—Ç–æ–∫ —Å–Ω–∏–∑—É (–ø–æ–¥ –¥–µ—Ç–∞–ª—å—é)
                node.right = { x: node.x + w + KERF, y: node.y,         w: node.w - w - KERF, h: h };
                return node;
            }

            growDown(w, h) {
                // –ï—Å–ª–∏ –Ω–µ –≤–ª–µ–∑–ª–æ –≤ —Ç–µ–∫—É—â–∏–µ —Å–≤–æ–±–æ–¥–Ω—ã–µ –±–ª–æ–∫–∏, –ø—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å—à–∏—Ä–∏—Ç—å (–≤ –¥–∞–Ω–Ω–æ–º –ø—Ä–æ—Å—Ç–æ–º –≤–∞—Ä–∏–∞–Ω—Ç–µ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null, 
                // —Ç–∞–∫ –∫–∞–∫ —Ä–∞–∑–º–µ—Ä –ª–∏—Å—Ç–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω).
                // –í —Å–ª–æ–∂–Ω—ã—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–∞—Ö –∑–¥–µ—Å—å –ª–∏—Å—Ç —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç, –Ω–æ –Ω–∞–º —ç—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ.
                return null; 
            }
        }

        function calculateLayout() {
            const sheetW = parseInt(document.getElementById('sheetW').value);
            const sheetH = parseInt(document.getElementById('sheetH').value);
            const price = parseFloat(document.getElementById('sheetPrice').value) || 0;

            const usableW = sheetW - (EDGE_MARGIN * 2);
            const usableH = sheetH - (EDGE_MARGIN * 2);

            // 1. –°–æ–∑–¥–∞–µ–º –ø–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–µ—Ç–∞–ª–µ–π
            let allParts = [];
            parts.forEach(p => {
                for(let i=0; i<p.qty; i++) {
                    allParts.push({ 
                        w: p.w, h: p.h, 
                        originalId: p.id,
                        index: i + 1,
                        totalQty: p.qty
                    });
                }
            });

            // 2. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –°–Ω–∞—á–∞–ª–∞ –±–æ–ª—å—à–∏–µ –ø–ª–æ—â–∞–¥–∏ (Best Fit Decreasing)
            // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏
            allParts.sort((a, b) => (b.w * b.h) - (a.w * a.h));

            // 3. –ó–∞–ø—É—Å–∫ —É–ø–∞–∫–æ–≤—â–∏–∫–∞
            // –ú—ã —Ä–∞–±–æ—Ç–∞–µ–º –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö "–≤–Ω—É—Ç—Ä–∏ margins", —Ç.–µ. –æ—Ç 0 –¥–æ usableW
            const packer = new GuillotinePacker(usableW, usableH);
            packer.fit(allParts);

            // 4. –°–±–æ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            let placed = [];
            let notPlaced = [];

            allParts.forEach(p => {
                if (p.fit) {
                    // p.fit —Å–æ–¥–µ—Ä–∂–∏—Ç {x, y, w, h, used: true}
                    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã p.fit.x/y –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ (–≤–Ω—É—Ç—Ä–∏ margins). 
                    // –ü—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ –¥–æ–±–∞–≤–∏–º EDGE_MARGIN.
                    placed.push({
                        x: p.fit.x + EDGE_MARGIN,
                        y: p.fit.y + EDGE_MARGIN,
                        w: p.w,
                        h: p.h,
                        num: p.index,
                        total: p.totalQty
                    });
                } else {
                    notPlaced.push(p);
                }
            });

            if (notPlaced.length > 0) {
                alert(`–í–Ω–∏–º–∞–Ω–∏–µ! –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å ${notPlaced.length} –¥–µ—Ç–∞–ª–µ–π –∏–∑-–∑–∞ –Ω–µ—Ö–≤–∞—Ç–∫–∏ –º–µ—Å—Ç–∞.`);
            }

            drawCanvas(sheetW, sheetH, placed);
            updateStats(placed, allParts.length, sheetW, sheetH, price);
        }

        function drawCanvas(sheetW, sheetH, items) {
            const canvas = document.getElementById('layoutCanvas');
            const ctx = canvas.getContext('2d');

            // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —ç–∫—Ä–∞–Ω–∞
            const maxWidth = 1000;
            const scale = Math.min(maxWidth / sheetW, 1);

            canvas.width = sheetW * scale;
            canvas.height = sheetH * scale;

            // –§–æ–Ω
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –ì—Ä–∞–Ω–∏—Ü—ã –ª–∏—Å—Ç–∞
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 3;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);

            // –ó–æ–Ω–∞ –æ—Ç—Å—Ç—É–ø–æ–≤ (–≤–∏–∑—É–∞–ª—å–Ω–æ –∑–∞—Ç–µ–º–Ω—è–µ–º –∫—Ä–∞—è)
            ctx.fillStyle = "rgba(0,0,0,0.05)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –û—á–∏—â–∞–µ–º —Ä–∞–±–æ—á—É—é –∑–æ–Ω—É (—á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ, —á—Ç–æ —Ç–∞–º –º–æ–∂–Ω–æ —Ä–µ–∑–∞—Ç—å)
            ctx.clearRect(EDGE_MARGIN * scale, EDGE_MARGIN * scale, (sheetW - EDGE_MARGIN*2) * scale, (sheetH - EDGE_MARGIN*2) * scale);
            
            // –†–∏—Å—É–µ–º —Ä–∞–º–∫—É —Ä–∞–±–æ—á–µ–π –∑–æ–Ω—ã
            ctx.strokeStyle = "#cbd5e1";
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(EDGE_MARGIN * scale, EDGE_MARGIN * scale, (sheetW - EDGE_MARGIN*2) * scale, (sheetH - EDGE_MARGIN*2) * scale);
            ctx.setLineDash([]);

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–∫—Å—Ç–∞
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            items.forEach((item, idx) => {
                const x = item.x * scale;
                const y = item.y * scale;
                const w = item.w * scale;
                const h = item.h * scale;

                // –¶–≤–µ—Ç –¥–µ—Ç–∞–ª–∏ (—á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏)
                ctx.fillStyle = (idx % 2 === 0) ? "#dbeafe" : "#e0e7ff"; 
                ctx.fillRect(x, y, w, h);

                // –ö–æ–Ω—Ç—É—Ä
                ctx.strokeStyle = "#1e40af";
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, w, h);

                // –¢–µ–∫—Å—Ç (–ö—Ä—É–ø–Ω—ã–π)
                // –ï—Å–ª–∏ –¥–µ—Ç–∞–ª—å —Å–ª–∏—à–∫–æ–º –º–µ–ª–∫–∞—è –¥–ª—è —Ç–µ–∫—Å—Ç–∞, –Ω–µ –ø–∏—à–µ–º –∏–ª–∏ –ø–∏—à–µ–º –º–µ–ª–∫–æ
                if (w > 40 && h > 30) {
                    ctx.fillStyle = "#1e3a8a";
                    ctx.font = `bold ${Math.max(14, Math.min(w, h) * 0.3)}px Arial`;
                    
                    // –ù–æ–º–µ—Ä
                    ctx.fillText(`#${item.num}`, x + w/2, y + h/2 - 10);
                    
                    // –†–∞–∑–º–µ—Ä—ã
                    ctx.font = `${Math.max(10, Math.min(w, h) * 0.2)}px Arial`;
                    ctx.fillText(`${item.w}x${item.h}`, x + w/2, y + h/2 + 15);
                }
            });
        }

        function updateStats(placed, total, sheetW, sheetH, price) {
            const totalArea = sheetW * sheetH;
            let usedArea = 0;
            placed.forEach(p => usedArea += (p.w * p.h));

            const percent = ((usedArea / totalArea) * 100).toFixed(1);
            const waste = (100 - percent).toFixed(1);
            const cost = Math.round((usedArea / totalArea) * price);

            document.getElementById('placedCount').innerText = `${placed.length} / ${total}`;
            document.getElementById('usedPercent').innerText = `${percent}%`;
            document.getElementById('wasteVal').innerText = `${waste}%`;
            document.getElementById('costVal').innerText = `${cost} ‚ÇΩ`;

            // –¶–≤–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            document.getElementById('wasteVal').style.color = waste > 20 ? '#ef4444' : '#059669';
        }
    </script>
</body>
</html>
