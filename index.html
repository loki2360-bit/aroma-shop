<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Кабинет оператора</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --bg: #2d2d2d;
  --card: #3a3a3a;
  --text: #ffffff;
  --text-muted: #bbbbbb;
  --accent-yellow: #ffeb3b;
  --accent-yellow-dark: #fbc02d;
  --accent-red: #ff5252;
  --accent-green: #69f0ae;
  --border: #444444;
  --shadow-light: #444444;
  --shadow-dark: #222222;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

body {
  background: var(--bg);
  color: var(--text);
  padding: 0;
  min-height: 100vh;
  line-height: 1.4;
}

/* Шапка с гамбургером */
.header-bar {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: var(--card);
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 16px;
  z-index: 200;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.toggle-menu-btn {
  background: none;
  border: none;
  color: var(--text);
  font-size: 20px;
  cursor: pointer;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  transition: background 0.2s;
}
.toggle-menu-btn:hover {
  background: rgba(255,255,255,0.1);
}

/* Боковое меню */
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  width: 240px;
  height: 100vh;
  background: var(--card);
  padding: 72px 0 20px; /* отступ под шапку */
  z-index: 100;
  box-shadow: 8px 0 20px rgba(0,0,0,0.4);
  transition: transform 0.3s ease;
}
.sidebar.collapsed {
  transform: translateX(-100%);
}
.sidebar-item {
  padding: 14px 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 12px;
  color: var(--text-muted);
  transition: all 0.2s;
  border-radius: 0 12px 12px 0;
  margin: 0 8px;
}
.sidebar-item:hover,
.sidebar-item.active {
  color: var(--accent-yellow);
  background: var(--card);
  box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
}
.sidebar-item i {
  width: 24px;
  text-align: center;
  font-size: 18px;
}

/* Основной контент */
.main-content {
  margin-left: 240px;
  padding: 72px 24px 24px; /* отступ под шапку */
  max-width: 768px;
  margin: 0 auto;
  transition: margin-left 0.3s ease;
}
.main-content.menu-collapsed {
  margin-left: 0;
}

/* ... остальные стили без изменений ... */

/* Адаптивность */
@media (max-width: 768px) {
  .sidebar {
    transform: translateX(-100%);
  }
  .sidebar.expanded {
    transform: translateX(0);
  }
  .main-content {
    margin-left: 0;
  }
}
</style>
</head>
<body>

<!-- Шапка с гамбургером -->
<div class="header-bar">
  <button class="toggle-menu-btn" id="toggleMenuBtn">
    <i class="fas fa-bars"></i>
  </button>
  <div style="font-weight: 600; font-size: 1.1rem;">Кабинет оператора</div>
</div>

<!-- Боковое меню -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item active" data-target="main">
    <i class="fas fa-home"></i> Основное
  </div>
  <div class="sidebar-item" data-target="preorders">
    <i class="fas fa-clock"></i> Предзаказы
  </div>
  <div class="sidebar-item" data-target="tips">
    <i class="fas fa-mug-hot"></i> Чаевые
  </div>
  <div class="sidebar-item" data-target="stats">
    <i class="fas fa-chart-bar"></i> Статистика
  </div>
</div>

<!-- Основной контент -->
<div class="main-content" id="mainContent">
  <!-- ... ваш контент ... -->
</div>

<!-- ... модальные окна ... -->

<script>
// === ФЛАГ ЗВУКА ===
let soundEnabled = true;

// === Константы ===
const TARIFFS = {
  RASPIL_M2: { price: 65, unit: 'm2' },
  LINEAR_RASPIL: { price: 26, unit: 'linear' },
  SKLEIKA_OB: { price: 210, unit: 'm2' },
  SKLEIKA_NO_OB: { price: 165, unit: 'm2' },
  PAZY: { price: 30, unit: 'linear' },
  FREZER_FASKA: { price: 16, unit: 'linear' },
  TIME: { price: 330, unit: 'time' }
};
const TARIFF_NAMES = {
  RASPIL_M2: 'Распил',
  LINEAR_RASPIL: 'Лин. распил',
  SKLEIKA_OB: 'Склейка +',
  SKLEIKA_NO_OB: 'Склейка –',
  PAZY: 'Пазы',
  FREZER_FASKA: 'Фаска',
  TIME: 'Время'
};
const UNIT_LABELS = {
  m2: 'м²',
  linear: 'пог. м',
  time: 'часы'
};

// === Утилиты ===
function formatDateYMD(dateStr) {
  const [y, m, d] = dateStr.split('-');
  return `${d}.${m}.${y}`;
}
function todayYMD() {
  return new Date().toISOString().split('T')[0];
}
function loadOrders() {
  try {
    return JSON.parse(localStorage.getItem('operator_orders') || '[]');
  } catch (e) { return []; }
}
function saveOrders(orders) {
  localStorage.setItem('operator_orders', JSON.stringify(orders));
}
function loadPreorders() {
  try {
    return JSON.parse(localStorage.getItem('operator_preorders') || '[]');
  } catch (e) { return []; }
}
function savePreorders(preorders) {
  localStorage.setItem('operator_preorders', JSON.stringify(preorders));
}
function getCurrentShift() {
  try {
    return JSON.parse(localStorage.getItem('current_shift') || 'null');
  } catch (e) { return null; }
}
function setCurrentShift(shift) {
  if (shift === null) {
    localStorage.removeItem('current_shift');
  } else {
    localStorage.setItem('current_shift', JSON.stringify(shift));
  }
}

// === Чаевые ===
function loadTipsData() {
  try {
    return JSON.parse(localStorage.getItem('tea_tips_data') || '{}');
  } catch (e) {
    return {};
  }
}
function saveTipsData(data) {
  localStorage.setItem('tea_tips_data', JSON.stringify(data));
}
function updateTipsUI() {
  const data = loadTipsData();
  const today = todayYMD();
  const totalPackets = data.totalPackets || 0;
  const todayPackets = (data.daily && data.daily[today]) || 0;
  const teaLiters = (totalPackets * 0.2).toFixed(1);

  document.getElementById('totalPacketsCount').textContent = totalPackets;
  document.getElementById('todayPacketsCount').textContent = todayPackets;
  document.getElementById('teaLiters').textContent = teaLiters;

  // Прогресс (до 1000 и 200)
  const totalProgress = Math.min(100, totalPackets / 1000 * 100);
  const todayProgress = Math.min(100, todayPackets / 200 * 100);
  setTimeout(() => {
    document.getElementById('totalPacketsFill').style.width = `${totalProgress}%`;
    document.getElementById('todayPacketsFill').style.width = `${todayProgress}%`;
  }, 300);
}

// === Звуковой сигнал ===
function playSuccessSound() {
  if (!soundEnabled) return;
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);

    oscillator.type = 'sine';
    oscillator.frequency.value = 800;
    gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);

    oscillator.start(ctx.currentTime);
    oscillator.stop(ctx.currentTime + 0.3);
  } catch (e) {
    console.warn("Audio feedback not supported", e);
  }
}

// === Расчёт суммы ===
function calculateAmount(tariffKey, length, width, hours, qty) {
  const tariff = TARIFFS[tariffKey];
  if (!tariff) return 0;
  let amount = 0;
  if (tariff.unit === 'time') {
    amount = tariff.price * hours * qty;
  } else if (tariff.unit === 'm2') {
    amount = tariff.price * length * width * qty;
  } else {
    amount = tariff.price * length * qty;
  }
  return Math.round(amount * 100) / 100;
}

// === Обновление UI плана ===
function updateUI() {
  const orders = loadOrders();
  const totalAll = orders.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
  const shift = getCurrentShift();
  let currentShiftAmount = 0;
  let progressWidth = 0;
  let statusText = 'Смена не начата';

  if (shift && shift.active) {
    currentShiftAmount = orders
      .filter(o => o.shiftId === shift.id)
      .reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
    progressWidth = Math.min(100, (currentShiftAmount / 3000) * 100);
    statusText = 'Смена активна';
  } else if (shift && !shift.active) {
    currentShiftAmount = shift.finalAmount || 0;
    progressWidth = Math.min(100, (currentShiftAmount / 3000) * 100);
    statusText = 'Смена завершена';
  }

  document.getElementById('totalAll').textContent = totalAll.toFixed(2);
  document.getElementById('todayEarned').textContent = currentShiftAmount.toFixed(2);
  setTimeout(() => {
    document.getElementById('planProgress').style.width = `${progressWidth}%`;
  }, 300);
  document.getElementById('shiftStatus').textContent = statusText;
}

// === Переключение полей ===
function updateMainFormFields() {
  const tariff = document.getElementById('tariff').value;
  ['widthGroup', 'hoursGroup'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
  document.getElementById('lengthGroup')?.classList.remove('hidden');
  if (['RASPIL_M2', 'SKLEIKA_OB', 'SKLEIKA_NO_OB'].includes(tariff)) {
    document.getElementById('widthGroup')?.classList.remove('hidden');
  } else if (tariff === 'TIME') {
    document.getElementById('lengthGroup')?.classList.add('hidden');
    document.getElementById('hoursGroup')?.classList.remove('hidden');
  }
}
function updatePreorderFormFields() {
  const tariff = document.getElementById('preTariff').value;
  ['preWidthGroup', 'preHoursGroup'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
  document.getElementById('preLengthGroup')?.classList.remove('hidden');
  if (['RASPIL_M2', 'SKLEIKA_OB', 'SKLEIKA_NO_OB'].includes(tariff)) {
    document.getElementById('preWidthGroup')?.classList.remove('hidden');
  } else if (tariff === 'TIME') {
    document.getElementById('preLengthGroup')?.classList.add('hidden');
    document.getElementById('preHoursGroup')?.classList.remove('hidden');
  }
}
function updateEditFormFields() {
  const tariff = document.getElementById('editTariff').value;
  ['editWidthGroup', 'editHoursGroup'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
  document.getElementById('editLengthGroup')?.classList.remove('hidden');
  if (['RASPIL_M2', 'SKLEIKA_OB', 'SKLEIKA_NO_OB'].includes(tariff)) {
    document.getElementById('editWidthGroup')?.classList.remove('hidden');
  } else if (tariff === 'TIME') {
    document.getElementById('editLengthGroup')?.classList.add('hidden');
    document.getElementById('editHoursGroup')?.classList.remove('hidden');
  }
}

// === Смена ===
function startShift() {
  const shift = getCurrentShift();
  if (shift && shift.active) {
    alert('Смена уже активна!');
    return;
  }
  const newShift = { id: Date.now(), startedAt: new Date().toISOString(), active: true };
  setCurrentShift(newShift);
  alert('✅ Смена начата!');
  updateUI();
}
function endShift() {
  const shift = getCurrentShift();
  if (!shift || !shift.active) {
    alert('Нет активной смены для завершения!');
    return;
  }
  const orders = loadOrders();
  const finalAmount = orders
    .filter(o => o.shiftId === shift.id)
    .reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
  shift.active = false;
  shift.finishedAt = new Date().toISOString();
  shift.finalAmount = finalAmount;
  setCurrentShift(shift);
  alert(`✅ Смена завершена!\nЗаработано: ${finalAmount.toFixed(2)} ₽`);
  updateUI();
}

// === Удаление ===
function deleteOrder(orderId) {
  if (!confirm('Вы уверены, что хотите удалить этот заказ?')) return;
  const orders = loadOrders();
  const idx = orders.findIndex(o => o.id === orderId);
  if (idx === -1) return;
  orders.splice(idx, 1);
  saveOrders(orders);
  const shift = getCurrentShift();
  if (shift && shift.active) updateUI();
  showOrdersByDate();
  alert('✅ Заказ удален!');
}
function deletePreorder(preorderId) {
  if (!confirm('Вы уверены, что хотите удалить этот предзаказ?')) return;
  const preorders = loadPreorders();
  const idx = preorders.findIndex(p => p.id === preorderId);
  if (idx === -1) return;
  preorders.splice(idx, 1);
  savePreorders(preorders);
  renderPreorders();
  alert('✅ Предзаказ удален!');
}

// === Модальные окна ===
let pendingPreorderId = null;
function openDateModal(preorderId) {
  pendingPreorderId = preorderId;
  document.getElementById('modalDate').value = todayYMD();
  document.getElementById('dateModal').classList.add('active');
}
function closeDateModal() {
  document.getElementById('dateModal').classList.remove('active');
  pendingPreorderId = null;
}
function confirmDateSelection() {
  const date = document.getElementById('modalDate').value;
  if (!date) { alert('Выберите дату'); return; }
  if (pendingPreorderId !== null) acceptPreorder(pendingPreorderId, date);
  closeDateModal();
}
function viewOrderDetails(orderId) {
  const orders = loadOrders();
  const order = orders.find(o => o.id === orderId);
  if (!order) return;
  const units = calculateUnits(order.tariff, order.length, order.width, order.hours, order.qty);
  const tariffName = TARIFF_NAMES[order.tariff] || order.tariff;
  let html = '';
  html += `<div class="details-item"><span class="details-label">№ заказа:</span><span class="details-value">${order.orderNumber}</span></div>`;
  html += `<div class="details-item"><span class="details-label">Деталь:</span><span class="details-value">${order.detail}</span></div>`;
  html += `<div class="details-item"><span class="details-label">Тариф:</span><span class="details-value">${tariffName}</span></div>`;
  html += `<div class="details-item"><span class="details-label">Количество:</span><span class="details-value">${order.qty}</span></div>`;
  if (order.length !== null) html += `<div class="details-item"><span class="details-label">Длина:</span><span class="details-value">${order.length} м</span></div>`;
  if (order.width !== null) html += `<div class="details-item"><span class="details-label">Ширина:</span><span class="details-value">${order.width} м</span></div>`;
  if (order.hours !== null) html += `<div class="details-item"><span class="details-label">Часы:</span><span class="details-value">${order.hours} ч</span></div>`;
  html += `<div class="details-item"><span class="details-label">Объем работ:</span><span class="details-value">${units.value} ${units.unit}</span></div>`;
  html += `<div class="details-item"><span class="details-label">Сумма:</span><span class="details-value">${order.amount.toFixed(2)} ₽</span></div>`;
  document.getElementById('detailsContent').innerHTML = html;
  document.getElementById('detailsModal').classList.add('active');
}
function closeDetailsModal() {
  document.getElementById('detailsModal').classList.remove('active');
}
function openEditModal(orderId) {
  const orders = loadOrders();
  const order = orders.find(o => o.id === orderId);
  if (!order) return;
  editingOrder = order;
  document.getElementById('editOrderId').value = order.id;
  document.getElementById('editOrderNum').value = order.orderNumber;
  document.getElementById('editDetail').value = order.detail;
  document.getElementById('editTariff').value = order.tariff;
  document.getElementById('editQty').value = order.qty;
  document.getElementById('editLength').value = order.length || '';
  document.getElementById('editWidth').value = order.width || '';
  document.getElementById('editHours').value = order.hours || '';
  updateEditFormFields();
  document.getElementById('editModal').classList.add('active');
}
let editingOrder = null;
function closeEditModal() {
  document.getElementById('editModal').classList.remove('active');
  editingOrder = null;
}
function saveEditedOrder() {
  if (!editingOrder) return;
  const orderId = parseInt(document.getElementById('editOrderId').value);
  const num = document.getElementById('editOrderNum').value.trim();
  if (!num) { alert('Укажите № заказа'); return; }
  const tariffKey = document.getElementById('editTariff').value;
  const detail = document.getElementById('editDetail').value.trim() || '—';
  const qty = parseInt(document.getElementById('editQty').value) || 1;
  const length = parseFloat(document.getElementById('editLength').value) || 0;
  const width = parseFloat(document.getElementById('editWidth').value) || 0;
  const hours = parseFloat(document.getElementById('editHours').value) || 0;
  const amount = calculateAmount(tariffKey, length, width, hours, qty);
  const orders = loadOrders();
  const idx = orders.findIndex(o => o.id === orderId);
  if (idx !== -1) {
    orders[idx] = {
      ...orders[idx],
      orderNumber: num,
      tariff: tariffKey,
      detail: detail,
      qty: qty,
      length: length || null,
      width: width || null,
      hours: hours || null,
      amount: amount
    };
    saveOrders(orders);
    updateUI();
    showOrdersByDate();
    closeEditModal();
    alert('✅ Заказ обновлён!');
  }
}

// === Основные функции ===
function createMainOrder() {
  const num = document.getElementById('orderNum').value.trim();
  if (!num) { alert('Укажите № заказа'); return; }
  const tariffKey = document.getElementById('tariff').value;
  const detail = document.getElementById('detail').value.trim() || '—';
  const qty = parseInt(document.getElementById('qty').value) || 1;
  const length = parseFloat(document.getElementById('length').value) || 0;
  const width = parseFloat(document.getElementById('width').value) || 0;
  const hours = parseFloat(document.getElementById('hours').value) || 0;
  const amount = calculateAmount(tariffKey, length, width, hours, qty);
  const shift = getCurrentShift();
  if (!shift || !shift.active) {
    alert('⚠️ Начните смену, чтобы создавать заказы!');
    return;
  }
  const order = {
    id: Date.now(),
    orderNumber: num,
    tariff: tariffKey,
    detail: detail,
    qty: qty,
    length: length || null,
    width: width || null,
    hours: hours || null,
    amount: amount,
    date: todayYMD(),
    shiftId: shift.id,
    timestamp: new Date().toISOString()
  };
  const orders = loadOrders();
  orders.push(order);
  saveOrders(orders);
  updateUI();
  ['orderNum','detail','qty','length','width','hours'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = (id === 'qty') ? '1' : '';
  });
  updateMainFormFields();
}
function createMainOrderWithSound() {
  createMainOrder();
  setTimeout(playSuccessSound, 100);
}

function createPreorder() {
  const num = document.getElementById('preOrderNum').value.trim();
  if (!num) { alert('Укажите № предзаказа'); return; }
  const tariffKey = document.getElementById('preTariff').value;
  const detail = document.getElementById('preDetail').value.trim() || '—';
  const qty = parseInt(document.getElementById('preQty').value) || 1;
  const length = parseFloat(document.getElementById('preLength').value) || 0;
  const width = parseFloat(document.getElementById('preWidth').value) || 0;
  const hours = parseFloat(document.getElementById('preHours').value) || 0;
  const amount = calculateAmount(tariffKey, length, width, hours, qty);
  const preorder = {
    id: Date.now(),
    orderNumber: num,
    tariff: tariffKey,
    detail: detail,
    qty: qty,
    length: length || null,
    width: width || null,
    hours: hours || null,
    amount: amount,
    date: todayYMD(),
    timestamp: new Date().toISOString()
  };
  const preorders = loadPreorders();
  preorders.push(preorder);
  savePreorders(preorders);
  alert('✅ Предзаказ сохранён!');
  renderPreorders();
  ['preOrderNum','preDetail','preQty','preLength','preWidth','preHours'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = (id === 'preQty') ? '1' : '';
  });
  updatePreorderFormFields();
}

// === Чаевые ===
function addTip() {
  const input = document.getElementById('tipAmount');
  const value = parseFloat(input.value);
  if (!value || value <= 0) {
    alert('Введите сумму чаевых (больше 0)');
    return;
  }
  const packets = Math.floor(value);
  const today = todayYMD();
  const data = loadTipsData();
  data.totalPackets = (data.totalPackets || 0) + packets;
  data.daily = data.daily || {};
  data.daily[today] = (data.daily[today] || 0) + packets;
  saveTipsData(data);
  input.value = '';
  updateTipsUI();
  alert(`✅ Добавлено ${packets} чайных пакетиков!`);
}

// === Принять предзаказ ===
function acceptPreorder(preorderId, selectedDate = null) {
  const preorders = loadPreorders();
  const idx = preorders.findIndex(p => p.id === preorderId);
  if (idx === -1) return;
  const preorder = preorders[idx];
  const shift = getCurrentShift();
  if (!shift || !shift.active) {
    alert('Начните смену, чтобы принять предзаказ!');
    return;
  }
  if (!selectedDate) {
    openDateModal(preorderId);
    return;
  }
  const order = {...preorder, shiftId: shift.id, date: selectedDate};
  const orders = loadOrders();
  orders.push(order);
  saveOrders(orders);
  preorders.splice(idx, 1);
  savePreorders(preorders);
  alert(`✅ Предзаказ "${preorder.orderNumber}" принят на дату ${formatDateYMD(selectedDate)}!`);
  updateUI();
  renderPreorders();
}

// === Рендер предзаказов ===
function renderPreorders() {
  const preorders = loadPreorders();
  const container = document.getElementById('preordersListContainer');
  if (preorders.length === 0) {
    container.innerHTML = '<div class="empty-msg">Нет предзаказов</div>';
    return;
  }
  let html = `<table class="orders-table"><thead><tr><th>№</th><th>Деталь</th><th>Сумма</th><th>Действия</th></tr></thead><tbody>`;
  preorders.forEach(p => {
    html += `
<tr>
<td>${p.orderNumber}</td>
<td>${p.detail}</td>
<td class="amount">${p.amount.toFixed(2)} ₽</td>
<td>
<button class="action-btn" onclick="acceptPreorder(${p.id})"><i class="fas fa-check"></i></button>
<button class="action-btn" onclick="deletePreorder(${p.id})"><i class="fas fa-trash"></i></button>
</td>
</tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

// === Показать заказы по дате ===
function showOrdersByDate() {
  const dateInput = document.getElementById('viewDate').value;
  if (!dateInput) { alert('Выберите дату'); return; }
  const orders = loadOrders();
  const filtered = orders.filter(o => o.date === dateInput);
  const formattedDate = formatDateYMD(dateInput);
  let html = `<div class="progress-title">Заказы за ${formattedDate}</div>`;
  if (filtered.length === 0) {
    html += '<div class="empty-msg">Нет заказов за эту дату</div>';
  } else {
    html += `<table class="orders-table"><thead><tr><th>№</th><th>Деталь</th><th>Сумма</th><th>Действия</th></tr></thead><tbody>`;
    filtered.forEach(o => {
      html += `
<tr>
<td>${o.orderNumber}</td>
<td>${o.detail}</td>
<td class="amount">${o.amount.toFixed(2)} ₽</td>
<td>
<button class="action-btn" onclick="viewOrderDetails(${o.id})"><i class="fas fa-eye"></i></button>
<button class="action-btn" onclick="openEditModal(${o.id})"><i class="fas fa-edit"></i></button>
<button class="action-btn" onclick="deleteOrder(${o.id})"><i class="fas fa-trash"></i></button>
</td>
</tr>`;
    });
    html += '</tbody></table>';
  }
  document.getElementById('ordersListContainer').innerHTML = html;
}

// === Экспорт ===
function saveOrdersToFile() {
  const dateInput = document.getElementById('viewDate').value;
  if (!dateInput) { alert('Сначала выберите дату'); return; }
  const orders = loadOrders();
  const filtered = orders.filter(o => o.date === dateInput);
  if (filtered.length === 0) { alert('Нет заказов за эту дату'); return; }
  const formattedDate = formatDateYMD(dateInput);
  let content = `ЗАКАЗЫ ЗА ${formattedDate}\n========================\n`;
  let totalSum = 0;
  filtered.forEach((o, idx) => {
    const tariffName = TARIFF_NAMES[o.tariff] || o.tariff;
    const units = calculateUnits(o.tariff, o.length, o.width, o.hours, o.qty);
    content += `№${idx + 1}. ${o.orderNumber}\n   ${o.detail} (${tariffName})\n`;
    if (o.length) content += `   Длина: ${o.length} м\n`;
    if (o.width) content += `   Ширина: ${o.width} м\n`;
    if (o.hours) content += `   Часы: ${o.hours} ч\n`;
    content += `   Кол-во: ${o.qty}\n   Объем: ${units.value} ${units.unit}\n   Сумма: ${o.amount.toFixed(2)} ₽\n---\n`;
    totalSum += o.amount;
  });
  content += `\nИТОГО: ${totalSum.toFixed(2)} ₽\nЭкспорт: ${new Date().toLocaleString('ru-RU')}`;
  const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
  const blob = new Blob([bom, content], { type: 'text/plain;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `заказы_${formattedDate}.txt`;
  a.click();
  URL.revokeObjectURL(a.href);
}
function saveOrdersToJSON() {
  const dateInput = document.getElementById('viewDate').value;
  if (!dateInput) { alert('Сначала выберите дату'); return; }
  const orders = loadOrders();
  const filtered = orders.filter(o => o.date === dateInput);
  if (filtered.length === 0) { alert('Нет заказов за эту дату'); return; }
  const jsonContent = JSON.stringify(filtered, null, 2);
  const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `заказы_${formatDateYMD(dateInput)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

// === Импорт файлов ===
document.getElementById('jsonImportInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(event) {
    try {
      const content = event.target.result;
      let importedOrders = [];
      if (content.trim().startsWith('{') || content.trim().startsWith('[')) {
        importedOrders = JSON.parse(content);
        if (!Array.isArray(importedOrders)) {
          importedOrders = [importedOrders];
        }
      } else {
        importedOrders = parseTxtOrders(content);
      }
      if (importedOrders.length === 0) {
        alert('Не удалось найти заказы в файле!');
        return;
      }
      const preorders = loadPreorders();
      const newPreorders = importedOrders.map(item => ({
        id: Date.now() + Math.random(),
        orderNumber: item.orderNumber || 'ИМП-' + (preorders.length + 1),
        tariff: item.tariff || 'RASPIL_M2',
        detail: item.detail || '—',
        qty: item.qty || 1,
        length: item.length || null,
        width: item.width || null,
        hours: item.hours || null,
        amount: typeof item.amount === 'number' ? item.amount : calculateAmount(
          item.tariff || 'RASPIL_M2',
          item.length || 0,
          item.width || 0,
          item.hours || 0,
          item.qty || 1
        ),
        date: todayYMD(),
        timestamp: new Date().toISOString()
      }));
      const updated = [...preorders, ...newPreorders];
      savePreorders(updated);
      renderPreorders();
      alert(`✅ Загружено ${newPreorders.length} предзаказов!`);
    } catch (err) {
      console.error(err);
      alert('Ошибка при чтении файла:\n' + err.message);
    }
  };
  reader.readAsText(file, 'utf-8');
});

// === Парсинг TXT ===
function parseTxtOrders(txtContent) {
  const orders = [];
  const blocks = txtContent.split('---');
  for (const block of blocks) {
    const lines = block.trim().split('\n').filter(line => line.trim() !== '');
    if (lines.length < 3) continue;
    const order = {
      orderNumber: '',
      detail: '',
      tariff: '',
      qty: 1,
      length: null,
      width: null,
      hours: null,
      amount: 0
    };
    let currentDetail = '';
    let currentTariff = '';
    for (const line of lines) {
      const cleanLine = line.trim();
      if (cleanLine.startsWith('№') && cleanLine.includes('.')) {
        const match = cleanLine.match(/№\d+\.\s*(.+)/);
        if (match) order.orderNumber = match[1].trim();
      } else if (/^[A-Z0-9]/.test(cleanLine) && !cleanLine.includes(':') && !cleanLine.includes('Сумма') && !cleanLine.includes('ИТОГО')) {
        if (!order.orderNumber && cleanLine.length > 2) {
          order.orderNumber = cleanLine;
        }
      }
      if (cleanLine.includes('(') && cleanLine.includes(')') && !cleanLine.includes('Сумма')) {
        const match = cleanLine.match(/(.+)\s*\((.+)\)/);
        if (match) {
          currentDetail = match[1].trim();
          currentTariff = match[2].trim();
        }
      }
      if (cleanLine.startsWith('Длина:')) {
        const match = cleanLine.match(/Длина:\s*([\d.]+)\s*м/);
        if (match) order.length = parseFloat(match[1]);
      }
      if (cleanLine.startsWith('Ширина:')) {
        const match = cleanLine.match(/Ширина:\s*([\d.]+)\s*м/);
        if (match) order.width = parseFloat(match[1]);
      }
      if (cleanLine.startsWith('Часы:')) {
        const match = cleanLine.match(/Часы:\s*([\d.]+)\s*ч/);
        if (match) order.hours = parseFloat(match[1]);
      }
      if (cleanLine.startsWith('Кол-во:')) {
        const match = cleanLine.match(/Кол-во:\s*(\d+)/);
        if (match) order.qty = parseInt(match[1]);
      }
      if (cleanLine.startsWith('Сумма:')) {
        const match = cleanLine.match(/Сумма:\s*([\d.]+)\s*₽/);
        if (match) order.amount = parseFloat(match[1]);
      }
    }
    if (currentTariff) {
      const tariffMap = {
        'Распил': 'RASPIL_M2',
        'Лин. распил': 'LINEAR_RASPIL',
        'Склейка +': 'SKLEIKA_OB',
        'Склейка –': 'SKLEIKA_NO_OB',
        'Пазы': 'PAZY',
        'Фаска': 'FREZER_FASKA',
        'Время': 'TIME'
      };
      order.tariff = tariffMap[currentTariff] || 'RASPIL_M2';
    }
    order.detail = currentDetail || '—';
    if (order.orderNumber) {
      orders.push(order);
    }
  }
  return orders;
}

// === Расчёт единиц ===
function calculateUnits(tariffKey, length, width, hours, qty) {
  const tariff = TARIFFS[tariffKey];
  if (!tariff) return { value: 0, unit: '' };
  let value = 0;
  let unit = tariff.unit;
  if (tariff.unit === 'time') value = hours * qty;
  else if (tariff.unit === 'm2') value = length * width * qty;
  else value = length * qty;
  return { value: Math.round(value * 100) / 100, unit: UNIT_LABELS[unit] || unit };
}

// === Статистика ===
function calculateStats() {
  const orders = loadOrders();
  let totalLinear = 0;
  let totalArea = 0;
  let totalTime = 0;
  const operationCount = {
    RASPIL_M2: 0,
    LINEAR_RASPIL: 0,
    SKLEIKA_OB: 0,
    SKLEIKA_NO_OB: 0,
    PAZY: 0,
    FREZER_FASKA: 0,
    TIME: 0
  };

  orders.forEach(o => {
    if (o.tariff === 'LINEAR_RASPIL' || o.tariff === 'PAZY' || o.tariff === 'FREZER_FASKA') {
      totalLinear += (o.length || 0) * (o.qty || 1);
    } else if (o.tariff === 'RASPIL_M2' || o.tariff === 'SKLEIKA_OB' || o.tariff === 'SKLEIKA_NO_OB') {
      totalArea += (o.length || 0) * (o.width || 0) * (o.qty || 1);
    } else if (o.tariff === 'TIME') {
      totalTime += (o.hours || 0) * (o.qty || 1);
    }
    operationCount[o.tariff] = (operationCount[o.tariff] || 0) + 1;
  });

  // Максимумы для шкал
  const MAX_LINEAR = 1000; // метров
  const MAX_AREA = 200;   // м²
  const MAX_TIME = 100;   // часов

  return {
    linear: { value: totalLinear, percent: Math.min(100, totalLinear / MAX_LINEAR * 100) },
    area: { value: totalArea, percent: Math.min(100, totalArea / MAX_AREA * 100) },
    time: { value: totalTime, percent: Math.min(100, totalTime / MAX_TIME * 100) },
    operations: operationCount
  };
}

function renderStats() {
  const stats = calculateStats();

  document.getElementById('linearTotal').textContent = stats.linear.value.toFixed(1);
  document.getElementById('areaTotal').textContent = stats.area.value.toFixed(1);
  document.getElementById('timeTotal').textContent = stats.time.value.toFixed(1);

  setTimeout(() => {
    document.getElementById('linearProgress').style.width = `${stats.linear.percent}%`;
    document.getElementById('areaProgress').style.width = `${stats.area.percent}%`;
    document.getElementById('timeProgress').style.width = `${stats.time.percent}%`;
  }, 300);

  const opNames = {
    RASPIL_M2: 'Распил',
    LINEAR_RASPIL: 'Лин. распил',
    SKLEIKA_OB: 'Склейка +',
    SKLEIKA_NO_OB: 'Склейка –',
    PAZY: 'Пазы',
    FREZER_FASKA: 'Фаска',
    TIME: 'Время'
  };

  let maxCount = Math.max(...Object.values(stats.operations));
  if (maxCount === 0) maxCount = 1;

  let chartHtml = '';
  for (const [key, count] of Object.entries(stats.operations)) {
    if (count === 0) continue;
    const percent = (count / maxCount) * 100;
    chartHtml += `
      <div class="bar-item">
        <div class="bar-label">
          <span>${opNames[key]}</span>
          <span>${count}</span>
        </div>
        <div class="bar-container">
          <div class="bar-fill" style="width: ${percent}%;"></div>
        </div>
      </div>
    `;
  }

  document.getElementById('operationsChart').innerHTML = chartHtml || '<p style="color:var(--text-muted); text-align:center;">Нет данных</p>';
}

// === Переключение меню ===
document.querySelectorAll('.sidebar-item').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
    document.querySelectorAll('.content-block').forEach(c => c.classList.remove('active'));
    
    item.classList.add('active');
    const target = item.dataset.target;
    document.getElementById(target).classList.add('active');

    if (target === 'stats') {
      renderStats();
    } else if (target === 'main') {
      updateUI();
    } else if (target === 'tips') {
      updateTipsUI();
    } else if (target === 'preorders') {
      renderPreorders();
    }

    // Свернуть меню на мобильных
    if (window.innerWidth <= 768) {
      document.getElementById('sidebar').classList.remove('expanded');
    }
  });
});

// === Скрываемое меню ===
const toggleBtn = document.getElementById('toggleMenuBtn');
const sidebar = document.getElementById('sidebar');

// Загрузить состояние из localStorage (только для десктопа)
if (window.innerWidth > 768) {
  const isMenuCollapsed = localStorage.getItem('menuCollapsed') === 'true';
  if (isMenuCollapsed) {
    sidebar.classList.add('collapsed');
    document.getElementById('mainContent').classList.add('menu-collapsed');
  }
}

// Переключение меню
toggleBtn.addEventListener('click', () => {
  if (window.innerWidth <= 768) {
    // На мобильных — всегда используем expanded
    sidebar.classList.toggle('expanded');
  } else {
    // На десктопе — используем collapsed и сохраняем состояние
    const isCollapsed = sidebar.classList.contains('collapsed');
    sidebar.classList.toggle('collapsed', !isCollapsed);
    document.getElementById('mainContent').classList.toggle('menu-collapsed', !isCollapsed);
    localStorage.setItem('menuCollapsed', !isCollapsed);
  }
});

// Инициализация
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('viewDate').value = todayYMD();
  ['tariff','preTariff','editTariff'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', () => {
      if (id === 'tariff') updateMainFormFields();
      else if (id === 'preTariff') updatePreorderFormFields();
      else updateEditFormFields();
    });
  });
  updateUI();
  updateTipsUI();
  renderPreorders();
});
</script>
</body>
</html>
