<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–¥–º–∏–Ω–∫–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
    body {
      padding: 20px;
      background: #f5f7fa;
      color: #222;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h2 { margin: 20px 0 12px; }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      background: #2196F3;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { opacity: 0.9; }
    button.export-btn {
      background: #9c27b0;
      font-size: 14px;
      padding: 8px;
    }
    button.send-btn {
      background: #0088cc;
      font-size: 14px;
      padding: 8px;
      margin-top: 10px;
    }
    .section { background: white; padding: 16px; border-radius: 12px; margin-top: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .hidden { display: none !important; }
    .promo-alert {
      padding: 14px;
      border-radius: 8px;
      margin: 16px 0;
      font-weight: bold;
      text-align: center;
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .level-20 { background: #e3f2fd; color: #0d47a1; }
    .level-25 { background: #fff8e1; color: #e65100; }
    .level-30 { background: #e8f5e8; color: #1b5e20; }
    .footer-note { text-align: center; font-size: 12px; color: #888; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéüÔ∏è –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</h1>

    <!-- –ù–û–í–´–ô –ö–õ–ò–ï–ù–¢ -->
    <div class="section">
      <h2>‚ûï –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</h2>
      <input type="text" id="contact-link" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ Telegram (@user) –∏–ª–∏ VK (https://vk.com/user)" />
      <button onclick="generateNewUser()">–í—ã–¥–∞—Ç—å QR —Å 100 –±–∞–ª–ª–∞–º–∏</button>
      <div id="new-qr-display" class="hidden">
        <h3>QR –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:</h3>
        <div id="new-qr-img"></div>
        <button class="send-btn" onclick="sendToClient('new')">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É</button>
      </div>
    </div>

    <!-- –ù–ê–ß–ò–°–õ–ï–ù–ò–ï –ë–ê–õ–õ–û–í -->
    <div class="section">
      <h2>üîÑ –ù–∞—á–∏—Å–ª–∏—Ç—å 5 –±–∞–ª–ª–æ–≤</h2>
      <input type="text" id="input-qr-full" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É –∏–∑ QR-–∫–æ–¥–∞" />
      <button onclick="addPointsAutomatically()">–î–æ–±–∞–≤–∏—Ç—å 5 –±–∞–ª–ª–æ–≤</button>

      <div id="promo-notification" class="hidden"></div>

      <div id="result-qr-display" class="hidden">
        <h3>–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π QR:</h3>
        <div id="result-qr-img"></div>
        <button class="send-btn" onclick="sendToClient('result')">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É</button>
      </div>
    </div>

    <!-- –≠–ö–°–ü–û–†–¢ -->
    <div style="text-align:center; margin-top:20px;">
      <button class="export-btn" onclick="exportHistory()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏</button>
    </div>

    <div class="footer-note">
      –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.
    </div>
  </div>

  <!-- QR Generator -->
  <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
  <script>
    const SECRET = "loyalty-secret-2026";
    let history = JSON.parse(localStorage.getItem('loyalty_history') || '[]');
    let currentContactLink = null; // —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏

    // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    function makeHash(id, points) {
      return btoa(`${id}|${points}|${SECRET}`).replace(/[^a-zA-Z0-9]/g, '').substring(0, 12).toUpperCase();
    }

    function verifyData(id, points, hash) {
      return makeHash(id, points) === hash;
    }

    function encodeToQRString(id, points) {
      return `id:${id}|points:${points}|hash:${makeHash(id, points)}`;
    }

    function parseQRString(str) {
      const data = {};
      str.split('|').forEach(part => {
        const [k, v] = part.split(':');
        if (k && v) data[k] = k === 'points' ? parseInt(v) : v;
      });
      return data;
    }

    function generateQRImage(str) {
      const qr = qrcode(0, 'M');
      qr.addData(str);
      qr.make();
      return qr.createImgTag(6);
    }

    function playSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        oscillator.frequency.value = 800;
        gainNode.gain.value = 0.2;
        oscillator.type = 'sine';
        oscillator.start();
        setTimeout(() => oscillator.stop(), 200);
      } catch (e) {}
    }

    function addToHistory(id, oldPoints, newPoints, contact = '') {
      history.unshift({ time: new Date().toISOString(), id, oldPoints, newPoints, contact });
      if (history.length > 500) history = history.slice(0, 500);
      localStorage.setItem('loyalty_history', JSON.stringify(history));
    }

    function exportHistory() {
      let txt = "–ò—Å—Ç–æ—Ä–∏—è\n=======\n\n";
      history.forEach(item => {
        const date = new Date(item.time).toLocaleString('ru-RU');
        txt += `${date} | ${item.contact || '‚Äî'} | ID: ${item.id} | ${item.oldPoints} ‚Üí ${item.newPoints}\n`;
      });
      const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `loyalty_${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // === –û–¢–ü–†–ê–í–ö–ê –ö–õ–ò–ï–ù–¢–£ ===
    function sendToClient(type) {
      if (!currentContactLink) {
        alert("–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞!");
        return;
      }

      // –ü–æ–ª—É—á–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ QR
      const img = document.querySelector(`#${type}-qr-img img`);
      if (!img) return;

      // –°–æ–∑–¥–∞—ë–º Blob –∏–∑ Data URL
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      canvas.toBlob(blob => {
        const qrUrl = URL.createObjectURL(blob);
        const message = `–í–∞—à –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π QR-–∫–æ–¥:\n${qrUrl}\n\n–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!`;

        let url = '';
        if (currentContactLink.startsWith('@')) {
          // Telegram username
          const username = currentContactLink.replace(/^@/, '');
          url = `https://t.me/${username}?start=qr`;
          // Telegram –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ URL, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä–æ–µ–º —á–∞—Ç
          url = `https://t.me/${username}`;
        } else if (currentContactLink.includes('vk.com')) {
          // VK: –æ—Ç–∫—Ä–æ–µ–º –¥–∏–∞–ª–æ–≥
          const vkId = currentContactLink.split('/').pop();
          url = `https://vk.com/im?sel=${vkId}`;
        } else {
          alert("–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ @username (Telegram) –∏–ª–∏ https://vk.com/...");
          return;
        }

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç
        window.open(url, '_blank');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        setTimeout(() => {
          alert("QR-–∫–æ–¥ –≥–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ!\n\n1. –û—Ç–∫—Ä—ã—Ç —á–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–æ–º.\n2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ:\n\n" + qrUrl);
        }, 1000);
      });
    }

    // === –ì–ï–ù–ï–†–ê–¶–ò–Ø –ù–û–í–û–ì–û –ö–õ–ò–ï–ù–¢–ê ===
    function generateNewUser() {
      const contact = document.getElementById('contact-link').value.trim();
      if (!contact) return alert("–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç (Telegram –∏–ª–∏ VK)");

      currentContactLink = contact;

      const id = Math.random().toString(36).substring(2, 10) + Date.now().toString(36).slice(-4);
      const points = 100;
      const qrStr = encodeToQRString(id, points);
      document.getElementById('new-qr-img').innerHTML = generateQRImage(qrStr);
      document.getElementById('new-qr-display').classList.remove('hidden');

      addToHistory(id, 0, points, contact);
    }

    // === –ù–ê–ß–ò–°–õ–ï–ù–ò–ï –ë–ê–õ–õ–û–í ===
    function addPointsAutomatically() {
      const fullStr = document.getElementById('input-qr-full').value.trim();
      if (!fullStr) return alert("–í—Å—Ç–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É –∏–∑ QR-–∫–æ–¥–∞");

      const data = parseQRString(fullStr);
      if (!data.id || isNaN(data.points) || !data.hash) {
        return alert("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR");
      }

      if (!verifyData(data.id, data.points, data.hash)) {
        return alert("‚ùå –ü–æ–¥–¥–µ–ª—å–Ω—ã–π QR!");
      }

      // –ù–∞–π—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
      const histEntry = history.find(h => h.id === data.id);
      currentContactLink = histEntry ? histEntry.contact : null;

      const newPoints = data.points + 5;
      addToHistory(data.id, data.points, newPoints, currentContactLink);

      const newQrStr = encodeToQRString(data.id, newPoints);
      document.getElementById('result-qr-img').innerHTML = generateQRImage(newQrStr);
      document.getElementById('result-qr-display').classList.remove('hidden');

      // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      const promoDiv = document.getElementById('promo-notification');
      promoDiv.className = 'promo-alert hidden';
      let level = null, discount = 0;
      if (newPoints >= 100) { level = '30'; discount = 30; }
      else if (newPoints >= 75) { level = '25'; discount = 25; }
      else if (newPoints >= 50) { level = '20'; discount = 20; }

      if (level) {
        promoDiv.innerText = `üéÅ –î–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ ${discount}% —Å–∫–∏–¥–∫—É!`;
        promoDiv.classList.add(`level-${level}`);
        promoDiv.classList.remove('hidden');
        playSound();
      }

      document.getElementById('input-qr-full').value = '';
    }
  </script>
</body>
</html>
