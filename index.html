<script>
    // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
    const SUPABASE_URL = 'https://zitdekerfjocbulmfuyo.supabase.co'; // –í–°–¢–ê–í–¨–¢–ï –°–°–´–õ–ö–£
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InppdGRla2VyZmpvY2J1bG1mdXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxODA0ODksImV4cCI6MjA4NDc1NjQ4OX0.PHET6UIg-PqspgeHUQMATXmYV7tBV7UhH6u27oacPM8'; // –í–°–¢–ê–í–¨–¢–ï –ö–õ–Æ–ß
    const ADMIN_PASS = '1234';
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_KEY === 'YOUR_SUPABASE_KEY') {
        console.error('‚ö†Ô∏è –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã Supabase URL –∏ KEY!');
        alert('‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ! –ù—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å Supabase URL –∏ KEY –≤ –∫–æ–¥');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
    let supabaseClient;
    try {
        if (window.supabase) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('‚úÖ Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω');
        } else {
            throw new Error('Supabase CDN –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è');
        }
    } catch (e) {
        console.error('‚ùå –û—à–∏–±–∫–∞ Supabase:', e);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: ' + e.message);
    }

    // Telegram WebApp
    let tg = window.Telegram.WebApp;
    let cart = [];
    let userPoints = 0;
    let userId = tg.initDataUnsafe?.user?.id || 99999;
    let userName = tg.initDataUnsafe?.user?.first_name || '–ì–æ—Å—Ç—å';
    let userUsername = tg.initDataUnsafe?.user?.username || 'unknown';

    // –¢–æ–≤–∞—Ä—ã
    const products = [
        { id: 1, name: '–õ–∞–≤–∞–Ω–¥–∞', price: 450, desc: '–£—Å–ø–æ–∫–∞–∏–≤–∞—é—â–µ–µ, 10–º–ª', img: 'https://via.placeholder.com/60/9090ff/ffffff?text=Lav' },
        { id: 2, name: '–ß–∞–π–Ω–æ–µ –¥–µ—Ä–µ–≤–æ', price: 390, desc: '–ê–Ω—Ç–∏—Å–µ–ø—Ç–∏–∫, 10–º–ª', img: 'https://via.placeholder.com/60/90ff90/ffffff?text=Tea' },
        { id: 3, name: '–ì–∏–¥—Ä–æ–ª–∞—Ç –†–æ–∑—ã', price: 600, desc: '–£–≤–ª–∞–∂–Ω–µ–Ω–∏–µ, 100–º–ª', img: 'https://via.placeholder.com/60/ff9090/ffffff?text=Rose' },
        { id: 4, name: '–ê–ø–µ–ª—å—Å–∏–Ω', price: 300, desc: '–¢–æ–Ω—É—Å, 10–º–ª', img: 'https://via.placeholder.com/60/ffaa00/ffffff?text=Ora' },
    ];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    tg.expand();
    tg.ready();
    
    document.getElementById('user-name').innerText = userName;
    document.getElementById('user-id-display').innerText = userId;

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    initApp();

    async function initApp() {
        try {
            if (supabaseClient) {
                await loadUserBalance();
            } else {
                console.warn('Supabase –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ–º –±–µ–∑ –±–∞–∑—ã');
                userPoints = 0;
            }
            renderCatalog();
            updatePointsUI();
            document.getElementById('loader').style.display = 'none';
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', e);
            alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ' + e.message);
            document.getElementById('loader').style.display = 'none';
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
    async function loadUserBalance() {
        if (!supabaseClient) return;
        
        try {
            let {  user, error } = await supabaseClient
                .from('users')
                .select('balance')
                .eq('id', userId)
                .single();

            if (error || !user) {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await supabaseClient.from('users').insert([{ 
                    id: userId, 
                    username: userUsername, 
                    balance: 0 
                }]);
                userPoints = 0;
            } else {
                userPoints = user.balance;
            }
            console.log('‚úÖ –ë–∞–ª–∞–Ω—Å –∑–∞–≥—Ä—É–∂–µ–Ω:', userPoints);
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:', e);
            alert('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–ª–∞–Ω—Å');
        }
    }

    // –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
    async function checkout() {
        if (cart.length === 0) {
            alert('üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!');
            return;
        }
        
        const usePoints = document.getElementById('use-points').checked;
        let totalRaw = cart.reduce((sum, item) => sum + item.price, 0);
        let pointsUsed = 0;
        let finalPrice = totalRaw;

        if (usePoints && userPoints > 0) {
            if (userPoints >= totalRaw) {
                pointsUsed = totalRaw;
                finalPrice = 0;
            } else {
                pointsUsed = userPoints;
                finalPrice = totalRaw - userPoints;
            }
        }

        const confirmMsg = `üì¶ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞\n\n` +
                          `üí∞ –°—É–º–º–∞: ${finalPrice} ‚ÇΩ\n` +
                          `üéÅ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–ª–ª–æ–≤: ${pointsUsed}\n\n` +
                          `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`;
        
        if (confirm(confirmMsg)) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º loader
            document.getElementById('loader').style.display = 'flex';
            document.querySelector('.loader-text').innerText = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–∞...';
            
            try {
                if (!supabaseClient) throw new Error('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞');
                
                // –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑
                const { error: orderError } = await supabaseClient.from('orders').insert([{
                    user_id: userId,
                    username: userUsername,
                    items: cart.map(i => i.name).join(', '),
                    total_amount: totalRaw,
                    points_used: pointsUsed
                }]);

                if (orderError) throw orderError;

                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
                const pointsEarned = Math.floor(totalRaw * 0.1);
                const newBalance = userPoints - pointsUsed + pointsEarned;

                const { error: updateError } = await supabaseClient
                    .from('users')
                    .update({ balance: newBalance })
                    .eq('id', userId);

                if (updateError) throw updateError;

                userPoints = newBalance;
                cart = [];
                updateBadge();
                renderCart();
                updatePointsUI();
                
                alert('‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!\n\n–ù–∞—á–∏—Å–ª–µ–Ω–æ –±–∞–ª–ª–æ–≤: ' + pointsEarned + '\n–í–∞—à –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ' + newBalance);
                switchPage('catalog');
                
            } catch (e) {
                console.error(e);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏: ' + e.message);
            } finally {
                // –°–∫—Ä—ã–≤–∞–µ–º loader
                document.getElementById('loader').style.display = 'none';
                document.querySelector('.loader-text').innerText = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            }
        }
    }

    // –ê–¥–º–∏–Ω–∫–∞
    async function adminAction() {
        const pass = document.getElementById('admin-pass').value;
        const targetId = document.getElementById('admin-user-id').value;
        const amount = parseInt(document.getElementById('admin-points-amount').value);

        if (pass !== ADMIN_PASS) {
            alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞');
            return;
        }
        if (!targetId || isNaN(amount)) {
            alert('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º loader
        document.getElementById('loader').style.display = 'flex';
        document.querySelector('.loader-text').innerText = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
        
        try {
            if (!supabaseClient) throw new Error('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞');
            
            let {  userData } = await supabaseClient
                .from('users')
                .select('balance')
                .eq('id', targetId)
                .single();
            
            let currentBalance = userData ? userData.balance : 0;
            
            if (!userData) {
                await supabaseClient.from('users').insert([{ 
                    id: targetId, 
                    username: 'admin_created', 
                    balance: 0 
                }]);
            }

            const newBalance = currentBalance + amount;

            await supabaseClient
                .from('users')
                .update({ balance: newBalance })
                .eq('id', targetId);

            alert(`‚úÖ –ë–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω–µ–Ω!\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${targetId}\n–ë—ã–ª–æ: ${currentBalance}\n–°—Ç–∞–ª–æ: ${newBalance}`);
            
            if (targetId == userId) {
                userPoints = newBalance;
                updatePointsUI();
            }

        } catch (e) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + e.message);
        } finally {
            // –°–∫—Ä—ã–≤–∞–µ–º loader
            document.getElementById('loader').style.display = 'none';
            document.querySelector('.loader-text').innerText = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        }
    }

    // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    function updatePointsUI() {
        document.getElementById('profile-points').innerText = userPoints;
        document.getElementById('cart-points').innerText = userPoints;
    }

    function renderCatalog() {
        const container = document.getElementById('products-list');
        container.innerHTML = products.map(p => `
            <div class="product-card">
                <img src="${p.img}" class="product-img">
                <div class="product-info">
                    <div class="product-title">${p.name}</div>
                    <div class="product-desc">${p.desc}</div>
                    <div class="product-price">${p.price} ‚ÇΩ</div>
                </div>
                <button class="add-btn" onclick="addToCart(${p.id})">–í –∫–æ—Ä–∑–∏–Ω—É</button>
            </div>
        `).join('');
    }

    function switchPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        
        document.getElementById(`page-${pageId}`).classList.add('active');
        const icons = {'catalog': 0, 'cart': 1, 'profile': 2};
        document.querySelectorAll('.nav-item')[icons[pageId]].classList.add('active');

        if(pageId === 'cart') renderCart();
    }

    function addToCart(id) {
        const product = products.find(p => p.id === id);
        cart.push(product);
        updateBadge();
        if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    function updateBadge() {
        const badge = document.getElementById('cart-badge');
        badge.innerText = cart.length;
        badge.classList.toggle('hidden', cart.length === 0);
    }

    function renderCart() {
        const container = document.getElementById('cart-items');
        if (cart.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ üòî</p>';
            document.getElementById('cart-total').innerText = 0;
            return;
        }

        let total = 0;
        container.innerHTML = cart.map((item, index) => {
            total += item.price;
            return `
            <div class="cart-item">
                <span>${item.name}</span>
                <span>${item.price} ‚ÇΩ <b style="color:red; cursor:pointer; margin-left:10px" onclick="removeFromCart(${index})">√ó</b></span>
            </div>`;
        }).join('');

        document.getElementById('cart-total').innerText = total;
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
        updateBadge();
    }
</script>
