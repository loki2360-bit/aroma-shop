<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AromaShop Supabase</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --button-color: var(--tg-theme-button-color, #3390ec);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f4f4f5);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; padding-bottom: 80px; }
        
        .nav { position: fixed; bottom: 0; width: 100%; background: var(--bg-color); border-top: 1px solid var(--hint-color); display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; }
        .nav-item { font-size: 12px; text-align: center; color: var(--hint-color); cursor: pointer; }
        .nav-item.active { color: var(--button-color); font-weight: bold; }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }

        .page { display: none; padding: 15px; }
        .page.active { display: block; }
        
        .product-card { display: flex; background: var(--secondary-bg); border-radius: 12px; padding: 10px; margin-bottom: 15px; align-items: center; }
        .product-img { width: 60px; height: 60px; background: #ddd; border-radius: 8px; margin-right: 15px; object-fit: cover; }
        .product-info { flex: 1; }
        .product-title { font-weight: bold; font-size: 16px; margin-bottom: 4px; }
        .product-desc { font-size: 12px; color: var(--hint-color); margin-bottom: 6px; }
        .product-price { font-weight: bold; color: var(--button-color); }
        .add-btn { background: var(--button-color); color: var(--button-text-color); border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; }

        .cart-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--secondary-bg); }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--hint-color); border-radius: 8px; background: var(--secondary-bg); color: var(--text-color); box-sizing: border-box; }
        .main-btn { width: 100%; padding: 15px; background: var(--button-color); color: var(--button-text-color); border: none; border-radius: 12px; font-size: 16px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        
        .hidden { display: none; }
        .badge { background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; position: absolute; top: -5px; right: -5px; }
        .nav-item { position: relative; }
        
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 200; font-weight: bold;}
    </style>
</head>
<body>

<div id="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<!-- –ö–ê–¢–ê–õ–û–ì -->
<div id="page-catalog" class="page active">
    <h2>üåø –≠—Ñ–∏—Ä–Ω—ã–µ –º–∞—Å–ª–∞</h2>
    <div id="products-list"></div>
</div>

<!-- –ö–û–†–ó–ò–ù–ê -->
<div id="page-cart" class="page">
    <h2>üõí –ö–æ—Ä–∑–∏–Ω–∞</h2>
    <div id="cart-items"></div>
    <div style="margin-top: 20px; text-align: right;">
        <p>–ò—Ç–æ–≥–æ: <span id="cart-total">0</span> ‚ÇΩ</p>
        <p>–í–∞—à–∏ –±–∞–ª–ª—ã: <span id="cart-points" style="color:var(--button-color)">0</span></p>
        <label style="font-size: 12px; display:flex; align-items:center; justify-content:flex-end;">
            <input type="checkbox" id="use-points" onchange="renderCart()" style="width:auto; margin:0 5px;"> 
            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–ª–ª—ã (1 –±–∞–ª–ª = 1‚ÇΩ)
        </label>
    </div>
    <button class="main-btn" onclick="checkout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
</div>

<!-- –ü–†–û–§–ò–õ–¨ –ò –ê–î–ú–ò–ù–ö–ê -->
<div id="page-profile" class="page">
    <h2>üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
    <div style="background: var(--secondary-bg); padding: 15px; border-radius: 12px; text-align: center;">
        <h3 id="user-name">–ì–æ—Å—Ç—å</h3>
        <h1 style="color: var(--button-color); margin: 10px 0;"><span id="profile-points">0</span> –±–∞–ª–ª–æ–≤</h1>
        <p style="font-size: 12px; color: var(--hint-color);">ID: <span id="user-id-display"></span></p>
    </div>
    
    <h3 style="margin-top: 25px; border-top: 1px solid var(--hint-color); padding-top:15px;">üîß –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞</h3>
    <input type="password" id="admin-pass" placeholder="–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞ (1234)">
    <input type="text" id="admin-user-id" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è">
    <input type="number" id="admin-points-amount" placeholder="–°—É–º–º–∞ (+ –Ω–∞—á–∏—Å–ª–∏—Ç—å, - —Å–ø–∏—Å–∞—Ç—å)">
    <button class="main-btn" style="background-color: #ff4757;" onclick="adminAction()">–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
    
    <h3 style="margin-top: 25px;">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
    <div id="orders-history" style="font-size: 12px; color: var(--hint-color);"></div>
</div>

<!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
<div class="nav">
    <div class="nav-item active" onclick="switchPage('catalog')">
        <span class="nav-icon">üåø</span>–ö–∞—Ç–∞–ª–æ–≥
    </div>
    <div class="nav-item" onclick="switchPage('cart')">
        <span class="nav-icon">üõí</span>–ö–æ—Ä–∑–∏–Ω–∞
        <span id="cart-badge" class="badge hidden">0</span>
    </div>
    <div class="nav-item" onclick="switchPage('profile')">
        <span class="nav-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å
    </div>
</div>

<script>
    // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø SUPABASE ---
    const SUPABASE_URL = 'https://npfaxtdsugsvpkolcdlx.supabase.co'; // –í—Å—Ç–∞–≤—å—Ç–µ URL –ø—Ä–æ–µ–∫—Ç–∞
    const SUPABASE_KEY = 'sb_publishable_5v77xILnnkRn4SlEM80OhQ_bGs3vNcn'; // –í—Å—Ç–∞–≤—å—Ç–µ Anon Key
    const ADMIN_PASS = '1234'; // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä–æ–ª—å –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- –î–ê–ù–ù–´–ï –¢–û–í–ê–†–û–í ---
    const products = [
        { id: 1, name: '–õ–∞–≤–∞–Ω–¥–∞', price: 450, desc: '–£—Å–ø–æ–∫–∞–∏–≤–∞—é—â–µ–µ, 10–º–ª', img: 'https://via.placeholder.com/60/9090ff/ffffff?text=Lav' },
        { id: 2, name: '–ß–∞–π–Ω–æ–µ –¥–µ—Ä–µ–≤–æ', price: 390, desc: '–ê–Ω—Ç–∏—Å–µ–ø—Ç–∏–∫, 10–º–ª', img: 'https://via.placeholder.com/60/90ff90/ffffff?text=Tea' },
        { id: 3, name: '–ì–∏–¥—Ä–æ–ª–∞—Ç –†–æ–∑—ã', price: 600, desc: '–£–≤–ª–∞–∂–Ω–µ–Ω–∏–µ, 100–º–ª', img: 'https://via.placeholder.com/60/ff9090/ffffff?text=Rose' },
        { id: 4, name: '–ê–ø–µ–ª—å—Å–∏–Ω', price: 300, desc: '–¢–æ–Ω—É—Å, 10–º–ª', img: 'https://via.placeholder.com/60/ffaa00/ffffff?text=Ora' },
    ];

    // --- –°–û–°–¢–û–Ø–ù–ò–ï ---
    let tg = window.Telegram.WebApp;
    let cart = [];
    let userPoints = 0;
    // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram –∏–ª–∏ —Å—Ç–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫—É –¥–ª—è —Ç–µ—Å—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
    let userId = tg.initDataUnsafe?.user?.id || 99999; 
    let userName = tg.initDataUnsafe?.user?.first_name || '–ì–æ—Å—Ç—å';
    let userUsername = tg.initDataUnsafe?.user?.username || 'unknown';

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    tg.expand();
    tg.ready();
    document.getElementById('user-name').innerText = userName;
    document.getElementById('user-id-display').innerText = userId;

    initApp();

    async function initApp() {
        await loadUserBalance();
        renderCatalog();
        document.getElementById('loader').style.display = 'none';
    }

    // --- –†–ê–ë–û–¢–ê –° –ë–ê–ó–û–ô (SUPABASE) ---
    
    // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function loadUserBalance() {
        // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let { data: user, error } = await supabase
            .from('users')
            .select('balance')
            .eq('id', userId)
            .single();

        if (error || !user) {
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ —Å –Ω—É–ª–µ–≤—ã–º –±–∞–ª–∞–Ω—Å–æ–º
            await supabase.from('users').insert([{ id: userId, username: userUsername, balance: 0 }]);
            userPoints = 0;
        } else {
            userPoints = user.balance;
        }
        updatePointsUI();
    }

    // 2. –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
    async function checkout() {
        if (cart.length === 0) return alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
        
        const usePoints = document.getElementById('use-points').checked;
        let totalRaw = cart.reduce((sum, item) => sum + item.price, 0);
        let pointsUsed = 0;
        let finalPrice = totalRaw;

        // –õ–æ–≥–∏–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤
        if (usePoints && userPoints > 0) {
            if (userPoints >= totalRaw) {
                pointsUsed = totalRaw;
                finalPrice = 0;
            } else {
                pointsUsed = userPoints;
                finalPrice = totalRaw - userPoints;
            }
        }

        const confirmMsg = `–û–ø–ª–∞—Ç–∏—Ç—å ${finalPrice} ‚ÇΩ?\n–ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –±–∞–ª–ª–æ–≤: ${pointsUsed}`;
        
        tg.showConfirm(confirmMsg, async (confirm) => {
            if (confirm) {
                tg.showLoading();
                try {
                    // 1. –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑
                    const { error: orderError } = await supabase.from('orders').insert([{
                        user_id: userId,
                        username: userUsername,
                        items: cart.map(i => i.name).join(', '),
                        total_amount: totalRaw,
                        points_used: pointsUsed
                    }]);

                    if (orderError) throw orderError;

                    // 2. –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    // –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å = (–°—Ç–∞—Ä—ã–π - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ) + (–ù–∞—á–∏—Å–ª–µ–Ω–æ 10% –æ—Ç –ø–æ–ª–Ω–æ–π —Å—É–º–º—ã)
                    const pointsEarned = Math.floor(totalRaw * 0.1);
                    const newBalance = userPoints - pointsUsed + pointsEarned;

                    const { error: updateError } = await supabase
                        .from('users')
                        .update({ balance: newBalance })
                        .eq('id', userId);

                    if (updateError) throw updateError;

                    // –£—Å–ø–µ—Ö
                    userPoints = newBalance;
                    cart = [];
                    updateBadge();
                    renderCart();
                    updatePointsUI();
                    alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!');
                    switchPage('catalog');
                    
                } catch (e) {
                    console.error(e);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏: ' + e.message);
                } finally {
                    tg.hideLoading();
                }
            }
        });
    }

    // 3. –ê–¥–º–∏–Ω–∫–∞ (–ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞)
    async function adminAction() {
        const pass = document.getElementById('admin-pass').value;
        const targetId = document.getElementById('admin-user-id').value;
        const amount = parseInt(document.getElementById('admin-points-amount').value);

        if (pass !== ADMIN_PASS) return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞');
        if (!targetId || isNaN(amount)) return alert('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ ID –∏ —Å—É–º–º—É');

        tg.showLoading();
        try {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å
            let { data: userData } = await supabase.from('users').select('balance').eq('id', targetId).single();
            
            let currentBalance = 0;
            if (userData) {
                currentBalance = userData.balance;
            } else {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, —Å–æ–∑–¥–∞–¥–∏–º –µ–≥–æ
                await supabase.from('users').insert([{ id: targetId, username: 'admin_created', balance: 0 }]);
            }

            const newBalance = currentBalance + amount;

            // –û–±–Ω–æ–≤–ª—è–µ–º
            const { error } = await supabase.from('users').update({ balance: newBalance }).eq('id', targetId);
            
            if (error) throw error;

            alert(`–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${targetId} –∏–∑–º–µ–Ω–µ–Ω!\n–ë—ã–ª–æ: ${currentBalance}\n–°—Ç–∞–ª–æ: ${newBalance}`);
            
            // –ï—Å–ª–∏ –º–µ–Ω—è–ª–∏ —Å–µ–±–µ
            if (targetId == userId) {
                userPoints = newBalance;
                updatePointsUI();
            }

        } catch (e) {
            alert('–û—à–∏–±–∫–∞: ' + e.message);
        } finally {
            tg.hideLoading();
        }
    }

    // --- –ò–ù–¢–ï–†–§–ï–ô–° ---

    function updatePointsUI() {
        document.getElementById('profile-points').innerText = userPoints;
        document.getElementById('cart-points').innerText = userPoints;
    }

    function renderCatalog() {
        const container = document.getElementById('products-list');
        container.innerHTML = products.map(p => `
            <div class="product-card">
                <img src="${p.img}" class="product-img">
                <div class="product-info">
                    <div class="product-title">${p.name}</div>
                    <div class="product-desc">${p.desc}</div>
                    <div class="product-price">${p.price} ‚ÇΩ</div>
                </div>
                <button class="add-btn" onclick="addToCart(${p.id})">–í –∫–æ—Ä–∑–∏–Ω—É</button>
            </div>
        `).join('');
    }

    function switchPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        
        document.getElementById(`page-${pageId}`).classList.add('active');
        const icons = {'catalog': 0, 'cart': 1, 'profile': 2};
        document.querySelectorAll('.nav-item')[icons[pageId]].classList.add('active');

        if(pageId === 'cart') renderCart();
        if(pageId === 'profile') loadOrderHistory();
    }

    function addToCart(id) {
        const product = products.find(p => p.id === id);
        cart.push(product);
        updateBadge();
        tg.HapticFeedback.impactOccurred('light');
    }

    function updateBadge() {
        const badge = document.getElementById('cart-badge');
        badge.innerText = cart.length;
        badge.classList.toggle('hidden', cart.length === 0);
    }

    function renderCart() {
        const container = document.getElementById('cart-items');
        if (cart.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:var(--hint-color); margin-top:20px">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ üòî</p>';
            document.getElementById('cart-total').innerText = 0;
            return;
        }

        let total = 0;
        container.innerHTML = cart.map((item, index) => {
            total += item.price;
            return `
            <div class="cart-item">
                <span>${item.name}</span>
                <span>${item.price} ‚ÇΩ <b style="color:red; cursor:pointer; margin-left:10px" onclick="removeFromCart(${index})">√ó</b></span>
            </div>`;
        }).join('');

        document.getElementById('cart-total').innerText = total;
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
        updateBadge();
    }
    
    async function loadOrderHistory() {
        const container = document.getElementById('orders-history');
        container.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        
        const { data, error } = await supabase
            .from('orders')
            .select('*')
            .eq('user_id', userId)
            .order('created_at', { ascending: false })
            .limit(5);
            
        if (error || !data || data.length === 0) {
            container.innerHTML = '–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç';
            return;
        }
        
        container.innerHTML = data.map(o => `
            <div style="padding: 5px 0; border-bottom:1px solid #eee">
                <b>${new Date(o.created_at).toLocaleDateString()}</b>: ${o.items}<br>
                –°—É–º–º–∞: ${o.total_amount}‚ÇΩ (–ë–∞–ª–ª—ã: ${o.points_used})
            </div>
        `).join('');
    }
</script>

</body>
</html>
