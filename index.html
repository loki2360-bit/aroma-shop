<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>–ö–∞–±–∏–Ω–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --bg: #22262A;
  --card: #2B3036;
  --text: #E0E4E9;
  --text-muted: #A0A7B0;
  --text-inverse: #12161A;
  --accent: #FF6D1A; /* –æ—Ä–∞–Ω–∂–µ–≤—ã–π –∫–∞–∫ —É –Ø–Ω–¥–µ–∫—Å–∞, –Ω–æ –≤ —Ç–µ–º–Ω–æ–π –ø–∞–ª–∏—Ç—Ä–µ */
  --border: #3A404A;
  --shadow: rgba(0, 0, 0, 0.3);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

body {
  background: var(--bg);
  color: var(--text);
  padding: 16px;
  min-height: 100vh;
  line-height: 1.5;
}

.container {
  max-width: 768px;
  margin: 0 auto;
  background: var(--card);
  border-radius: 16px;
  box-shadow: 0 4px 20px var(--shadow);
  overflow: hidden;
  font-size: 15px;
}

/* Tabs ‚Äî –∫–∞–∫ –≤ Fullscarian: –ø–ª–æ—Å–∫–∏–µ, –±–µ–∑ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è */
.tabs {
  display: flex;
  background: var(--card);
  border-bottom: 1px solid var(--border);
}
.tab-btn {
  flex: 1;
  padding: 14px 12px;
  background: transparent;
  border: none;
  font-weight: 500;
  color: var(--text-muted);
  cursor: pointer;
  transition: color 0.2s;
}
.tab-btn.active {
  color: var(--accent);
  font-weight: 600;
}
.tab-btn:hover:not(.active) {
  color: var(--text);
}

/* Header */
.header {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 18px 16px;
  background: var(--card);
  border-bottom: 1px solid var(--border);
}
.avatar {
  width: 52px;
  height: 52px;
  border-radius: 50%;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: white;
  font-size: 18px;
  flex-shrink: 0;
}
.info h2 {
  font-size: 1.3rem;
  font-weight: 600;
  margin-bottom: 4px;
}
.info p {
  font-size: 1rem;
  color: var(--text-muted);
}

/* Plan Box ‚Äî –∫–∞–∫ Fullscarian: –∑–∞–≥–æ–ª–æ–≤–æ–∫ + –ø—Ä–æ–≥—Ä–µ—Å—Å + –º–µ—Ç–∫–∞ —Å–ø—Ä–∞–≤–∞ */
.plan-box {
  padding: 18px 16px;
  background: var(--card);
  margin: 16px;
  border-radius: 12px;
  border: 1px solid var(--border);
}
.plan-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--accent);
}
.progress-container {
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
  margin: 8px 0;
}
.progress-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 3px;
  transition: width 0.4s ease;
}
.progress-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.9rem;
  color: var(--text-muted);
  margin: 6px 0;
}
.shift-status {
  font-size: 0.9rem;
  color: var(--text-muted);
  margin: 6px 0 0;
  font-style: italic;
}

/* Section title */
.section-title {
  font-size: 1.2rem;
  font-weight: 600;
  margin: 20px 0 14px;
  padding: 0 16px;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--accent);
}

/* Form */
.form-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 14px;
  padding: 0 16px 16px;
}
@media (min-width: 600px) {
  .form-grid {
    grid-template-columns: 1fr 1fr;
  }
}
.form-group {
  margin: 0;
}
label {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
  font-size: 0.9rem;
  color: var(--text);
}
input, select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  background: var(--card);
  color: var(--text);
  transition: border-color 0.2s;
}
input:focus, select:focus {
  outline: none;
  border-color: var(--accent);
}

/* Buttons ‚Äî –∫–∞–∫ –≤ Fullscarian: –ø–ª–æ—Å–∫–∏–µ, —Å –∑–∞–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º, –±–µ–∑ —Ç–µ–Ω–µ–π */
.btn-row {
  display: flex;
  gap: 10px;
  padding: 0 16px 16px;
  flex-wrap: wrap;
}
button {
  flex: 1;
  min-width: 120px;
  border: none;
  border-radius: 8px;
  padding: 11px;
  font-weight: 500;
  font-size: 14px;
  cursor: pointer;
  background: var(--border);
  color: var(--text);
  transition: background 0.2s;
}
button:hover {
  background: #3A404A;
}
.btn-accent {
  background: white;
  color: var(--text-inverse);
}
.btn-accent:hover {
  background: #f5f5f5;
}
.btn-outline {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
}
.btn-outline:hover {
  background: var(--border);
}

/* Action buttons in table ‚Äî –º–∞–ª–µ–Ω—å–∫–∏–µ, –∫—Ä—É–≥–ª—ã–µ, –∫–∞–∫ –≤ Fullscarian */
.btn-action {
  width: 32px;
  height: 32px;
  min-width: auto;
  padding: 0;
  border: none;
  border-radius: 6px;
  background: var(--border);
  color: var(--text);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.2s;
}
.btn-action:hover {
  background: #3A404A;
}
.btn-action i {
  font-size: 14px;
}

/* Orders list */
.date-label, .preorders-label {
  font-weight: 600;
  color: var(--accent);
  margin: 16px 0 12px;
  padding: 0 16px;
  display: block;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  margin: 0 16px 16px;
}
th {
  background: var(--card);
  padding: 10px 8px;
  text-align: left;
  font-weight: 500;
  border-bottom: 1px solid var(--border);
  color: var(--accent);
}
td {
  padding: 10px 8px;
  border-bottom: 1px solid var(--border);
  color: var(--text);
}
.amount {
  font-weight: 600;
  color: var(--accent);
}
.empty-msg {
  text-align: center;
  color: var(--text-muted);
  padding: 20px 16px;
  font-style: italic;
}
.hint {
  text-align: center;
  margin: 20px 16px;
  padding: 12px;
  color: var(--text-muted);
  font-size: 13px;
  border: 1px dashed var(--border);
  border-radius: 8px;
  background: var(--card);
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}
.modal.active {
  display: flex;
}
.modal-content {
  background: var(--card);
  padding: 24px;
  border-radius: 12px;
  max-width: 400px;
  width: 90%;
  border: 1px solid var(--border);
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}
.modal-title {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--accent);
}
.modal-row {
  margin-bottom: 16px;
}
.modal-buttons {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}
.details-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}
.details-label {
  font-weight: 500;
  color: var(--text);
}
.details-value {
  color: var(--accent);
}
</style>
</head>
<body>
<div class="container">
<!-- Tabs -->
<div class="tabs">
<button class="tab-btn active" onclick="switchTab('main')">–û—Å–Ω–æ–≤–Ω–æ–µ</button>
<button class="tab-btn" onclick="switchTab('preorders')">–ü—Ä–µ–¥–∑–∞–∫–∞–∑—ã</button>
<button class="tab-btn" onclick="switchTab('tips')">–ß–∞–µ–≤—ã–µ</button>
</div>

<!-- Main Tab -->
<div id="main-tab">
<!-- Header -->
<div class="header">
<div class="avatar"><i class="fas fa-user"></i></div>
<div class="info">
<h2>–û–ø–µ—Ä–∞—Ç–æ—Ä ‚Ññ<span id="opId">1</span></h2>
<p>–í—Å–µ–≥–æ: <b><span id="totalAll">0.00</span> ‚ÇΩ</b></p>
</div>
</div>

<!-- Plan Box -->
<div class="plan-box">
<div class="plan-title">
<span>–ü–ª–∞–Ω: <b>3000 ‚ÇΩ</b></span>
<span><b><span id="todayEarned">0.00</span> ‚ÇΩ</b></span>
</div>
<div class="progress-container">
<div class="progress-fill" id="progressFill"></div>
</div>
<div class="progress-label">
<span>–¢–µ–∫—É—â–∞—è —Å–º–µ–Ω–∞</span>
<span><b><span id="shiftStatus">–°–º–µ–Ω–∞ –Ω–µ –Ω–∞—á–∞—Ç–∞</span></b></span>
</div>
</div>

<!-- Shift Controls -->
<div class="btn-row">
<button class="btn-accent" onclick="startShift()">
<i class="fas fa-play"></i> –ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É
</button>
<button class="btn-accent" onclick="endShift()">
<i class="fas fa-stop"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É
</button>
</div>

<!-- Create Order -->
<div class="section-title">
<i class="fas fa-plus"></i> –ù–æ–≤—ã–π –∑–∞–∫–∞–∑
</div>
<div class="form-grid">
<div class="form-group">
<label>‚Ññ –∑–∞–∫–∞–∑–∞</label>
<input type="text" id="orderNum" placeholder="–ù–∞–ø—Ä.: ORD-001" required>
</div>
<div class="form-group">
<label>–¢–∞—Ä–∏—Ñ</label>
<select id="tariff">
<option value="RASPIL_M2">–†–∞—Å–ø–∏–ª ‚Äî 65 ‚ÇΩ/–º¬≤</option>
<option value="LINEAR_RASPIL">–õ–∏–Ω. —Ä–∞—Å–ø–∏–ª ‚Äî 26 ‚ÇΩ/–º</option>
<option value="SKLEIKA_OB">–°–∫–ª–µ–π–∫–∞ + ‚Äî 210 ‚ÇΩ/–º¬≤</option>
<option value="SKLEIKA_NO_OB">–°–∫–ª–µ–π–∫–∞ ‚Äì ‚Äî 165 ‚ÇΩ/–º¬≤</option>
<option value="PAZY">–ü–∞–∑—ã ‚Äî 30 ‚ÇΩ/–º</option>
<option value="FREZER_FASKA">–§–∞—Å–∫–∞ ‚Äî 16 ‚ÇΩ/–º</option>
<option value="TIME">–í—Ä–µ–º—è ‚Äî 330 ‚ÇΩ/—á</option>
</select>
</div>
<div class="form-group">
<label>–î–µ—Ç–∞–ª—å</label>
<input type="text" id="detail" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
</div>
<div class="form-group">
<label>–ö–æ–ª-–≤–æ</label>
<input type="number" id="qty" value="1" min="1">
</div>
<div class="form-group" id="lengthGroup">
<label>–î–ª–∏–Ω–∞ (–º)</label>
<input type="number" step="0.01" id="length" placeholder="0.00">
</div>
<div class="form-group hidden" id="widthGroup">
<label>–®–∏—Ä–∏–Ω–∞ (–º)</label>
<input type="number" step="0.01" id="width" placeholder="0.00">
</div>
<div class="form-group hidden" id="hoursGroup">
<label>–ß–∞—Å—ã</label>
<input type="number" step="0.1" id="hours" placeholder="0.0">
</div>
</div>

<div class="btn-row">
<button class="btn-accent" onclick="createMainOrder()">
<i class="fas fa-check"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
</button>
</div>

<!-- View Orders by Date -->
<div class="section-title">
<i class="fas fa-history"></i> –ó–∞–∫–∞–∑—ã –ø–æ –¥–∞—Ç–µ
</div>
<div class="form-grid">
<div class="form-group">
<label>–î–∞—Ç–∞</label>
<input type="date" id="viewDate" value="">
</div>
</div>
<div class="btn-row">
<button class="btn-accent" onclick="showOrdersByDate()">
<i class="fas fa-eye"></i> –ü–æ–∫–∞–∑–∞—Ç—å
</button>
<button class="btn-outline" onclick="saveOrdersToFile()">
<i class="fas fa-download"></i> –í TXT
</button>
<button class="btn-outline" onclick="saveOrdersToJSON()">
<i class="fas fa-file-code"></i> –í JSON
</button>
</div>
<div id="ordersList"></div>
</div>

<!-- Preorders Tab -->
<div id="preorders-tab" class="hidden">
<div class="section-title">
<i class="fas fa-clock"></i> –ü—Ä–µ–¥–∑–∞–∫–∞–∑—ã
</div>
<div class="form-grid">
<div class="form-group">
<label>‚Ññ –∑–∞–∫–∞–∑–∞</label>
<input type="text" id="preOrderNum" placeholder="–ù–∞–ø—Ä.: PRE-001" required>
</div>
<div class="form-group">
<label>–¢–∞—Ä–∏—Ñ</label>
<select id="preTariff">
<option value="RASPIL_M2">–†–∞—Å–ø–∏–ª ‚Äî 65 ‚ÇΩ/–º¬≤</option>
<option value="LINEAR_RASPIL">–õ–∏–Ω. —Ä–∞—Å–ø–∏–ª ‚Äî 26 ‚ÇΩ/–º</option>
<option value="SKLEIKA_OB">–°–∫–ª–µ–π–∫–∞ + ‚Äî 210 ‚ÇΩ/–º¬≤</option>
<option value="SKLEIKA_NO_OB">–°–∫–ª–µ–π–∫–∞ ‚Äì ‚Äî 165 ‚ÇΩ/–º¬≤</option>
<option value="PAZY">–ü–∞–∑—ã ‚Äî 30 ‚ÇΩ/–º</option>
<option value="FREZER_FASKA">–§–∞—Å–∫–∞ ‚Äî 16 ‚ÇΩ/–º</option>
<option value="TIME">–í—Ä–µ–º—è ‚Äî 330 ‚ÇΩ/—á</option>
</select>
</div>
<div class="form-group">
<label>–î–µ—Ç–∞–ª—å</label>
<input type="text" id="preDetail" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
</div>
<div class="form-group">
<label>–ö–æ–ª-–≤–æ</label>
<input type="number" id="preQty" value="1" min="1">
</div>
<div class="form-group" id="preLengthGroup">
<label>–î–ª–∏–Ω–∞ (–º)</label>
<input type="number" step="0.01" id="preLength" placeholder="0.00">
</div>
<div class="form-group hidden" id="preWidthGroup">
<label>–®–∏—Ä–∏–Ω–∞ (–º)</label>
<input type="number" step="0.01" id="preWidth" placeholder="0.00">
</div>
<div class="form-group hidden" id="preHoursGroup">
<label>–ß–∞—Å—ã</label>
<input type="number" step="0.1" id="preHours" placeholder="0.0">
</div>
</div>
<div class="btn-row">
<button class="btn-accent" onclick="createPreorder()">
<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–µ–¥–∑–∞–∫–∞–∑
</button>
<button class="btn-outline" onclick="document.getElementById('jsonImportInput').click()">
<i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å TXT/JSON
</button>
</div>
<input type="file" id="jsonImportInput" accept=".txt,.json" style="display: none;" />
<div class="preorders-label">–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–∑–∞–∫–∞–∑–æ–≤</div>
<div id="preordersList"></div>
</div>
<div class="hint">
üí° –ü—Ä–µ–¥–∑–∞–∫–∞–∑—ã –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –ø–ª–∞–Ω. –ù–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–∏–Ω—è—Ç—å¬ª, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω—ã–µ.
</div>
</div>

<!-- Tips Tab -->
<div id="tips-tab" class="hidden">
  <div class="section-title">
    <i class="fas fa-mug-hot"></i> –ß–∞–µ–≤—ã–µ
  </div>
  <div class="form-grid">
    <div class="form-group">
      <label>–°—É–º–º–∞ —á–∞–µ–≤—ã—Ö (‚ÇΩ)</label>
      <input type="number" id="tipAmount" placeholder="–ù–∞–ø—Ä.: 300" min="0" step="1">
    </div>
  </div>
  <div class="btn-row">
    <button class="btn-accent" onclick="addTip()">
      <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —á–∞–µ–≤—ã–µ
    </button>
  </div>
  <div style="padding: 0 16px 16px;">
    <div class="plan-box" style="margin: 16px 0;">
      <div class="plan-title">
        <span>–í—Å–µ–≥–æ –ø–∞–∫–µ—Ç–∏–∫–æ–≤</span>
        <span><b><span id="totalPacketsCount">0</span> —à—Ç</b></span>
      </div>
      <div class="progress-container">
        <div class="progress-fill" id="totalPacketsFill"></div>
      </div>
      <div class="progress-label">
        <span>–ù–∞–∫–æ–ø–ª–µ–Ω–æ</span>
        <span><b><span id="totalPacketsProgress">0%</span></b></span>
      </div>
    </div>
    <div class="plan-box" style="margin: 16px 0;">
      <div class="plan-title">
        <span>–°–µ–≥–æ–¥–Ω—è</span>
        <span><b><span id="todayPacketsCount">0</span> —à—Ç</b></span>
      </div>
      <div class="progress-container">
        <div class="progress-fill" id="todayPacketsFill"></div>
      </div>
      <div class="progress-label">
        <span>–ó–∞ —Å–µ–≥–æ–¥–Ω—è</span>
        <span><b><span id="todayPacketsProgress">0%</span></b></span>
      </div>
    </div>
    <div class="plan-box" style="margin: 16px 0;">
      <div class="plan-title">
        <span>–í—ã–ø–∏—Ç–æ —á–∞—è</span>
        <span><b><span id="teaLiters">0.0</span> –ª</b></span>
      </div>
      <div class="progress-label" style="margin-top: 10px;">
        <span>1 –ø–∞–∫–µ—Ç–∏–∫ = 200 –º–ª</span>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="editModal" class="modal">
<div class="modal-content">
<div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑</div>
<input type="hidden" id="editOrderId">
<div class="modal-row">
<label>‚Ññ –∑–∞–∫–∞–∑–∞</label>
<input type="text" id="editOrderNum">
</div>
<div class="modal-row">
<label>–î–µ—Ç–∞–ª—å</label>
<input type="text" id="editDetail">
</div>
<div class="modal-row">
<label>–¢–∞—Ä–∏—Ñ</label>
<select id="editTariff">
<option value="RASPIL_M2">–†–∞—Å–ø–∏–ª ‚Äî 65 ‚ÇΩ/–º¬≤</option>
<option value="LINEAR_RASPIL">–õ–∏–Ω. —Ä–∞—Å–ø–∏–ª ‚Äî 26 ‚ÇΩ/–º</option>
<option value="SKLEIKA_OB">–°–∫–ª–µ–π–∫–∞ + ‚Äî 210 ‚ÇΩ/–º¬≤</option>
<option value="SKLEIKA_NO_OB">–°–∫–ª–µ–π–∫–∞ ‚Äì ‚Äî 165 ‚ÇΩ/–º¬≤</option>
<option value="PAZY">–ü–∞–∑—ã ‚Äî 30 ‚ÇΩ/–º</option>
<option value="FREZER_FASKA">–§–∞—Å–∫–∞ ‚Äî 16 ‚ÇΩ/–º</option>
<option value="TIME">–í—Ä–µ–º—è ‚Äî 330 ‚ÇΩ/—á</option>
</select>
</div>
<div class="modal-row">
<label>–ö–æ–ª-–≤–æ</label>
<input type="number" id="editQty" min="1">
</div>
<div class="modal-row" id="editLengthGroup">
<label>–î–ª–∏–Ω–∞ (–º)</label>
<input type="number" step="0.01" id="editLength">
</div>
<div class="modal-row hidden" id="editWidthGroup">
<label>–®–∏—Ä–∏–Ω–∞ (–º)</label>
<input type="number" step="0.01" id="editWidth">
</div>
<div class="modal-row hidden" id="editHoursGroup">
<label>–ß–∞—Å—ã</label>
<input type="number" step="0.1" id="editHours">
</div>
<div class="modal-buttons">
<button class="btn-outline" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
<button class="btn-accent" onclick="saveEditedOrder()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>
</div>
</div>

<div id="dateModal" class="modal">
<div class="modal-content">
<div class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –∑–∞–∫–∞–∑–∞</div>
<div class="modal-row">
<label>–î–∞—Ç–∞</label>
<input type="date" id="modalDate">
</div>
<div class="modal-buttons">
<button class="btn-outline" onclick="closeDateModal()">–û—Ç–º–µ–Ω–∞</button>
<button class="btn-accent" onclick="confirmDateSelection()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
</div>
</div>
</div>

<div id="detailsModal" class="modal">
<div class="modal-content">
<div class="modal-title">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</div>
<div id="detailsContent"></div>
<div class="modal-buttons">
<button class="btn-outline" onclick="closeDetailsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>
</div>
</div>

<script>
// === –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ===
const TARIFFS = {
  RASPIL_M2: { price: 65, unit: 'm2' },
  LINEAR_RASPIL: { price: 26, unit: 'linear' },
  SKLEIKA_OB: { price: 210, unit: 'm2' },
  SKLEIKA_NO_OB: { price: 165, unit: 'm2' },
  PAZY: { price: 30, unit: 'linear' },
  FREZER_FASKA: { price: 16, unit: 'linear' },
  TIME: { price: 330, unit: 'time' }
};
const TARIFF_NAMES = {
  RASPIL_M2: '–†–∞—Å–ø–∏–ª',
  LINEAR_RASPIL: '–õ–∏–Ω. —Ä–∞—Å–ø–∏–ª',
  SKLEIKA_OB: '–°–∫–ª–µ–π–∫–∞ +',
  SKLEIKA_NO_OB: '–°–∫–ª–µ–π–∫–∞ ‚Äì',
  PAZY: '–ü–∞–∑—ã',
  FREZER_FASKA: '–§–∞—Å–∫–∞',
  TIME: '–í—Ä–µ–º—è'
};
const UNIT_LABELS = {
  m2: '–º¬≤',
  linear: '–ø–æ–≥. –º',
  time: '—á–∞—Å—ã'
};

// === –£—Ç–∏–ª–∏—Ç—ã ===
function formatDateYMD(dateStr) {
  const [y, m, d] = dateStr.split('-');
  return `${d}.${m}.${y}`;
}
function todayYMD() {
  return new Date().toISOString().split('T')[0];
}
function loadOrders() {
  try {
    return JSON.parse(localStorage.getItem('operator_orders') || '[]');
  } catch (e) { return []; }
}
function saveOrders(orders) {
  localStorage.setItem('operator_orders', JSON.stringify(orders));
}
function loadPreorders() {
  try {
    return JSON.parse(localStorage.getItem('operator_preorders') || '[]');
  } catch (e) { return []; }
}
function savePreorders(preorders) {
  localStorage.setItem('operator_preorders', JSON.stringify(preorders));
}
function getCurrentShift() {
  try {
    return JSON.parse(localStorage.getItem('current_shift') || 'null');
  } catch (e) { return null; }
}
function setCurrentShift(shift) {
  if (shift === null) {
    localStorage.removeItem('current_shift');
  } else {
    localStorage.setItem('current_shift', JSON.stringify(shift));
  }
}

// === –ß–∞–µ–≤—ã–µ ===
function loadTipsData() {
  try {
    return JSON.parse(localStorage.getItem('tea_tips_data') || '{}');
  } catch (e) {
    return {};
  }
}
function saveTipsData(data) {
  localStorage.setItem('tea_tips_data', JSON.stringify(data));
}
function updateTipsUI() {
  const data = loadTipsData();
  const today = todayYMD();
  const totalPackets = data.totalPackets || 0;
  const todayPackets = (data.daily && data.daily[today]) || 0;
  const teaLiters = (totalPackets * 0.2).toFixed(1);

  document.getElementById('totalPacketsCount').textContent = totalPackets;
  document.getElementById('todayPacketsCount').textContent = todayPackets;
  document.getElementById('teaLiters').textContent = teaLiters;

  // –ü—Ä–æ–≥—Ä–µ—Å—Å (–¥–æ 1000 –∏ 200 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ)
  const totalProgress = Math.min(100, totalPackets / 1000 * 100);
  const todayProgress = Math.min(100, todayPackets / 200 * 100);
  document.getElementById('totalPacketsFill').style.width = `${totalProgress}%`;
  document.getElementById('todayPacketsFill').style.width = `${todayProgress}%`;
  document.getElementById('totalPacketsProgress').textContent = `${Math.round(totalProgress)}%`;
  document.getElementById('todayPacketsProgress').textContent = `${Math.round(todayProgress)}%`;
}
function addTip() {
  const input = document.getElementById('tipAmount');
  const value = parseFloat(input.value);
  if (!value || value <= 0) {
    alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —á–∞–µ–≤—ã—Ö (–±–æ–ª—å—à–µ 0)');
    return;
  }
  const packets = Math.floor(value);
  const today = todayYMD();
  const data = loadTipsData();
  data.totalPackets = (data.totalPackets || 0) + packets;
  data.daily = data.daily || {};
  data.daily[today] = (data.daily[today] || 0) + packets;
  saveTipsData(data);
  input.value = '';
  updateTipsUI();
  alert(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${packets} —á–∞–π–Ω—ã—Ö –ø–∞–∫–µ—Ç–∏–∫–æ–≤!`);
}

// === –†–∞—Å—á—ë—Ç —Å—É–º–º—ã ===
function calculateAmount(tariffKey, length, width, hours, qty) {
  const tariff = TARIFFS[tariffKey];
  if (!tariff) return 0;
  let amount = 0;
  if (tariff.unit === 'time') {
    amount = tariff.price * hours * qty;
  } else if (tariff.unit === 'm2') {
    amount = tariff.price * length * width * qty;
  } else {
    amount = tariff.price * length * qty;
  }
  return Math.round(amount * 100) / 100;
}

// === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø–ª–∞–Ω–∞ ===
function updateUI() {
  const orders = loadOrders();
  const totalAll = orders.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
  const shift = getCurrentShift();
  let currentShiftAmount = 0;
  let progressWidth = 0;
  let statusText = '–°–º–µ–Ω–∞ –Ω–µ –Ω–∞—á–∞—Ç–∞';

  if (shift && shift.active) {
    currentShiftAmount = orders
      .filter(o => o.shiftId === shift.id)
      .reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
    progressWidth = Math.min(100, (currentShiftAmount / 3000) * 100);
    statusText = '–°–º–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞';
  } else if (shift && !shift.active) {
    currentShiftAmount = shift.finalAmount || 0;
    progressWidth = Math.min(100, (currentShiftAmount / 3000) * 100);
    statusText = '–°–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
  }

  document.getElementById('totalAll').textContent = totalAll.toFixed(2);
  document.getElementById('todayEarned').textContent = currentShiftAmount.toFixed(2);
  document.getElementById('progressFill').style.width = `${progressWidth}%`;
  document.getElementById('shiftStatus').textContent = statusText;
}

// === –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª–µ–π ===
function updateMainFormFields() {
  const tariff = document.getElementById('tariff').value;
  ['widthGroup', 'hoursGroup'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
  document.getElementById('lengthGroup')?.classList.remove('hidden');
  if (['RASPIL_M2', 'SKLEIKA_OB', 'SKLEIKA_NO_OB'].includes(tariff)) {
    document.getElementById('widthGroup')?.classList.remove('hidden');
  } else if (tariff === 'TIME') {
    document.getElementById('lengthGroup')?.classList.add('hidden');
    document.getElementById('hoursGroup')?.classList.remove('hidden');
  }
}
function updatePreorderFormFields() {
  const tariff = document.getElementById('preTariff').value;
  ['preWidthGroup', 'preHoursGroup'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
  document.getElementById('preLengthGroup')?.classList.remove('hidden');
  if (['RASPIL_M2', 'SKLEIKA_OB', 'SKLEIKA_NO_OB'].includes(tariff)) {
    document.getElementById('preWidthGroup')?.classList.remove('hidden');
  } else if (tariff === 'TIME') {
    document.getElementById('preLengthGroup')?.classList.add('hidden');
    document.getElementById('preHoursGroup')?.classList.remove('hidden');
  }
}
function updateEditFormFields() {
  const tariff = document.getElementById('editTariff').value;
  ['editWidthGroup', 'editHoursGroup'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
  document.getElementById('editLengthGroup')?.classList.remove('hidden');
  if (['RASPIL_M2', 'SKLEIKA_OB', 'SKLEIKA_NO_OB'].includes(tariff)) {
    document.getElementById('editWidthGroup')?.classList.remove('hidden');
  } else if (tariff === 'TIME') {
    document.getElementById('editLengthGroup')?.classList.add('hidden');
    document.getElementById('editHoursGroup')?.classList.remove('hidden');
  }
}

// === Tabs ===
function switchTab(tabName) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  ['main-tab', 'preorders-tab', 'tips-tab'].forEach(id => document.getElementById(id).classList.add('hidden'));
  if (tabName === 'main') {
    document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
    document.getElementById('main-tab').classList.remove('hidden');
    updateUI();
    setTimeout(updateMainFormFields, 50);
  } else if (tabName === 'preorders') {
    document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
    document.getElementById('preorders-tab').classList.remove('hidden');
    renderPreorders();
    setTimeout(updatePreorderFormFields, 50);
  } else if (tabName === 'tips') {
    document.querySelector('.tab-btn:nth-child(3)').classList.add('active');
    document.getElementById('tips-tab').classList.remove('hidden');
    updateTipsUI();
  }
}

// === –°–º–µ–Ω–∞ ===
function startShift() {
  const shift = getCurrentShift();
  if (shift && shift.active) {
    alert('–°–º–µ–Ω–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞!');
    return;
  }
  const newShift = { id: Date.now(), startedAt: new Date().toISOString(), active: true };
  setCurrentShift(newShift);
  alert('‚úÖ –°–º–µ–Ω–∞ –Ω–∞—á–∞—Ç–∞!');
  updateUI();
}
function endShift() {
  const shift = getCurrentShift();
  if (!shift || !shift.active) {
    alert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è!');
    return;
  }
  const orders = loadOrders();
  const finalAmount = orders
    .filter(o => o.shiftId === shift.id)
    .reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
  shift.active = false;
  shift.finishedAt = new Date().toISOString();
  shift.finalAmount = finalAmount;
  setCurrentShift(shift);
  alert(`‚úÖ –°–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ${finalAmount.toFixed(2)} ‚ÇΩ`);
  updateUI();
}

// === –£–¥–∞–ª–µ–Ω–∏–µ ===
function deleteOrder(orderId) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑?')) return;
  const orders = loadOrders();
  const idx = orders.findIndex(o => o.id === orderId);
  if (idx === -1) return;
  orders.splice(idx, 1);
  saveOrders(orders);
  const shift = getCurrentShift();
  if (shift && shift.active) updateUI();
  showOrdersByDate();
  alert('‚úÖ –ó–∞–∫–∞–∑ —É–¥–∞–ª—ë–Ω!');
}
function deletePreorder(preorderId) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–∑–∞–∫–∞–∑?')) return;
  const preorders = loadPreorders();
  const idx = preorders.findIndex(p => p.id === preorderId);
  if (idx === -1) return;
  preorders.splice(idx, 1);
  savePreorders(preorders);
  renderPreorders();
  alert('‚úÖ –ü—Ä–µ–¥–∑–∞–∫–∞–∑ —É–¥–∞–ª—ë–Ω!');
}

// === –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ ===
let pendingPreorderId = null;
function openDateModal(preorderId) {
  pendingPreorderId = preorderId;
  document.getElementById('modalDate').value = todayYMD();
  document.getElementById('dateModal').classList.add('active');
}
function closeDateModal() {
  document.getElementById('dateModal').classList.remove('active');
  pendingPreorderId = null;
}
function confirmDateSelection() {
  const date = document.getElementById('modalDate').value;
  if (!date) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É'); return; }
  if (pendingPreorderId !== null) acceptPreorder(pendingPreorderId, date);
  closeDateModal();
}
function viewOrderDetails(orderId) {
  const orders = loadOrders();
  const order = orders.find(o => o.id === orderId);
  if (!order) return;
  const units = calculateUnits(order.tariff, order.length, order.width, order.hours, order.qty);
  const tariffName = TARIFF_NAMES[order.tariff] || order.tariff;
  let html = '';
  html += `<div class="details-item"><span class="details-label">‚Ññ –∑–∞–∫–∞–∑–∞:</span><span class="details-value">${order.orderNumber}</span></div>`;
  html += `<div class="details-item"><span class="details-label">–î–µ—Ç–∞–ª—å:</span><span class="details-value">${order.detail}</span></div>`;
  html += `<div class="details-item"><span class="details-label">–¢–∞—Ä–∏—Ñ:</span><span class="details-value">${tariffName}</span></div>`;
  html += `<div class="details-item"><span class="details-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span><span class="details-value">${order.qty}</span></div>`;
  if (order.length !== null) html += `<div class="details-item"><span class="details-label">–î–ª–∏–Ω–∞:</span><span class="details-value">${order.length} –º</span></div>`;
  if (order.width !== null) html += `<div class="details-item"><span class="details-label">–®–∏—Ä–∏–Ω–∞:</span><span class="details-value">${order.width} –º</span></div>`;
  if (order.hours !== null) html += `<div class="details-item"><span class="details-label">–ß–∞—Å—ã:</span><span class="details-value">${order.hours} —á</span></div>`;
  html += `<div class="details-item"><span class="details-label">–û–±—ä–µ–º —Ä–∞–±–æ—Ç:</span><span class="details-value">${units.value} ${units.unit}</span></div>`;
  html += `<div class="details-item"><span class="details-label">–°—É–º–º–∞:</span><span class="details-value">${order.amount.toFixed(2)} ‚ÇΩ</span></div>`;
  document.getElementById('detailsContent').innerHTML = html;
  document.getElementById('detailsModal').classList.add('active');
}
function closeDetailsModal() {
  document.getElementById('detailsModal').classList.remove('active');
}
function openEditModal(orderId) {
  const orders = loadOrders();
  const order = orders.find(o => o.id === orderId);
  if (!order) return;
  editingOrder = order;
  document.getElementById('editOrderId').value = order.id;
  document.getElementById('editOrderNum').value = order.orderNumber;
  document.getElementById('editDetail').value = order.detail;
  document.getElementById('editTariff').value = order.tariff;
  document.getElementById('editQty').value = order.qty;
  document.getElementById('editLength').value = order.length || '';
  document.getElementById('editWidth').value = order.width || '';
  document.getElementById('editHours').value = order.hours || '';
  updateEditFormFields();
  document.getElementById('editModal').classList.add('active');
}
let editingOrder = null;
function closeEditModal() {
  document.getElementById('editModal').classList.remove('active');
  editingOrder = null;
}
function saveEditedOrder() {
  if (!editingOrder) return;
  const orderId = parseInt(document.getElementById('editOrderId').value);
  const num = document.getElementById('editOrderNum').value.trim();
  if (!num) { alert('–£–∫–∞–∂–∏—Ç–µ ‚Ññ –∑–∞–∫–∞–∑–∞'); return; }
  const tariffKey = document.getElementById('editTariff').value;
  const detail = document.getElementById('editDetail').value.trim() || '‚Äî';
  const qty = parseInt(document.getElementById('editQty').value) || 1;
  const length = parseFloat(document.getElementById('editLength').value) || 0;
  const width = parseFloat(document.getElementById('editWidth').value) || 0;
  const hours = parseFloat(document.getElementById('editHours').value) || 0;
  const amount = calculateAmount(tariffKey, length, width, hours, qty);
  const orders = loadOrders();
  const idx = orders.findIndex(o => o.id === orderId);
  if (idx !== -1) {
    orders[idx] = {
      ...orders[idx],
      orderNumber: num,
      tariff: tariffKey,
      detail: detail,
      qty: qty,
      length: length || null,
      width: width || null,
      hours: hours || null,
      amount: amount
    };
    saveOrders(orders);
    updateUI();
    showOrdersByDate();
    closeEditModal();
    alert('‚úÖ –ó–∞–∫–∞–∑ –æ–±–Ω–æ–≤–ª—ë–Ω!');
  }
}

// === –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
function createMainOrder() {
  const num = document.getElementById('orderNum').value.trim();
  if (!num) { alert('–£–∫–∞–∂–∏—Ç–µ ‚Ññ –∑–∞–∫–∞–∑–∞'); return; }
  const tariffKey = document.getElementById('tariff').value;
  const detail = document.getElementById('detail').value.trim() || '‚Äî';
  const qty = parseInt(document.getElementById('qty').value) || 1;
  const length = parseFloat(document.getElementById('length').value) || 0;
  const width = parseFloat(document.getElementById('width').value) || 0;
  const hours = parseFloat(document.getElementById('hours').value) || 0;
  const amount = calculateAmount(tariffKey, length, width, hours, qty);
  const shift = getCurrentShift();
  if (!shift || !shift.active) {
    alert('‚ö†Ô∏è –ù–∞—á–Ω–∏—Ç–µ —Å–º–µ–Ω—É, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã!');
    return;
  }
  const order = {
    id: Date.now(),
    orderNumber: num,
    tariff: tariffKey,
    detail: detail,
    qty: qty,
    length: length || null,
    width: width || null,
    hours: hours || null,
    amount: amount,
    date: todayYMD(),
    shiftId: shift.id,
    timestamp: new Date().toISOString()
  };
  const orders = loadOrders();
  orders.push(order);
  saveOrders(orders);
  updateUI();
  ['orderNum','detail','qty','length','width','hours'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = (id === 'qty') ? '1' : '';
  });
  updateMainFormFields();
}
function createPreorder() {
  const num = document.getElementById('preOrderNum').value.trim();
  if (!num) { alert('–£–∫–∞–∂–∏—Ç–µ ‚Ññ –ø—Ä–µ–¥–∑–∞–∫–∞–∑–∞'); return; }
  const tariffKey = document.getElementById('preTariff').value;
  const detail = document.getElementById('preDetail').value.trim() || '‚Äî';
  const qty = parseInt(document.getElementById('preQty').value) || 1;
  const length = parseFloat(document.getElementById('preLength').value) || 0;
  const width = parseFloat(document.getElementById('preWidth').value) || 0;
  const hours = parseFloat(document.getElementById('preHours').value) || 0;
  const amount = calculateAmount(tariffKey, length, width, hours, qty);
  const preorder = {
    id: Date.now(),
    orderNumber: num,
    tariff: tariffKey,
    detail: detail,
    qty: qty,
    length: length || null,
    width: width || null,
    hours: hours || null,
    amount: amount,
    date: todayYMD(),
    timestamp: new Date().toISOString()
  };
  const preorders = loadPreorders();
  preorders.push(preorder);
  savePreorders(preorders);
  alert('‚úÖ –ü—Ä–µ–¥–∑–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
  renderPreorders();
  ['preOrderNum','preDetail','preQty','preLength','preWidth','preHours'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = (id === 'preQty') ? '1' : '';
  });
  updatePreorderFormFields();
}
function acceptPreorder(preorderId, selectedDate = null) {
  const preorders = loadPreorders();
  const idx = preorders.findIndex(p => p.id === preorderId);
  if (idx === -1) return;
  const preorder = preorders[idx];
  const shift = getCurrentShift();
  if (!shift || !shift.active) {
    alert('–ù–∞—á–Ω–∏—Ç–µ —Å–º–µ–Ω—É, —á—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å –ø—Ä–µ–¥–∑–∞–∫–∞–∑!');
    return;
  }
  if (!selectedDate) {
    openDateModal(preorderId);
    return;
  }
  const order = {...preorder, shiftId: shift.id, date: selectedDate};
  const orders = loadOrders();
  orders.push(order);
  saveOrders(orders);
  preorders.splice(idx, 1);
  savePreorders(preorders);
  alert(`‚úÖ –ü—Ä–µ–¥–∑–∞–∫–∞–∑ "${preorder.orderNumber}" –ø—Ä–∏–Ω—è—Ç –Ω–∞ –¥–∞—Ç—É ${formatDateYMD(selectedDate)}!`);
  updateUI();
  renderPreorders();
}
function renderPreorders() {
  const preorders = loadPreorders();
  const container = document.getElementById('preordersList');
  if (preorders.length === 0) {
    container.innerHTML = '<div class="empty-msg">–ù–µ—Ç –ø—Ä–µ–¥–∑–∞–∫–∞–∑–æ–≤</div>';
    return;
  }
  let html = `<table><thead><tr><th>‚Ññ</th><th>–î–µ—Ç–∞–ª—å</th><th>–°—É–º–º–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>`;
  preorders.forEach(p => {
    html += `
<tr>
<td>${p.orderNumber}</td>
<td>${p.detail}</td>
<td class="amount">${p.amount.toFixed(2)} ‚ÇΩ</td>
<td>
<button class="btn-action" onclick="acceptPreorder(${p.id})"><i class="fas fa-check"></i></button>
<button class="btn-action" onclick="deletePreorder(${p.id})"><i class="fas fa-trash"></i></button>
</td>
</tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}
function showOrdersByDate() {
  const dateInput = document.getElementById('viewDate').value;
  if (!dateInput) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É'); return; }
  const orders = loadOrders();
  const filtered = orders.filter(o => o.date === dateInput);
  const formattedDate = formatDateYMD(dateInput);
  let html = `<div class="date-label">–ó–∞–∫–∞–∑—ã –∑–∞ ${formattedDate}</div>`;
  if (filtered.length === 0) {
    html += '<div class="empty-msg">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –∑–∞ —ç—Ç—É –¥–∞—Ç—É</div>';
  } else {
    html += `<table><thead><tr><th>‚Ññ</th><th>–î–µ—Ç–∞–ª—å</th><th>–°—É–º–º–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>`;
    filtered.forEach(o => {
      html += `
<tr>
<td>${o.orderNumber}</td>
<td>${o.detail}</td>
<td class="amount">${o.amount.toFixed(2)} ‚ÇΩ</td>
<td>
<button class="btn-action" onclick="viewOrderDetails(${o.id})"><i class="fas fa-eye"></i></button>
<button class="btn-action" onclick="openEditModal(${o.id})"><i class="fas fa-edit"></i></button>
<button class="btn-action" onclick="deleteOrder(${o.id})"><i class="fas fa-trash"></i></button>
</td>
</tr>`;
    });
    html += '</tbody></table>';
  }
  document.getElementById('ordersList').innerHTML = html;
}
function saveOrdersToFile() {
  const dateInput = document.getElementById('viewDate').value;
  if (!dateInput) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É'); return; }
  const orders = loadOrders();
  const filtered = orders.filter(o => o.date === dateInput);
  if (filtered.length === 0) { alert('–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –∑–∞ —ç—Ç—É –¥–∞—Ç—É'); return; }
  const formattedDate = formatDateYMD(dateInput);
  let content = `–ó–ê–ö–ê–ó–´ –ó–ê ${formattedDate}\n========================\n`;
  let totalSum = 0;
  filtered.forEach((o, idx) => {
    const tariffName = TARIFF_NAMES[o.tariff] || o.tariff;
    const units = calculateUnits(o.tariff, o.length, o.width, o.hours, o.qty);
    content += `‚Ññ${idx + 1}. ${o.orderNumber}\n   ${o.detail} (${tariffName})\n`;
    if (o.length) content += `   –î–ª–∏–Ω–∞: ${o.length} –º\n`;
    if (o.width) content += `   –®–∏—Ä–∏–Ω–∞: ${o.width} –º\n`;
    if (o.hours) content += `   –ß–∞—Å—ã: ${o.hours} —á\n`;
    content += `   –ö–æ–ª-–≤–æ: ${o.qty}\n   –û–±—ä–µ–º: ${units.value} ${units.unit}\n   –°—É–º–º–∞: ${o.amount.toFixed(2)} ‚ÇΩ\n---\n`;
    totalSum += o.amount;
  });
  content += `\n–ò–¢–û–ì–û: ${totalSum.toFixed(2)} ‚ÇΩ\n–≠–∫—Å–ø–æ—Ä—Ç: ${new Date().toLocaleString('ru-RU')}`;
  const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
  const blob = new Blob([bom, content], { type: 'text/plain;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `–∑–∞–∫–∞–∑—ã_${formattedDate}.txt`;
  a.click();
  URL.revokeObjectURL(a.href);
}
function saveOrdersToJSON() {
  const dateInput = document.getElementById('viewDate').value;
  if (!dateInput) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É'); return; }
  const orders = loadOrders();
  const filtered = orders.filter(o => o.date === dateInput);
  if (filtered.length === 0) { alert('–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –∑–∞ —ç—Ç—É –¥–∞—Ç—É'); return; }
  const jsonContent = JSON.stringify(filtered, null, 2);
  const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `–∑–∞–∫–∞–∑—ã_${formatDateYMD(dateInput)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}
function calculateUnits(tariffKey, length, width, hours, qty) {
  const tariff = TARIFFS[tariffKey];
  if (!tariff) return { value: 0, unit: '' };
  let value = 0;
  let unit = tariff.unit;
  if (tariff.unit === 'time') value = hours * qty;
  else if (tariff.unit === 'm2') value = length * width * qty;
  else value = length * qty;
  return { value: Math.round(value * 100) / 100, unit: UNIT_LABELS[unit] || unit };
}

// === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('viewDate').value = todayYMD();
  ['tariff','preTariff','editTariff'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', () => {
      if (id === 'tariff') updateMainFormFields();
      else if (id === 'preTariff') updatePreorderFormFields();
      else updateEditFormFields();
    });
  });
  updateUI();
  renderPreorders();
});
</script>
</body>
</html>
